<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>初探linux网络协议栈 - dgwu - A super concise theme for Hugo</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="dgwu" />
  <meta name="description" content="摘要 linux网络是 网络常识概述 OSI模型 OSI模型（Open Systems Interconnection model）是一种用于计算机网络体系结构的理论模型，由国际标准化组织（IS" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.109.0" />


<link rel="canonical" href="https://Breeze-Wu.github.io/post/%E5%88%9D%E6%8E%A2linux%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.de22abc00de44766eebd1054fd9e0b254b071f89d5019044f893c484a9249a8d.css" integrity="sha256-3iKrwA3kR2buvRBU/Z4LJUsHH4nVAZBE&#43;JPEhKkkmo0=" media="screen" crossorigin="anonymous">







<meta property="og:title" content="初探linux网络协议栈" />
<meta property="og:description" content="摘要 linux网络是 网络常识概述 OSI模型 OSI模型（Open Systems Interconnection model）是一种用于计算机网络体系结构的理论模型，由国际标准化组织（IS" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Breeze-Wu.github.io/post/%E5%88%9D%E6%8E%A2linux%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-07-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-09T00:00:00+00:00" />
<meta itemprop="name" content="初探linux网络协议栈">
<meta itemprop="description" content="摘要 linux网络是 网络常识概述 OSI模型 OSI模型（Open Systems Interconnection model）是一种用于计算机网络体系结构的理论模型，由国际标准化组织（IS"><meta itemprop="datePublished" content="2022-07-09T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-07-09T00:00:00+00:00" />
<meta itemprop="wordCount" content="28463">
<meta itemprop="keywords" content="linux,TCP/IP," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="初探linux网络协议栈"/>
<meta name="twitter:description" content="摘要 linux网络是 网络常识概述 OSI模型 OSI模型（Open Systems Interconnection model）是一种用于计算机网络体系结构的理论模型，由国际标准化组织（IS"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">dgwu</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      dgwu
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">初探linux网络协议栈</h1>
      

      <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          dgwu
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2022-07-09">
      2022-07-09
    </time>
  </div>

  


  <div class="post-meta__right">
    

    


    
    


    
    
  </div>
</div>

    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#osi模型">OSI模型</a></li>
    <li><a href="#网络地址">网络地址</a></li>
    <li><a href="#一次web访问的经过">一次web访问的经过</a></li>
  </ul>

  <ul>
    <li><a href="#创建socket">创建socket</a></li>
    <li><a href="#地址绑定">地址绑定</a></li>
    <li><a href="#socket侦听">socket侦听</a></li>
    <li><a href="#accept建立连接">accept建立连接</a></li>
    <li><a href="#connect建立连接">connect建立连接</a></li>
    <li><a href="#什么是路由">什么是路由?</a></li>
    <li><a href="#数据接收">数据接收</a></li>
    <li><a href="#数据发送">数据发送</a></li>
    <li><a href="#邻居子系统">邻居子系统</a>
      <ul>
        <li><a href="#初始化">初始化</a></li>
        <li><a href="#邻居探测">邻居探测</a></li>
        <li><a href="#接收处理">接收处理</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#作用">作用</a></li>
        <li><a href="#netfilter-初始化">netfilter 初始化</a></li>
        <li><a href="#hook点">HOOK点</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#netllink是什么">netllink是什么？</a></li>
    <li><a href="#初始化-1">初始化</a></li>
    <li><a href="#创建">创建</a></li>
    <li><a href="#绑定">绑定</a></li>
    <li><a href="#发送消息">发送消息</a></li>
    <li><a href="#接收消息">接收消息</a></li>
  </ul>

  <ul>
    <li><a href="#select">select</a></li>
    <li><a href="#epoll">epoll</a></li>
  </ul>

  <ul>
    <li><a href="#作用-1">作用</a></li>
    <li><a href="#初始化-2">初始化</a></li>
    <li><a href="#发送">发送</a></li>
    <li><a href="#接收">接收</a></li>
  </ul>

  <ul>
    <li><a href="#作用-2">作用</a></li>
    <li><a href="#初始化-3">初始化</a></li>
    <li><a href="#发送-1">发送</a></li>
    <li><a href="#接收-1">接收</a></li>
  </ul>
</nav>
  </div>
</div>


    
    <div class="post-content">
      <h1 id="摘要">摘要</h1>
<p>linux网络是</p>
<h1 id="网络常识概述">网络常识概述</h1>
<h2 id="osi模型">OSI模型</h2>
<p>OSI模型（Open Systems Interconnection model）是一种用于计算机网络体系结构的理论模型，由国际标准化组织（ISO）制定。该模型将计算机网络通信划分为一系列不同的抽象层，每一层都负责特定的功能，从物理连接到应用程序。</p>
<p>OSI模型的七个层次（从底层到顶层）及其主要功能如下：</p>
<p><strong>物理层(Physical Layer)：</strong> 这是网络的最底层，负责在物理媒介上传输原始的比特流。它定义了电气、光学、机械等物理特性，如电压、频率、传输介质等。</p>
<p><strong>数据链路层(Data Link Layer)：</strong> 数据链路层负责在物理层上建立可靠的数据连接，通过帧来传输数据。它处理数据包的起始和结束标志、差错检测和纠正、流控制等。常用协议如ARP</p>
<p><strong>网络层(Network Layer)：</strong> 网络层负责在不同网络之间进行数据包的路由和转发。它使用逻辑地址（如IP地址）来标识网络中的设备，并管理数据包的传递路径。常用协议如IP、ICMP</p>
<p><strong>传输层(Transport Layer)：</strong> 传输层提供端到端的通信服务，确保数据的可靠传输。它负责分段、流量控制、差错检测和纠正，并为应用层提供数据传输的抽象。常用协议如TCP、UDP</p>
<p><strong>会话层(Session Layer)：</strong> 会话层管理不同设备之间的会话，确保数据在不同设备之间的通信和同步。它处理会话的建立、维护和结束，提供数据同步和错误恢复。</p>
<p><strong>表示层(Presentation Layer)：</strong> 表示层负责数据的格式转换、加密和压缩，以确保不同设备之间的数据可以正确解释和解码。</p>
<p><strong>应用层（Application Layer)：</strong> 应用层是最顶层，提供了网络服务的接口，使用户和应用程序能够通过网络进行通信。它包括各种应用层协议，如HTTP、FTP、SMTP、DHCP等。</p>
<p>OSI模型的主要优点是它提供了一种分层的方法来描述网络协议和功能，使不同层之间的关系和功能更加清晰。然而，在实际的网络协议栈中，TCP/IP协议栈更为广泛使用，它是一种实际应用的协议栈，不完全符合OSI模型。</p>
<h2 id="网络地址">网络地址</h2>
<p>最初设计互联网络时，为了便于寻址以及层次化构造网络，每个IP地址由四字节组成包含两个标识码（ID），即网络ID和主机ID。同一个物理网络上的所有主机都使用同一个网络ID，网络上的一个主机（包括网络上工作站，服务器和路由器等）都有唯一个主机ID与其对应。IP地址根据网络ID的不同分为5种 类型，A类地址、B类地址、C类地址、D类地址和E类地址。</p>
<p>**A类地址：**网络ID占1字节且最高位只能为0，主机ID占3字节，IP地址范围0.0.0.0~127.255.255.255。通常A类地址用于大型网络中，可以有众多主机共存。</p>
<p>**B类地址：**网络ID占2字节且最高两位只能为1 0，主机ID占2字节，IP地址范围128.0.0.0~191.255.255.255。B类网络有16382个，每个网络能容纳6万多个主机。</p>
<p>**C类地址：**网络ID占3字节且最高两位只能为1 1 0，主机ID占1字节，IP地址范围192.0.0.0~223.255.255.255。c类网络可达209万余个，每个网络能容纳254个主机</p>
<p>**D类地址：**网络ID占4字节且最高两位只能为1 1 1 0，IP地址范围224.0.0.0~239.255.255.255。D类用于多点广播</p>
<p>**E类地址：**网络ID占4字节且最高两位只能为1 1 1 1，IP地址范围240.0.0.0~255.255.255.254，保留使用，255.255.255.255用于广播地址</p>
<p><img src="/image/tcp_ip/networkaddr.png" alt="网络地址"></p>
<h2 id="一次web访问的经过">一次web访问的经过</h2>
<p><strong>DNS解析：</strong> 用户在浏览器中输入网址（URL），浏览器首先需要将域名解析成对应的IP地址，以便确定要访问的服务器。浏览器会向本地DNS服务器发起查询，如果本地DNS服务器没有缓存该域名的IP地址，就会向上级DNS服务器继续查询，直到找到对应的IP地址。</p>
<p><strong>建立TCP连接：</strong> 一旦浏览器获得了服务器的IP地址，它会与服务器建立TCP连接。TCP是一种可靠的传输协议，它确保数据包的有序传递和可靠交付。</p>
<p><strong>发起HTTP请求：</strong> 通过建立的TCP连接，浏览器向服务器发送HTTP请求，请求特定的资源（如网页、图像等）。请求中包括HTTP方法（GET、POST等）、请求头（包含用户代理、支持的压缩算法等）和请求体（POST请求可能包含表单数据等）。</p>
<p><strong>服务器处理请求：</strong> 服务器接收到浏览器发送的HTTP请求后，根据请求的内容和URL进行处理。服务器可能需要从数据库中检索数据、处理业务逻辑，并生成响应数据。</p>
<p><strong>返回HTTP响应：</strong> 服务器生成HTTP响应，包括响应状态码、响应头（包含内容类型、缓存控制等）和响应体（包含实际的数据）。响应被发送回浏览器，通过之前建立的TCP连接传输。</p>
<p><strong>浏览器渲染页面：</strong> 浏览器接收到HTTP响应后，会解析响应数据，根据HTML、CSS和JavaScript等内容渲染页面。浏览器将页面呈现给用户，显示文本、图像、交互元素等。</p>
<p><strong>资源加载：</strong> 页面渲染时，浏览器会根据HTML中的链接和标签加载其他资源，如CSS、JavaScript文件、图像等。这些资源会通过HTTP请求从服务器获取。</p>
<p><strong>页面交互：</strong> 如果页面中包含交互元素（如表单、按钮），用户可以与页面进行交互。交互可能会引发更多的HTTP请求和响应，从而更新页面内容或执行其他操作。</p>
<p><strong>连接关闭：</strong> 一旦页面渲染完毕，浏览器可能会继续保持与服务器的TCP连接一段时间，以便后续的请求。然后，连接会被关闭或保持在一种保活状态。</p>
<p>这是一次Web访问的基本技术路线，涉及了域名解析、TCP连接、HTTP请求和响应、服务器处理和页面渲染等多个环节。这些步骤共同构成了用户在浏览器中访问网页的过程。</p>
<h1 id="tcpip协议栈实现">TCP/IP协议栈实现</h1>
<h2 id="创建socket">创建socket</h2>
<p>socket由glibc库函数实现 ，位于socket.S中，定义如下</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-41">41</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// glibc-2.2.5/sysdeps/unix/sysdep.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_ify(syscall_name) SYS_##syscall_name
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// glibc-2.2.5/sysdeps/unix/sysv/linux/socketcall.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SOCKOP_socket		1 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// glibc-2.2.5/sysdeps/unix/sysv/linux/arm/socket.S
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define P(a, b) P2(a, b)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define P2(a, b) a##b
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">/* 将参数压入堆栈 */</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define PUSHARGS_3	stmfd sp!, {a1, a2, a3}
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define POPARGS_3	add sp, sp, #12
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifndef NARGS
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define NARGS 3			</span><span style="color:#8b949e;font-style:italic">/* If we were called with no wrapper, this is really socket() */</span><span style="color:#8b949e;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">ENTRY</span> (__socket)
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Push args onto the stack.  */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">P</span>(PUSHARGS_,NARGS)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic">/* Do the system call trap.  */</span>
</span></span><span style="display:flex;"><span>	mov a1, <span style="color:#f85149">$</span><span style="color:#d2a8ff;font-weight:bold">P</span>(SOCKOP_,socket)
</span></span><span style="display:flex;"><span>	mov a2, sp
</span></span><span style="display:flex;"><span>	<span style="color:#f85149">触发系统调用中断</span>
</span></span><span style="display:flex;"><span>	swi <span style="color:#d2a8ff;font-weight:bold">SYS_ify</span>(socketcall)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Pop args off the stack */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">P</span>(POPARGS_,NARGS)
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">//r0的值为系统调用的返回值，返回值大于等于124表示发生错误，124只是一个阈值，不同版本可能不同
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	cmn r0, <span style="color:#f85149">$</span><span style="color:#a5d6ff">124</span>
</span></span><span style="display:flex;"><span>	bhs <span style="color:#d2a8ff;font-weight:bold">PLTJMP</span>(syscall_error)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">PSEUDO_END</span> (__socket)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">/* 给__socket取别名为socket */</span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">weak_alias</span> (__socket, socket)
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面代码将socket输入的三个参数都压入到堆栈中，在ENTRY (__socket)中，使用汇编命令，分别将socket的调用号与堆栈指针赋值给a1与a2寄存器，接着调用swi命令并传入sys_socketcall的系统调用号，触发系统中断，中断完成后出栈，并返回r0寄存器中的内容。r0的值为系统调用的返回值，返回值大于等于124表示发生错误，124只是一个阈值，不同版本可能不同。</p>
<p>sys_socketcall函数在linux系统中使用SYSCALL_DEFINE2定义，其中2表示有两个入参。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-38">38</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/include/linux/net.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_SOCKET	1
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_BIND	2
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_CONNECT	3
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_LISTEN	4
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_ACCEPT	5
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_GETSOCKNAME	6
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_GETPEERNAME	7
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_SOCKETPAIR	8
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_SEND	9
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define SYS_RECV	10
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/socket.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#d2a8ff;font-weight:bold">SYSCALL_DEFINE2</span>(socketcall, <span style="color:#ff7b72">int</span>, call, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>, args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* copy_from_user should be SMP safe. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">copy_from_user</span>(a, args, len))
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>EFAULT;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">switch</span> (call) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SYS_SOCKET</span>:
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sys_socket</span>(a0, a1, a[<span style="color:#a5d6ff">2</span>]);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SYS_BIND</span>:
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sys_bind</span>(a0, (<span style="color:#ff7b72">struct</span> sockaddr __user <span style="color:#ff7b72;font-weight:bold">*</span>)a1, a[<span style="color:#a5d6ff">2</span>]);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SYS_CONNECT</span>:
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sys_connect</span>(a0, (<span style="color:#ff7b72">struct</span> sockaddr __user <span style="color:#ff7b72;font-weight:bold">*</span>)a1, a[<span style="color:#a5d6ff">2</span>]);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SYS_LISTEN</span>:
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sys_listen</span>(a0, a1);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SYS_ACCEPT</span>:
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sys_accept4</span>(a0, (<span style="color:#ff7b72">struct</span> sockaddr __user <span style="color:#ff7b72;font-weight:bold">*</span>)a1,
</span></span><span style="display:flex;"><span>				  (<span style="color:#ff7b72">int</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>)a[<span style="color:#a5d6ff">2</span>], <span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>从代码可以看到sys_socketcall是所有socket调用的入口函数，通过switch分支判断，分别执行不用的socket调用。在glibc中，socket()调用传入的SOCKOP_socket，其值与SYS_SOCKET相同，switch分支调用sys_socket。在switch语句前面，我们看到内核通过调用copy_from_user()，将参数从用户侧复制到内核侧。其本质是将内核侧的虚拟地址指向的参数的物理地址。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SYSCALL_DEFINE3(socket, int, family, int, type, int, protocol)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	/* 创建socket、sock、inet_sock等结构并初始化 */
</span></span><span style="display:flex;"><span>	retval = sock_create(family, type, protocol, &amp;sock);
</span></span><span style="display:flex;"><span>	if (retval &lt; 0)
</span></span><span style="display:flex;"><span>		goto out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* 在socket文件系统下创建socket文件，并将文件private_date指向socket结构量 最后返回文件句柄fd*/
</span></span><span style="display:flex;"><span>	retval = sock_map_fd(sock, flags &amp; (O_CLOEXEC | O_NONBLOCK));
</span></span><span style="display:flex;"><span>	if (retval &lt; 0)
</span></span><span style="display:flex;"><span>		goto out_release;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>socket接收三个参数。</p>
<p><strong>family：</strong> 表示地址族。有一下几种定义，最经常使用AF_INET。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define AF_UNIX		1	</span><span style="color:#8b949e;font-style:italic">/* Unix domain sockets 		*/</span><span style="color:#8b949e;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define AF_LOCAL	1	</span><span style="color:#8b949e;font-style:italic">/* POSIX name for AF_UNIX	*/</span><span style="color:#8b949e;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define AF_INET		2	</span><span style="color:#8b949e;font-style:italic">/* Internet IP Protocol 	*/</span><span style="color:#8b949e;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define AF_INET6	10	</span><span style="color:#8b949e;font-style:italic">/* IP version 6			*/</span><span style="color:#8b949e;font-weight:bold;font-style:italic">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>type：</strong>  表示sokcet通信的语义，通常由一下几种:</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/include/linux/net.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">enum</span> sock_type {
</span></span><span style="display:flex;"><span>	SOCK_STREAM	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>,
</span></span><span style="display:flex;"><span>	SOCK_DGRAM	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">2</span>,
</span></span><span style="display:flex;"><span>	SOCK_RAW	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">3</span>,
</span></span><span style="display:flex;"><span>	SOCK_RDM	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">4</span>,
</span></span><span style="display:flex;"><span>	SOCK_SEQPACKET	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">5</span>,
</span></span><span style="display:flex;"><span>	SOCK_DCCP	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">6</span>,
</span></span><span style="display:flex;"><span>	SOCK_PACKET	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">10</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>protocol：</strong> 表示socket通信的协议，这里只列举几种常用的协议：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-6">6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-7">7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">enum</span> {
</span></span><span style="display:flex;"><span>  IPPROTO_IP <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>,		<span style="color:#8b949e;font-style:italic">/* Dummy protocol for TCP		*/</span>
</span></span><span style="display:flex;"><span>  IPPROTO_ICMP <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>,
</span></span><span style="display:flex;"><span>  IPPROTO_TCP <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">6</span>,
</span></span><span style="display:flex;"><span>  IPPROTO_UDP <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">17</span>,
</span></span><span style="display:flex;"><span>  IPPROTO_IPV6	 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">41</span>,
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>sys_socket中的主要函数调用路线</strong></p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-6">6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-7">7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-8">8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-9">9</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SYSCALL_DEFINE3(socket, int, family, int, type, int, protocol)
</span></span><span style="display:flex;"><span>		sock_create
</span></span><span style="display:flex;"><span>				sock_alloc		//创建socket结构
</span></span><span style="display:flex;"><span>				net_families[family]-&gt;create	//net_families在inet_init中初始化
</span></span><span style="display:flex;"><span>						sk_alloc		//创建sock结构
</span></span><span style="display:flex;"><span>						sock_init_data
</span></span><span style="display:flex;"><span>						sk-&gt;sk_prot-&gt;init(sk)  //初始化tcp_sock与inet_connection_sock结构
</span></span><span style="display:flex;"><span>		sock_map_fd
</span></span><span style="display:flex;"><span>				sock_alloc_file  //创建socket文件
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面只列举了sys_socket的主要调用接口，就不带大家看源码了。其实socket()主要作用是初始化相关数据结构，其他socket函数负责修改这些数据结构。所以我总结了一张socket()调用初始化的数据结构图。
<img src="/image/tcp_ip/Vyjuh9UUvGcdWd33.png" alt="输入图片说明"></p>
<h2 id="地址绑定">地址绑定</h2>
<p>bind()实现也是在glibc中调用swi触发系统调用中断，进入sys_socketcall()，调用sys_bind.</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/socket.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#d2a8ff;font-weight:bold">SYSCALL_DEFINE3</span>(bind, <span style="color:#ff7b72">int</span>, fd, <span style="color:#ff7b72">struct</span> sockaddr __user <span style="color:#ff7b72;font-weight:bold">*</span>, umyaddr, <span style="color:#ff7b72">int</span>, addrlen)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 根据fd从当前进程的current-&gt;files[fd]取出file文件结构 并从file的private_date取出socket */</span>
</span></span><span style="display:flex;"><span>	sock <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sockfd_lookup_light</span>(fd, <span style="color:#ff7b72;font-weight:bold">&amp;</span>err, <span style="color:#ff7b72;font-weight:bold">&amp;</span>fput_needed);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (sock) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 把addr结构从用户侧拷贝到内核侧 */</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">move_addr_to_kernel</span>(umyaddr, addrlen, (<span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>)<span style="color:#ff7b72;font-weight:bold">&amp;</span>address);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">&gt;=</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>				...
</span></span><span style="display:flex;"><span>				<span style="color:#8b949e;font-style:italic">/* 调用inetsw_arry中ops结构绑定的bind函数 */</span>
</span></span><span style="display:flex;"><span>				err <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">bind</span>(sock,
</span></span><span style="display:flex;"><span>						      (<span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>)
</span></span><span style="display:flex;"><span>						      <span style="color:#ff7b72;font-weight:bold">&amp;</span>address, addrlen);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>sockfd_lookup_light接口根据fd从当前进程的current-&gt;files[fd]取出file文件结构 并从file的private_date取出socket。move_addr_to_kernel接口最终通过copy_from_user函数将addr地址从用户侧转到内核侧</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-43">43</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/ipv4/af_inet.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">inet_bind</span>(<span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock, <span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>uaddr, <span style="color:#ff7b72">int</span> addr_len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sockaddr_in <span style="color:#ff7b72;font-weight:bold">*</span>addr <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">struct</span> sockaddr_in <span style="color:#ff7b72;font-weight:bold">*</span>)uaddr;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> inet_sock <span style="color:#ff7b72;font-weight:bold">*</span>inet <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">short</span> snum;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> chk_addr_ret;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 使用inetsw数组中的prot结构挂载的钩子函数 这里tcp_prot没有bind函数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span>bind) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">bind</span>(sk, uaddr, addr_len);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 校验addr并查找路由表 */</span>
</span></span><span style="display:flex;"><span>	chk_addr_ret <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_addr_type</span>(<span style="color:#d2a8ff;font-weight:bold">sock_net</span>(sk), addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sin_addr.s_addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 将源地址存到inet_sock.inet_rcv_saddr*/</span>
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_rcv_saddr <span style="color:#ff7b72;font-weight:bold">=</span> inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr <span style="color:#ff7b72;font-weight:bold">=</span> addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sin_addr.s_addr;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (chk_addr_ret <span style="color:#ff7b72;font-weight:bold">==</span> RTN_MULTICAST <span style="color:#ff7b72;font-weight:bold">||</span> chk_addr_ret <span style="color:#ff7b72;font-weight:bold">==</span> RTN_BROADCAST)
</span></span><span style="display:flex;"><span>		inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;  <span style="color:#8b949e;font-style:italic">/* Use device */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 调用inetsw_arry. tcp_prot.get_port*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">get_port</span>(sk, snum)) {
</span></span><span style="display:flex;"><span>		inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr <span style="color:#ff7b72;font-weight:bold">=</span> inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_rcv_saddr <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EADDRINUSE;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out_release_sock;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 源地址与端口都绑定到inet_sock结构中 */</span>
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_sport <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">htons</span>(inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_num);
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_daddr <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_dport <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sk_dst_reset</span>(sk);
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out_release_sock</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">release_sock</span>(sk);
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> err;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在inet_addr_type中分别检查addr是否是零地址(0x00000000)、广播地址(0xffffffff)、组播地址，并调用fib_get_table接口获取net结构中本地路由表，接着调用fib_table_lookup查询addr相关路由。</p>
<p>tcp_prot结构的get_port指向inet_csk_get_port接口，负责从tcp_hashinfo哈希桶中找出port端口对应的inet_bind_bucket结构，没有就创建一个，最后调用inet_bind_hash，将inet_bind_bucket结构量存放到inet_connetc_sock.icsk_bind_hash中。程序最后，会设置 struct inet_sock 的本方的地址 inet_saddr 和本方的端口 inet_sport，对方的地址 inet_daddr 和对方的端口 inet_dport 都初始化为 0。</p>
<p><strong>sys_bind主要调用路线</strong></p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SYSCALL_DEFINE3(bind, int, fd, struct sockaddr __user *, umyaddr, int, addrlen)
</span></span><span style="display:flex;"><span>		sockfd_lookup_light
</span></span><span style="display:flex;"><span>				fget_light
</span></span><span style="display:flex;"><span>		move_addr_to_kernel
</span></span><span style="display:flex;"><span>				copy_from_user
</span></span><span style="display:flex;"><span>		inet_bind
</span></span><span style="display:flex;"><span>				inet_addr_type
</span></span><span style="display:flex;"><span>						fib_get_table
</span></span><span style="display:flex;"><span>						fib_table_lookup
</span></span><span style="display:flex;"><span>				inet_csk_get_port
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="socket侦听">socket侦听</h2>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-36">36</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">SYSCALL_DEFINE2</span>(listen, <span style="color:#ff7b72">int</span>, fd, <span style="color:#ff7b72">int</span>, backlog)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err, fput_needed;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> somaxconn;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sock <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sockfd_lookup_light</span>(fd, <span style="color:#ff7b72;font-weight:bold">&amp;</span>err, <span style="color:#ff7b72;font-weight:bold">&amp;</span>fput_needed);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (sock) {
</span></span><span style="display:flex;"><span>		somaxconn <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_net</span>(sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>core.sysctl_somaxconn;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> ((<span style="color:#ff7b72">unsigned</span>)backlog <span style="color:#ff7b72;font-weight:bold">&gt;</span> somaxconn)
</span></span><span style="display:flex;"><span>			backlog <span style="color:#ff7b72;font-weight:bold">=</span> somaxconn;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">security_socket_listen</span>(sock, backlog);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>err)
</span></span><span style="display:flex;"><span>			err <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">listen</span>(sock, backlog);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">fput_light</span>(sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>file, fput_needed);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> err;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">inet_listen</span>(<span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock, <span style="color:#ff7b72">int</span> backlog)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">char</span> old_state;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">lock_sock</span>(sk);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (old_state <span style="color:#ff7b72;font-weight:bold">!=</span> TCP_LISTEN) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_csk_listen_start</span>(sk, backlog);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>sys_listen()调用inet_listen()，如果这个 socket 还不在 TCP_LISTEN 状态，会调用 inet_csk_listen_start 进入监听状态。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-21">21</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">inet_csk_listen_start</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">int</span> nr_table_entries)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> inet_sock <span style="color:#ff7b72;font-weight:bold">*</span>inet <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> inet_connection_sock <span style="color:#ff7b72;font-weight:bold">*</span>icsk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_csk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> rc <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">reqsk_queue_alloc</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>icsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_accept_queue, nr_table_entries);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_max_ack_backlog <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_ack_backlog <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">inet_csk_delack_init</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state <span style="color:#ff7b72;font-weight:bold">=</span> TCP_LISTEN;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">get_port</span>(sk, inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_num)) {
</span></span><span style="display:flex;"><span>		inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_sport <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">htons</span>(inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_num);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">sk_dst_reset</span>(sk);
</span></span><span style="display:flex;"><span>		sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">hash</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数首先在inet_connection_sock上申请icsk_accept_queue的空间结构，接着改变socket状态为TCP_LISTEN，最后将sock结构存放到tcp_hashinfo的listening_hash表中。</p>
<h2 id="accept建立连接">accept建立连接</h2>
<p>接下来看accept()调用实现</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-33">33</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">SYSCALL_DEFINE4</span>(accept4, <span style="color:#ff7b72">int</span>, fd, <span style="color:#ff7b72">struct</span> sockaddr __user <span style="color:#ff7b72;font-weight:bold">*</span>, upeer_sockaddr,
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">int</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>, upeer_addrlen, <span style="color:#ff7b72">int</span>, flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock, <span style="color:#ff7b72;font-weight:bold">*</span>newsock;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> file <span style="color:#ff7b72;font-weight:bold">*</span>newfile;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err, len, newfd, fput_needed;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sockaddr_storage address;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sock <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sockfd_lookup_light</span>(fd, <span style="color:#ff7b72;font-weight:bold">&amp;</span>err, <span style="color:#ff7b72;font-weight:bold">&amp;</span>fput_needed);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	newsock <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_alloc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	newsock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>type <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>type;
</span></span><span style="display:flex;"><span>	newsock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops;
</span></span><span style="display:flex;"><span>	newfd <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_alloc_file</span>(newsock, <span style="color:#ff7b72;font-weight:bold">&amp;</span>newfile, flags);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">accept</span>(sock, newsock, sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>file<span style="color:#ff7b72;font-weight:bold">-&gt;</span>f_flags);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out_fd;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (upeer_sockaddr) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (newsock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">getname</span>(newsock, (<span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>)<span style="color:#ff7b72;font-weight:bold">&amp;</span>address,
</span></span><span style="display:flex;"><span>					  <span style="color:#ff7b72;font-weight:bold">&amp;</span>len, <span style="color:#a5d6ff">2</span>) <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>			err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>ECONNABORTED;
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out_fd;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">move_addr_to_user</span>((<span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>)<span style="color:#ff7b72;font-weight:bold">&amp;</span>address,
</span></span><span style="display:flex;"><span>					len, upeer_sockaddr, upeer_addrlen);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out_fd;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>sys_accept()创建了一个新的socket结构和file，如果建立成功，系统调用返回新建立的文件句柄newfd。
sock-&gt;ops-&gt;accept调用inet_accept。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">inet_accept</span>(<span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock, <span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>newsock, <span style="color:#ff7b72">int</span> flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk1 <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EINVAL;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk2 <span style="color:#ff7b72;font-weight:bold">=</span> sk1<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">accept</span>(sk1, flags, <span style="color:#ff7b72;font-weight:bold">&amp;</span>err);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sock_graft</span>(sk2, newsock);
</span></span><span style="display:flex;"><span>	newsock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>state <span style="color:#ff7b72;font-weight:bold">=</span> SS_CONNECTED;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>sk1-&gt;sk_prot-&gt;accept调用inet_csk_accept，返回一个sock结构，接着调用sock_graft将newsock与sk2绑定，最后将新创建的socket状态置位SS_CONNECTED。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-26">26</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#d2a8ff;font-weight:bold">inet_csk_accept</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">int</span> flags, <span style="color:#ff7b72">int</span> <span style="color:#ff7b72;font-weight:bold">*</span>err)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> inet_connection_sock <span style="color:#ff7b72;font-weight:bold">*</span>icsk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_csk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>newsk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> error;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">lock_sock</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">reqsk_queue_empty</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>icsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_accept_queue)) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">long</span> timeo <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_rcvtimeo</span>(sk, flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> O_NONBLOCK);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		error <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_csk_wait_for_connect</span>(sk, timeo);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (error)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out_err;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 从icsk_accept_queue中取出一个sock结构 */</span>
</span></span><span style="display:flex;"><span>	newsk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">reqsk_queue_get_child</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>icsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_accept_queue, sk);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">WARN_ON</span>(newsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state <span style="color:#ff7b72;font-weight:bold">==</span> TCP_SYN_RECV);
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">release_sock</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> newsk;
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out_err</span>:
</span></span><span style="display:flex;"><span>	newsk <span style="color:#ff7b72;font-weight:bold">=</span> NULL;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72;font-weight:bold">*</span>err <span style="color:#ff7b72;font-weight:bold">=</span> error;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>inet_csk_accept首先进行判断，若icsk_accept_queue队列为空，表示没有收到连接请求，调用inet_csk_wait_for_connect()，让出 CPU，并且将进程状态设置为 TASK_INTERRUPTIBLE。若队列不为空，表示存在连接请求，从队列头取出连接请求的sock结构。这里可以思考连接请求是什么是否加入到
icsk_accept_queue队列的呢？先留个悬念。</p>
<h2 id="connect建立连接">connect建立连接</h2>
<p>接下来看connect()调用实现</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">SYSCALL_DEFINE3</span>(connect, <span style="color:#ff7b72">int</span>, fd, <span style="color:#ff7b72">struct</span> sockaddr __user <span style="color:#ff7b72;font-weight:bold">*</span>, uservaddr,
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">int</span>, addrlen)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">struct</span> sockaddr_storage address;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">int</span> err, fput_needed;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#8b949e;font-style:italic">/* 根据fd从当前进程的current-&gt;files[fd]取出file文件结构 并从file的private_date取出sock */</span>
</span></span><span style="display:flex;"><span>   sock <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sockfd_lookup_light</span>(fd, <span style="color:#ff7b72;font-weight:bold">&amp;</span>err, <span style="color:#ff7b72;font-weight:bold">&amp;</span>fput_needed);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>   <span style="color:#8b949e;font-style:italic">/* 将连接地址从用户侧 复制到内核 */</span>
</span></span><span style="display:flex;"><span>   err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">move_addr_to_kernel</span>(uservaddr, addrlen, (<span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>)<span style="color:#ff7b72;font-weight:bold">&amp;</span>address);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>   <span style="color:#8b949e;font-style:italic">/* 调用inetsw中inet_stream_ops的connect函数 */</span>
</span></span><span style="display:flex;"><span>   err <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">connect</span>(sock, (<span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>)<span style="color:#ff7b72;font-weight:bold">&amp;</span>address, addrlen,
</span></span><span style="display:flex;"><span>   			 sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>file<span style="color:#ff7b72;font-weight:bold">-&gt;</span>f_flags);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>sock-&gt;ops-&gt;connect指向inet_stream_connect。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-57">57</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">inet_stream_connect</span>(<span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock, <span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>uaddr,
</span></span><span style="display:flex;"><span>   		<span style="color:#ff7b72">int</span> addr_len, <span style="color:#ff7b72">int</span> flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">long</span> timeo;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>   <span style="color:#8b949e;font-style:italic">/* 判断sock的状态*/</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">switch</span> (sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>state) {
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">default</span><span style="color:#ff7b72;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>   	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EINVAL;
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SS_CONNECTED</span>:
</span></span><span style="display:flex;"><span>   	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EISCONN;
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SS_CONNECTING</span>:
</span></span><span style="display:flex;"><span>   	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EALREADY;
</span></span><span style="display:flex;"><span>   	<span style="color:#8b949e;font-style:italic">/* Fall out of switch with err, set for this state */</span>
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">SS_UNCONNECTED</span>:
</span></span><span style="display:flex;"><span>   	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EISCONN;
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">if</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state <span style="color:#ff7b72;font-weight:bold">!=</span> TCP_CLOSE)
</span></span><span style="display:flex;"><span>   		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>   	<span style="color:#8b949e;font-style:italic">/* 调用tcp_v4_connect */</span>
</span></span><span style="display:flex;"><span>   	err <span style="color:#ff7b72;font-weight:bold">=</span> sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">connect</span>(sk, uaddr, addr_len);
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>   		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   	sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>state <span style="color:#ff7b72;font-weight:bold">=</span> SS_CONNECTING;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#8b949e;font-style:italic">/* 发送定时 */</span>
</span></span><span style="display:flex;"><span>   timeo <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_sndtimeo</span>(sk, flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> O_NONBLOCK);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">if</span> ((<span style="color:#a5d6ff">1</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state) <span style="color:#ff7b72;font-weight:bold">&amp;</span> (TCPF_SYN_SENT <span style="color:#ff7b72;font-weight:bold">|</span> TCPF_SYN_RECV)) {
</span></span><span style="display:flex;"><span>   	<span style="color:#8b949e;font-style:italic">/* Error code is set above */</span>
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>timeo <span style="color:#ff7b72;font-weight:bold">||</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">inet_wait_for_connect</span>(sk, timeo))
</span></span><span style="display:flex;"><span>   		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_intr_errno</span>(timeo);
</span></span><span style="display:flex;"><span>   	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">signal_pending</span>(current))
</span></span><span style="display:flex;"><span>   		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>state <span style="color:#ff7b72;font-weight:bold">=</span> SS_CONNECTED;
</span></span><span style="display:flex;"><span>   err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out</span>:
</span></span><span style="display:flex;"><span>   <span style="color:#d2a8ff;font-weight:bold">release_sock</span>(sk);
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">return</span> err;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">sock_error</span>:
</span></span><span style="display:flex;"><span>   err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_error</span>(sk) <span style="color:#ff7b72;font-weight:bold">?</span> <span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#ff7b72;font-weight:bold">-</span>ECONNABORTED;
</span></span><span style="display:flex;"><span>   sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>state <span style="color:#ff7b72;font-weight:bold">=</span> SS_UNCONNECTED;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">if</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_prot<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">disconnect</span>(sk, flags))
</span></span><span style="display:flex;"><span>   	sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>state <span style="color:#ff7b72;font-weight:bold">=</span> SS_DISCONNECTING;
</span></span><span style="display:flex;"><span>   <span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>inet_stream_connect()函数判断sock-&gt;state是SS_UNCONNECTED状态，调用sk-&gt;sk_prot-&gt;connect发送syn报文，通过sock_sndtimeo()发送无阻塞定时等待服务器回复。sk-&gt;sk_prot-&gt;connect指向tcp_v4_connect()。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-57">57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-58">58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-59">59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-60">60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-61">61</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-62">62</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-63">63</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-64">64</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">tcp_v4_connect</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>uaddr, <span style="color:#ff7b72">int</span> addr_len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> inet_sock <span style="color:#ff7b72;font-weight:bold">*</span>inet <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> tcp_sock <span style="color:#ff7b72;font-weight:bold">*</span>tp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sockaddr_in <span style="color:#ff7b72;font-weight:bold">*</span>usin <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">struct</span> sockaddr_in <span style="color:#ff7b72;font-weight:bold">*</span>)uaddr;
</span></span><span style="display:flex;"><span>	__be16 orig_sport, orig_dport;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span>rt;
</span></span><span style="display:flex;"><span>	__be32 daddr, nexthop;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	nexthop <span style="color:#ff7b72;font-weight:bold">=</span> daddr <span style="color:#ff7b72;font-weight:bold">=</span> usin<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sin_addr.s_addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	orig_sport <span style="color:#ff7b72;font-weight:bold">=</span> inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_sport;
</span></span><span style="display:flex;"><span>	orig_dport <span style="color:#ff7b72;font-weight:bold">=</span> usin<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sin_port;
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 查找路由表 RT_CONN_FLAGS(sk)记录网络设备ID*/</span>
</span></span><span style="display:flex;"><span>	rt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_route_connect</span>(nexthop, inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr,
</span></span><span style="display:flex;"><span>			      <span style="color:#d2a8ff;font-weight:bold">RT_CONN_FLAGS</span>(sk), sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_bound_dev_if,
</span></span><span style="display:flex;"><span>			      IPPROTO_TCP,
</span></span><span style="display:flex;"><span>			      orig_sport, orig_dport, sk, true);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr)
</span></span><span style="display:flex;"><span>		inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr <span style="color:#ff7b72;font-weight:bold">=</span> rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_src;
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 接收地址与源地址相同 */</span>
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_rcv_saddr <span style="color:#ff7b72;font-weight:bold">=</span> inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 设备目的端口与地址 */</span>
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_dport <span style="color:#ff7b72;font-weight:bold">=</span> usin<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sin_port;
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_daddr <span style="color:#ff7b72;font-weight:bold">=</span> daddr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始化connect_sock.icsk_ext_hdr_len */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">inet_csk</span>(sk)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_ext_hdr_len <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* opt对应ip_option结构，保存set_sockoption()设置的 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>opt)
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">inet_csk</span>(sk)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_ext_hdr_len <span style="color:#ff7b72;font-weight:bold">=</span> inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>opt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>optlen;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始化mss最大分段值536 */</span>
</span></span><span style="display:flex;"><span>	tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rx_opt.mss_clamp <span style="color:#ff7b72;font-weight:bold">=</span> TCP_MSS_DEFAULT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">tcp_set_state</span>(sk, TCP_SYN_SENT);
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 检查端口是否可用 */</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_hash_connect</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tcp_death_row, sk);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 新建路由表 */</span>
</span></span><span style="display:flex;"><span>	rt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_route_newports</span>(rt, IPPROTO_TCP,
</span></span><span style="display:flex;"><span>			       orig_sport, orig_dport,
</span></span><span style="display:flex;"><span>			       inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_sport, inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_dport, sk);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_gso_type <span style="color:#ff7b72;font-weight:bold">=</span> SKB_GSO_TCPV4;
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 设置分段标志与分段值 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sk_setup_caps</span>(sk, <span style="color:#ff7b72;font-weight:bold">&amp;</span>rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>write_seq)
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 计算发送序号 */</span>
</span></span><span style="display:flex;"><span>		tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>write_seq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">secure_tcp_sequence_number</span>(inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr,
</span></span><span style="display:flex;"><span>							   inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_daddr,
</span></span><span style="display:flex;"><span>							   inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_sport,
</span></span><span style="display:flex;"><span>							   usin<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sin_port);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_id <span style="color:#ff7b72;font-weight:bold">=</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>write_seq <span style="color:#ff7b72;font-weight:bold">^</span> jiffies;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 发送syn包 */</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_connect</span>(sk);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcp_v4_connect()函数调用ip_route_connect()从fib_table中查找路由信息，找到报文从那个网络设备发送并配置inet_saddr，调用inet_hash_connect()，分配、校验源端口并配置inet_sport。通过调用ip_route_newports()，为socket新建路由项，下次发送数据直接从rt_hash_table中获取路由项。通过tcp_set_state(),设置sock状态为TCP_SYN_SENT。最后调用tcp_connect发送syn包</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-41">41</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">tcp_connect</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> tcp_sock <span style="color:#ff7b72;font-weight:bold">*</span>tp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>buff;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始化tcp_sock结构 tcp头、mtu、mss、滑动窗口等 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">tcp_connect_init</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 申请sk_buff发送缓存空间 */</span>
</span></span><span style="display:flex;"><span>	buff <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">alloc_skb_fclone</span>(MAX_TCP_HEADER <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">15</span>, sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_allocation);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">unlikely</span>(buff <span style="color:#ff7b72;font-weight:bold">==</span> NULL))
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>ENOBUFS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Reserve space for headers. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 数据块头等于数据块尾 并都向后移MAX_TCP_HEADER长度 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">skb_reserve</span>(buff, MAX_TCP_HEADER);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>snd_nxt <span style="color:#ff7b72;font-weight:bold">=</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>write_seq;
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始化控制结构tcp_skb_cb */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">tcp_init_nondata_skb</span>(buff, tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>write_seq<span style="color:#ff7b72;font-weight:bold">++</span>, TCPHDR_SYN);
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 设置阻塞报告标志 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_ECN_send_syn</span>(sk, buff);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 将发送buff加到发送队列sk.sk_write_queue */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">__tcp_add_write_queue_tail</span>(sk, buff);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_transmit_skb</span>(sk, buff, <span style="color:#a5d6ff">1</span>, sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_allocation);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#ff7b72;font-weight:bold">-</span>ECONNREFUSED)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> err;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>snd_nxt <span style="color:#ff7b72;font-weight:bold">=</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>write_seq;
</span></span><span style="display:flex;"><span>	tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pushed_seq <span style="color:#ff7b72;font-weight:bold">=</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>write_seq;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_INC_STATS</span>(<span style="color:#d2a8ff;font-weight:bold">sock_net</span>(sk), TCP_MIB_ACTIVEOPENS);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Timer for repeating the SYN until an answer. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 超时重发 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">inet_csk_reset_xmit_timer</span>(sk, ICSK_TIME_RETRANS,
</span></span><span style="display:flex;"><span>				  <span style="color:#d2a8ff;font-weight:bold">inet_csk</span>(sk)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_rto, TCP_RTO_MAX);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcp_connect()函数创建sk_buff结构，并初始化tcp_sock结构的mtu、mss、滑动窗口等信息，最后调用tcp_transmit_skb，构建tcp报头。</p>
<p>tcp_transmit_skb留到发送消息在讲。从socket()到connet()，能明显看出这些接口都是从glibc中进入系统中断，进到内核的sys_socketcall，在根据传入call走不同的switch。从socket()函数初始化soket，sock，file等结构，其余接口都是从file中获取socket，然后调用sock.prot_ops与sock.prot。下面总结了四个接口的大致调用流程。
<img src="/image/tcp_ip/uuZtxnKsBrtLMiZG.png" alt="输入图片说明"></p>
<h2 id="什么是路由">什么是路由?</h2>
<p>在网络系统中，路由表示数据报文的流向，类似现实世界中道路的方向指示牌，用于告诉我们(报文)是向左还是向右走。</p>
<p>下面是linux系统中路由初始化的接口调用图，初始化主要构建rt_hash_bucket与fib_table结构以及注册设备通知事件。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-21">21</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>初始化:
</span></span><span style="display:flex;"><span>inet_init
</span></span><span style="display:flex;"><span>ip_init
</span></span><span style="display:flex;"><span> ip_rt_init
</span></span><span style="display:flex;"><span>  alloc_large_system_hash		//创建rtable结构的哈希表
</span></span><span style="display:flex;"><span>  devinet_init
</span></span><span style="display:flex;"><span>    register_pernet_subsys  //向pernet_list注册devinet_ops并调用devinet_init_net函数注册网络空间
</span></span><span style="display:flex;"><span>      devinet_init_net  //初始化init_net
</span></span><span style="display:flex;"><span>    register_netdevice_notifier //注册设备通知ip_netdev_notifier到netdev_chain
</span></span><span style="display:flex;"><span>    				inetdev_event  //设备通知的处理函数
</span></span><span style="display:flex;"><span>    rtnl_register
</span></span><span style="display:flex;"><span>  ip_fib_init
</span></span><span style="display:flex;"><span>    rtnl_register
</span></span><span style="display:flex;"><span>    register_pernet_subsys
</span></span><span style="display:flex;"><span>      fib_net_init
</span></span><span style="display:flex;"><span>        ip_fib_net_init
</span></span><span style="display:flex;"><span>          fib4_rules_init		//创建fib_table结构RT_TABLE_LOCAL、RT_TABLE_MAIN加到net.ipv4.fib_table_hash
</span></span><span style="display:flex;"><span>        nl_fib_lookup_init
</span></span><span style="display:flex;"><span>    register_netdevice_notifier	
</span></span><span style="display:flex;"><span>       register_inetaddr_notifier  //注册地址通知fib_inetaddr_notifier
</span></span><span style="display:flex;"><span>    fib_trie_init			//创建fib_alias结构的高速缓存cache
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>设备通知链调用路线</strong></p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-20-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-20-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-20-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-20-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-20-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-20-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-20-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>dm9000_probe
</span></span><span style="display:flex;"><span>  register_netdev
</span></span><span style="display:flex;"><span>   register_netdevice  
</span></span><span style="display:flex;"><span>    call_netdevice_notifiers
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>      notifier_call_chain		//调用netdev_chain上所有notifier_block.notifier_call
</span></span></code></pre></td></tr></table>
</div>
</div><p>网络设备device与drive匹配后执行probe函数，在dm9000中，probe初始化net_device结构量并调用register_netdev注册，注册函数最终会调用notifier_call_chain接口，触发设备通知链路，系统根据notifier_call_chain传递的event事件，对设备做不同操作。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-21-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-21-49">49</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/ipv4/devinet.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">inetdev_event</span>(<span style="color:#ff7b72">struct</span> notifier_block <span style="color:#ff7b72;font-weight:bold">*</span>this, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> event,
</span></span><span style="display:flex;"><span>			 <span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span>ptr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev <span style="color:#ff7b72;font-weight:bold">=</span> ptr;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> in_device <span style="color:#ff7b72;font-weight:bold">*</span>in_dev <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__in_dev_get_rtnl</span>(dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">ASSERT_RTNL</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>in_dev) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (event <span style="color:#ff7b72;font-weight:bold">==</span> NETDEV_REGISTER) {
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 设备注册时创建in_device结构量 */</span>
</span></span><span style="display:flex;"><span>			in_dev <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inetdev_init</span>(dev);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">switch</span> (event) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">NETDEV_REGISTER</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_DEBUG <span style="color:#a5d6ff">&#34;inetdev_event: bug</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">rcu_assign_pointer</span>(dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ip_ptr, NULL);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">NETDEV_UP</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 将in_dev结构加入到ifa-&gt;ifa_dev中，ifa加到in_dev.ifa_list */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">inetdev_valid_mtu</span>(dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>mtu))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> IFF_LOOPBACK) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">struct</span> in_ifaddr <span style="color:#ff7b72;font-weight:bold">*</span>ifa <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_alloc_ifa</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (ifa) {
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">INIT_HLIST_NODE</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash);
</span></span><span style="display:flex;"><span>				ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifa_local <span style="color:#ff7b72;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>				  ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifa_address <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">htonl</span>(INADDR_LOOPBACK);
</span></span><span style="display:flex;"><span>				ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifa_prefixlen <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">8</span>;
</span></span><span style="display:flex;"><span>				ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifa_mask <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_make_mask</span>(<span style="color:#a5d6ff">8</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">in_dev_hold</span>(in_dev);
</span></span><span style="display:flex;"><span>				ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifa_dev <span style="color:#ff7b72;font-weight:bold">=</span> in_dev;
</span></span><span style="display:flex;"><span>				ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifa_scope <span style="color:#ff7b72;font-weight:bold">=</span> RT_SCOPE_HOST;
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(ifa<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifa_label, dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>name, IFNAMSIZ);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">inet_insert_ifa</span>(ifa);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 驱动设备up */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">ip_mc_up</span>(in_dev);
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* fall through */</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> NOTIFY_DONE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>路由查询</strong>
在connect连接过程中，通过调用sys_connect -&gt; inet_stream_connect -&gt;  tcp_v4_connect -&gt; ip_route_connect查找路由，下面来看看具体实现。</p>
<p><strong>路由查询调用路线</strong></p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-22-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-22-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-22-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-22-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-22-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-22-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-6">6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-22-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-22-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ip_route_connect
</span></span><span style="display:flex;"><span>  ip_route_output_flow  //创建并初始化一个flowi4结构
</span></span><span style="display:flex;"><span>    __ip_route_output_key
</span></span><span style="display:flex;"><span>      rt_hash_table    //从rt_hash_table全局变量中获取路由项
</span></span><span style="display:flex;"><span>      ip_route_output_slow  //未找到路由项 执行此处
</span></span><span style="display:flex;"><span>        fib_lookup   //查找fib_table
</span></span><span style="display:flex;"><span>        __mkroute_output  //根据找到的源地址与目的地址、端口新建一个路由项插到rt_hash_table中
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>路由添加</strong>
<strong>使用 route add 命令：</strong>
<code>route add -net 192.168.1.100 netmask 255.255.255.255 dev eth0</code></p>
<p><strong>使用 ip route add 命令：</strong>
<code>ip route add 192.168.1.100/32 dev eth0</code></p>
<p><strong>使用 Socket API：</strong>
调用 ioctl() 函数，指定 SIOCSIFADDR 命令可以将 IP 地址加入路由表。</p>
<p><strong>connect调用路线</strong></p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-23-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-23-23">23</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SYSCALL_DEFINE3(connect, int, fd, struct sockaddr __user *, uservaddr,int, addrlen)
</span></span><span style="display:flex;"><span>  sockfd_lookup_light		//通过fd找到sock file.private_data=sock
</span></span><span style="display:flex;"><span>  move_addr_to_kernel		//将数据从用户态copy到用户态， 由于进程空间互相隔离
</span></span><span style="display:flex;"><span>  inet_stream_connect
</span></span><span style="display:flex;"><span>    tcp_v4_connect 			//发送syn包并sk-&gt;sk_state = TCP_SYN_SENT
</span></span><span style="display:flex;"><span>      ip_route_connect  //查找路由
</span></span><span style="display:flex;"><span>        __ip_route_output_key  //根据saddr、daddr等地址到rt_hash_table中查找
</span></span><span style="display:flex;"><span>          ip_route_output_slow  //到fib_table中查找路由项
</span></span><span style="display:flex;"><span>            fib_lookup			//查找路由表
</span></span><span style="display:flex;"><span>            __mkroute_output  //创建rtable
</span></span><span style="display:flex;"><span>      tcp_connect			//初始化tcp_sock并创建skb_buff
</span></span><span style="display:flex;"><span>	       tcp_transmit_skb    //初始化skb_buff上的tcphd结构
</span></span><span style="display:flex;"><span>		      skb_push
</span></span><span style="display:flex;"><span>			     ip_queue_xmit  //检查路由项并初始化iphd结构
</span></span><span style="display:flex;"><span>				     ip_local_out		//经过netfilter过滤数据包并走路由发送
</span></span><span style="display:flex;"><span>					     nf_hook(NFPROTO_IPV4, NF_INET_LOCAL_OUT...
</span></span><span style="display:flex;"><span>					     dst_output  	//在__mkroute_output中指定了dst.output=ip_output
</span></span><span style="display:flex;"><span>						    ip_output
</span></span><span style="display:flex;"><span>							    ip_finish_output2
</span></span><span style="display:flex;"><span>								    neigh_resolve_output  //创建以太网头部hh_cache
</span></span><span style="display:flex;"><span>									    dev_queue_xmit    //使用网络设备注册的发送函数
</span></span><span style="display:flex;"><span>									    
</span></span><span style="display:flex;"><span>    sock_sndtimeo			//设置超时时间
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="数据接收">数据接收</h2>
<p>在dm9000型号的网卡中，网卡驱动向系统注册了一系列网卡操作函数，如下所示:</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-24-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-24-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">struct</span> net_device_ops dm9000_netdev_ops <span style="color:#ff7b72;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>	.ndo_open		<span style="color:#ff7b72;font-weight:bold">=</span> dm9000_open,
</span></span><span style="display:flex;"><span>	.ndo_stop		<span style="color:#ff7b72;font-weight:bold">=</span> dm9000_stop,
</span></span><span style="display:flex;"><span>	.ndo_start_xmit		<span style="color:#ff7b72;font-weight:bold">=</span> dm9000_start_xmit,
</span></span><span style="display:flex;"><span>	.ndo_tx_timeout		<span style="color:#ff7b72;font-weight:bold">=</span> dm9000_timeout,
</span></span><span style="display:flex;"><span>	.ndo_set_multicast_list	<span style="color:#ff7b72;font-weight:bold">=</span> dm9000_hash_table,
</span></span><span style="display:flex;"><span>	.ndo_do_ioctl		<span style="color:#ff7b72;font-weight:bold">=</span> dm9000_ioctl,
</span></span><span style="display:flex;"><span>	.ndo_change_mtu		<span style="color:#ff7b72;font-weight:bold">=</span> eth_change_mtu,
</span></span><span style="display:flex;"><span>	.ndo_validate_addr	<span style="color:#ff7b72;font-weight:bold">=</span> eth_validate_addr,
</span></span><span style="display:flex;"><span>	.ndo_set_mac_address	<span style="color:#ff7b72;font-weight:bold">=</span> eth_mac_addr,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们使用ifconfig eth0 up启动网卡时会执行系统调用sys_ioctl -&gt; vfs_ioctl -&gt; sock_ioctl -&gt;&hellip; -&gt; dev_open -&gt; dm9000_open。dm9000_open清除网卡接收缓存，并注册接收中断处理函数dm9000_interrupt()。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-25-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-25-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">dm9000_open</span>(<span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">board_info_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>db <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">netdev_priv</span>(dev);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> irqflags <span style="color:#ff7b72;font-weight:bold">=</span> db<span style="color:#ff7b72;font-weight:bold">-&gt;</span>irq_res<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> IRQF_TRIGGER_MASK;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">request_irq</span>(dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>irq, dm9000_interrupt, irqflags, dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>name, dev))
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>EAGAIN;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Initialize DM9000 board */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">dm9000_reset</span>(db);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">dm9000_init_dm9000</span>(dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Init driver variable */</span>
</span></span><span style="display:flex;"><span>	db<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dbug_cnt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>物理网卡接收到数据报文，触发中断，系统调用中断处理函数dm9000_interrupt -&gt; dm9000_rx。dm9000_rx函数循环接收网卡数据并将数据存到sbk_buff中。网卡接收路线如下所示：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-26-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-26-53">53</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>dm9000_interrupt		//接收中断 通过epoll接收
</span></span><span style="display:flex;"><span>  dm9000_rx
</span></span><span style="display:flex;"><span>    dev_alloc_skb		//创建skb
</span></span><span style="display:flex;"><span>    eth_type_trans		//将网卡读到的数据加到skb结构中
</span></span><span style="display:flex;"><span>    netif_rx				//
</span></span><span style="display:flex;"><span>      enqueue_to_backlog  //将skb包压入softnet_data.input_pkt_queue 软中断的结构上
</span></span><span style="display:flex;"><span>		    ____napi_schedule  //new api技术 解决设备频繁中断CPU问题。每当收到一个数据报，就触发软中断，让CPU使用epoll轮询网卡，读取数据。
</span></span><span style="display:flex;"><span>			    __raise_softirq_irqoff(NET_RX_SOFTIRQ) //在net_dev_init中设置软中断接收函数
</span></span><span style="display:flex;"><span>				    net_rx_action		//软中断处理函数，负责循环处理sd中的skb包
</span></span><span style="display:flex;"><span>					     process_backlog  //n.poll也是在net_dev_init初始化
</span></span><span style="display:flex;"><span>						    __skb_dequeue		//从sd.process_queue解析出skb
</span></span><span style="display:flex;"><span>							   __netif_receive_skb  //从ptype_base链表中取出系统注册的数据包类型结构 这里inent_init中注册了dev_add_pack(&amp;ip_pachet_type)
</span></span><span style="display:flex;"><span>							     deliver_skb		//调用ip_pachet_type.func = ip_rcv
</span></span><span style="display:flex;"><span>								    ip_rcv
</span></span><span style="display:flex;"><span>								      NF_HOOK(NFPROTO_IPV4, NF_INET_PRE_ROUTING, skb, dev, NULL, ip_rcv_finish)
</span></span><span style="display:flex;"><span>								        ip_rcv_finish  //查找路由 由于skb是网卡创建其中没有路由项
</span></span><span style="display:flex;"><span>								          ip_route_input_noref  //创建路由
</span></span><span style="display:flex;"><span>								            ip_route_input_common
</span></span><span style="display:flex;"><span>								              rt_hash_table		//从rt_hash_table中找路由项
</span></span><span style="display:flex;"><span>								              ip_route_input_slow  //**此处根据路由表不同，决定是转发还是发到本地**
</span></span><span style="display:flex;"><span>								                fib_lookup  //从fib_table找路由表
</span></span><span style="display:flex;"><span>								          ip_rcv_options  //接收ip头的option
</span></span><span style="display:flex;"><span>								          dst_input   //路由 本地接收dst.input=ip_local_deliver 路由转发 dst.input=ip_forward
</span></span><span style="display:flex;"><span>										  
</span></span><span style="display:flex;"><span>//本地接收流程
</span></span><span style="display:flex;"><span>								            ip_local_deliver  //分段接收 进入NF_INET_LOCAL_IN
</span></span><span style="display:flex;"><span>								              NF_HOOK(NFPROTO_IPV4, NF_INET_LOCAL_IN, skb, skb-&gt;dev, NULL, ip_local_deliver_finish)
</span></span><span style="display:flex;"><span>								              ip_local_deliver_finish  //准备传到传输层
</span></span><span style="display:flex;"><span>								                tcp_v4_rcv  //调用inet_protos[hash].handler = tcp_v4_rcv
</span></span><span style="display:flex;"><span>								                  __inet_lookup_skb  //在tcp_hashinfo中查找数据包是发到那个sock 根据bind绑定的端口号查找sock
</span></span><span style="display:flex;"><span>								                  tcp_prequeue  //如果有进程在read等待，将接收数据放到tp-&gt;ucopy.prequeue
</span></span><span style="display:flex;"><span>								                  tcp_v4_do_rcv  //处理收到的数据包
</span></span><span style="display:flex;"><span>								                    tcp_rcv_established  //数据包传到服务端
</span></span><span style="display:flex;"><span>								                      tcp_copy_to_iovec  //copy内核数据到服务端的接收缓存中
</span></span><span style="display:flex;"><span>								                  sk_add_backlog  //没有用户等待数据放到sk_backlog结构并返回软中断
</span></span><span style="display:flex;"><span>												  
</span></span><span style="display:flex;"><span>tcp三次握手流程：
</span></span><span style="display:flex;"><span>tcp_v4_do_rcv
</span></span><span style="display:flex;"><span>  tcp_v4_hnd_req  //查看请求包是否已经存在 并创建客户端sock  第一次syn后才将sock加入请求队列
</span></span><span style="display:flex;"><span>    inet_csk_search_req   //从conn_sock.accept_queue中查找请求的sock
</span></span><span style="display:flex;"><span>	   tcp_check_req       //创建客户端sock 
</span></span><span style="display:flex;"><span>	     tcp_v4_syn_recv_sock
</span></span><span style="display:flex;"><span>	   inet_lookup_established
</span></span><span style="display:flex;"><span>  tcp_child_process  //客户端sock与服务端sock都存在，唤醒服务端进程
</span></span><span style="display:flex;"><span>    sock_owned_by_user  //判断客户端sock是否可用
</span></span><span style="display:flex;"><span>    tcp_rcv_state_process
</span></span><span style="display:flex;"><span>      tcp_rcv_synsent_state_process  //TCP第三次握手
</span></span><span style="display:flex;"><span>  tcp_rcv_state_process  //请求包不存在
</span></span><span style="display:flex;"><span>    tcp_v4_conn_request  //服务器收到syn 第一次握手
</span></span><span style="display:flex;"><span>      tcp_v4_send_synack  //服务器发送syn+ack
</span></span><span style="display:flex;"><span>      inet_csk_reqsk_queue_hash_add  //将链接请求加到conn_sock.accept_queue中
</span></span><span style="display:flex;"><span>												  
</span></span><span style="display:flex;"><span>									
</span></span></code></pre></td></tr></table>
</div>
</div><p>在操作系统中，CPU负责运行用户进程，如果网卡触发中断，CPU需要切换堆栈去处理中断函数，接收数据报，在大流量场景这非常影响系统性能。为了解决这个问题，linux采用NAPI技术，当硬件中断到来，触发软中断，在软中断中使用poll技术轮询一段时间接收网络数据包，从而避免频繁触发系统进程切换。</p>
<p>dm9000_rx()驱动层接收完数据后，调用netif_rx()进入内核，将数据报文压入CPU变量softnet_data.input_pkt_queue，接着调用__napi_schedule触发软中断。系统执行执行软中断处理函数net_rx_action()，软中断负责从softnet_data.input_pkt_queue解析数据包并进入系统IP层。</p>
<p><strong>网络层到传输层</strong>
ip_rcv()校验IP层报文是否合法，校验通过调用NF_HOOK()，遍历iptable的preouting节点的所有规则。继续看ip_rcv_finish()
ip_rcv -&gt; NF_HOOK -&gt; ip_rcv_finish</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-27-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-27-22">22</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">ip_rcv_finish</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">struct</span> iphdr <span style="color:#ff7b72;font-weight:bold">*</span>iph <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_hdr</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span>rt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 查找路由 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">skb_dst</span>(skb) <span style="color:#ff7b72;font-weight:bold">==</span> NULL) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">int</span> err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_route_input_noref</span>(skb, iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>daddr, iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>saddr,
</span></span><span style="display:flex;"><span>					       iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>tos, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	rt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_rtable</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_type <span style="color:#ff7b72;font-weight:bold">==</span> RTN_MULTICAST) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">IP_UPD_PO_STATS_BH</span>(<span style="color:#d2a8ff;font-weight:bold">dev_net</span>(rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.dev), IPSTATS_MIB_INMCAST,
</span></span><span style="display:flex;"><span>				skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len);
</span></span><span style="display:flex;"><span>	} <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_type <span style="color:#ff7b72;font-weight:bold">==</span> RTN_BROADCAST)
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">IP_UPD_PO_STATS_BH</span>(<span style="color:#d2a8ff;font-weight:bold">dev_net</span>(rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.dev), IPSTATS_MIB_INBCAST,
</span></span><span style="display:flex;"><span>				skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">dst_input</span>(skb);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ip_rcv_finish()根据网络层报文的目的IP、源IP去查找路由表。前面介绍了输出路由查询，这里讲讲输入路由查询。</p>
<p>ip_route_input_noref -&gt; ip_route_input_common -&gt; ip_route_input_common，在input_common中分别从rt_hash_table与fib_table中查找路由。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-28-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-28-36">36</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">ip_route_input_common</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb, __be32 daddr, __be32 saddr,
</span></span><span style="display:flex;"><span>			   u8 tos, <span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev, <span style="color:#ff7b72">bool</span> noref)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span> rth;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span>	hash;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> iif <span style="color:#ff7b72;font-weight:bold">=</span> dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifindex;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net <span style="color:#ff7b72;font-weight:bold">*</span>net;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> res;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">for</span> (rth <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference</span>(rt_hash_table[hash].chain); rth;
</span></span><span style="display:flex;"><span>	     rth <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference</span>(rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.rt_next)) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> ((((__force u32)rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_key_dst <span style="color:#ff7b72;font-weight:bold">^</span> (__force u32)daddr) <span style="color:#ff7b72;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>		     ((__force u32)rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_key_src <span style="color:#ff7b72;font-weight:bold">^</span> (__force u32)saddr) <span style="color:#ff7b72;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>		     (rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_iif <span style="color:#ff7b72;font-weight:bold">^</span> iif) <span style="color:#ff7b72;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>		     rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_oif <span style="color:#ff7b72;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>		     (rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_tos <span style="color:#ff7b72;font-weight:bold">^</span> tos)) <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span> <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_mark <span style="color:#ff7b72;font-weight:bold">==</span> skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>mark <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#d2a8ff;font-weight:bold">net_eq</span>(<span style="color:#d2a8ff;font-weight:bold">dev_net</span>(rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.dev), net) <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">rt_is_expired</span>(rth)) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (noref) {
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">dst_use_noref</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst, jiffies);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">skb_dst_set_noref</span>(skb, <span style="color:#ff7b72;font-weight:bold">&amp;</span>rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst);
</span></span><span style="display:flex;"><span>			} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">dst_use</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst, jiffies);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">skb_dst_set</span>(skb, <span style="color:#ff7b72;font-weight:bold">&amp;</span>rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">RT_CACHE_STAT_INC</span>(in_hit);
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">rcu_read_unlock</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">RT_CACHE_STAT_INC</span>(in_hlist_search);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	res <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_route_input_slow</span>(skb, daddr, saddr, tos, dev);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在ip_route_input_slow()函数中调用fib_lookup()查路由表fib_table，并根据查询结果，创建新的路由项。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-57">57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-58">58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-59">59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-60">60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-61">61</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-62">62</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-63">63</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-64">64</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-65">65</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-29-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-29-66">66</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">ip_route_input_slow</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb, __be32 daddr, __be32 saddr,
</span></span><span style="display:flex;"><span>			       u8 tos, <span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> fib_result res;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> in_device <span style="color:#ff7b72;font-weight:bold">*</span>in_dev <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__in_dev_get_rcu</span>(dev);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> flowi4	fl4;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span>	flags <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	u32		itag <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span> rth;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span>	hash;
</span></span><span style="display:flex;"><span>	__be32		spec_dst;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EINVAL;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net    <span style="color:#ff7b72;font-weight:bold">*</span> net <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">dev_net</span>(dev);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	fl4.flowi4_oif <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	fl4.flowi4_iif <span style="color:#ff7b72;font-weight:bold">=</span> dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifindex;
</span></span><span style="display:flex;"><span>	fl4.flowi4_mark <span style="color:#ff7b72;font-weight:bold">=</span> skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>mark;
</span></span><span style="display:flex;"><span>	fl4.flowi4_tos <span style="color:#ff7b72;font-weight:bold">=</span> tos;
</span></span><span style="display:flex;"><span>	fl4.flowi4_scope <span style="color:#ff7b72;font-weight:bold">=</span> RT_SCOPE_UNIVERSE;
</span></span><span style="display:flex;"><span>	fl4.daddr <span style="color:#ff7b72;font-weight:bold">=</span> daddr;
</span></span><span style="display:flex;"><span>	fl4.saddr <span style="color:#ff7b72;font-weight:bold">=</span> saddr;
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">fib_lookup</span>(net, <span style="color:#ff7b72;font-weight:bold">&amp;</span>fl4, <span style="color:#ff7b72;font-weight:bold">&amp;</span>res);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">IN_DEV_FORWARD</span>(in_dev))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> e_hostunreach;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> no_route;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (res.type <span style="color:#ff7b72;font-weight:bold">==</span> RTN_LOCAL) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">fib_validate_source</span>(saddr, daddr, tos,
</span></span><span style="display:flex;"><span>					  net<span style="color:#ff7b72;font-weight:bold">-&gt;</span>loopback_dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ifindex,
</span></span><span style="display:flex;"><span>					  dev, <span style="color:#ff7b72;font-weight:bold">&amp;</span>spec_dst, <span style="color:#ff7b72;font-weight:bold">&amp;</span>itag, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>mark);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> martian_source_keep_err;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err)
</span></span><span style="display:flex;"><span>			flags <span style="color:#ff7b72;font-weight:bold">|=</span> RTCF_DIRECTSRC;
</span></span><span style="display:flex;"><span>		spec_dst <span style="color:#ff7b72;font-weight:bold">=</span> daddr;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> local_input;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_mkroute_input</span>(skb, <span style="color:#ff7b72;font-weight:bold">&amp;</span>res, <span style="color:#ff7b72;font-weight:bold">&amp;</span>fl4, in_dev, daddr, saddr, tos);
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out</span>:	<span style="color:#ff7b72">return</span> err;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">local_input</span>:
</span></span><span style="display:flex;"><span>	rth <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rt_dst_alloc</span>(<span style="color:#d2a8ff;font-weight:bold">IN_DEV_CONF_GET</span>(in_dev, NOPOLICY), false);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>rth)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> e_nobufs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.output<span style="color:#ff7b72;font-weight:bold">=</span> ip_rt_bug;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.input<span style="color:#ff7b72;font-weight:bold">=</span> ip_local_deliver;
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_flags 	<span style="color:#ff7b72;font-weight:bold">=</span> flags<span style="color:#ff7b72;font-weight:bold">|</span>RTCF_LOCAL;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (res.type <span style="color:#ff7b72;font-weight:bold">==</span> RTN_UNREACHABLE) {
</span></span><span style="display:flex;"><span>		rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.input<span style="color:#ff7b72;font-weight:bold">=</span> ip_error;
</span></span><span style="display:flex;"><span>		rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.error<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>err;
</span></span><span style="display:flex;"><span>		rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_flags 	<span style="color:#ff7b72;font-weight:bold">&amp;=</span> <span style="color:#ff7b72;font-weight:bold">~</span>RTCF_LOCAL;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_type	<span style="color:#ff7b72;font-weight:bold">=</span> res.type;
</span></span><span style="display:flex;"><span>	hash <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rt_hash</span>(daddr, saddr, fl4.flowi4_iif, <span style="color:#d2a8ff;font-weight:bold">rt_genid</span>(net));
</span></span><span style="display:flex;"><span>	rth <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rt_intern_hash</span>(hash, rth, skb, fl4.flowi4_iif);
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">IS_ERR</span>(rth))
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">PTR_ERR</span>(rth);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>local_input表示本地接收，dst.input指向ip_local_deliver。if判断都不满足，调用ip_mkroute_input -&gt; __mkroute_input 。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-30-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-30-29">29</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">__mkroute_input</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb,
</span></span><span style="display:flex;"><span>			   <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">struct</span> fib_result <span style="color:#ff7b72;font-weight:bold">*</span>res,
</span></span><span style="display:flex;"><span>			   <span style="color:#ff7b72">struct</span> in_device <span style="color:#ff7b72;font-weight:bold">*</span>in_dev,
</span></span><span style="display:flex;"><span>			   __be32 daddr, __be32 saddr, u32 tos,
</span></span><span style="display:flex;"><span>			   <span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">**</span>result)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span>rth;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> in_device <span style="color:#ff7b72;font-weight:bold">*</span>out_dev;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> flags <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	__be32 spec_dst;
</span></span><span style="display:flex;"><span>	u32 itag;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	rth <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rt_dst_alloc</span>(<span style="color:#d2a8ff;font-weight:bold">IN_DEV_CONF_GET</span>(in_dev, NOPOLICY),
</span></span><span style="display:flex;"><span>			   <span style="color:#d2a8ff;font-weight:bold">IN_DEV_CONF_GET</span>(out_dev, NOXFRM));
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>rth) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>ENOBUFS;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> cleanup;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.input <span style="color:#ff7b72;font-weight:bold">=</span> ip_forward;
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.output <span style="color:#ff7b72;font-weight:bold">=</span> ip_output;
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_genid <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rt_genid</span>(<span style="color:#d2a8ff;font-weight:bold">dev_net</span>(rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst.dev));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rt_set_nexthop</span>(rth, NULL, res, res<span style="color:#ff7b72;font-weight:bold">-&gt;</span>fi, res<span style="color:#ff7b72;font-weight:bold">-&gt;</span>type, itag);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	rth<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_flags <span style="color:#ff7b72;font-weight:bold">=</span> flags;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>__mkroute_input()创建一个rtable结构，并将dst.input指向ip_forward，表示走路由转发流程。回到ip_rcv_finish -&gt; dst_input，dst_input()根据上面创建的路由项，选择数据包的流向。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-31-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-31-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-31-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-31-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-31-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-31-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/include/net/dst.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">inline</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">dst_input</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">skb_dst</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">input</span>(skb);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续往传输层看，ip_local_deliver -&gt; NF_HOOK -&gt; ip_local_deliver_finish。ip_local_deliver()中调用NF_HOOK，遍历iptable的input链上的规则，然后进入ip_local_deliver_finish调用ipprot-&gt;handler()。其中ipprot-&gt;handler指向tcp_v4_rcv。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-32-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-32-50">50</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/ipv4/tcp_ipv4.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">tcp_v4_rcv</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">struct</span> iphdr <span style="color:#ff7b72;font-weight:bold">*</span>iph;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> tcphdr <span style="color:#ff7b72;font-weight:bold">*</span>th;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> ret;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net <span style="color:#ff7b72;font-weight:bold">*</span>net <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">dev_net</span>(skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 数据包不是发给本地 直接丢弃 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pkt_type <span style="color:#ff7b72;font-weight:bold">!=</span> PACKET_HOST)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> discard_it;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	iph <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_hdr</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ntohl</span>(th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>end_seq <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq <span style="color:#ff7b72;font-weight:bold">+</span> th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>syn <span style="color:#ff7b72;font-weight:bold">+</span> th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>fin <span style="color:#ff7b72;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>				    skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len <span style="color:#ff7b72;font-weight:bold">-</span> th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>doff <span style="color:#ff7b72;font-weight:bold">*</span> <span style="color:#a5d6ff">4</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ack_seq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ntohl</span>(th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ack_seq);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>when	 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags	 <span style="color:#ff7b72;font-weight:bold">=</span> iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>tos;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sacked	 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 在tcp_hashinfo中查找数据包是发到那个sock */</span>
</span></span><span style="display:flex;"><span>	sk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__inet_lookup_skb</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tcp_hashinfo, skb, th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>source, th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dest);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>sk)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> no_tcp_socket;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">process</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 检查sock是否可用 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">sock_owned_by_user</span>(sk)) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 判断缓冲大小并将skb压入tp-&gt;ucopy.prequeue */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">tcp_prequeue</span>(sk, skb))
</span></span><span style="display:flex;"><span>				ret <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_v4_do_rcv</span>(sk, skb);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* sk-&gt;sk_backlog.tail-&gt;next = skb 没有用户等待数据放到sk_backlog结构并返回软中断  */</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">unlikely</span>(<span style="color:#d2a8ff;font-weight:bold">sk_add_backlog</span>(sk, skb))) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">bh_unlock_sock</span>(sk);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">NET_INC_STATS_BH</span>(net, LINUX_MIB_TCPBACKLOGDROP);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> discard_and_relse;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">bh_unlock_sock</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sock_put</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> ret;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcp_v4_rcv()函数中，数据包分三种情况存放：</p>
<ul>
<li>
<p>prequeue 队列
通过sock_owned_by_user判断是否有用户在读，如果存在，就调用tcp_prequeue()将数据放到prequeue 队列</p>
</li>
<li>
<p>backlog 队列
上述条件不成立，调用sk_add_backlog()，将数据包放到backlog队列，返回软中断，直到接收sock的进程被系统唤醒，处理backlog 队列的消息。</p>
</li>
<li>
<p>sk_receive_queue 队列
在tcp_prequeue()中，如果把 sysctl_tcp_low_latency 设置为 0，那就要放在 prequeue 队列中暂存，这样不用等待网络包处理完毕，就可以离开软中断的处理过程，但是会造成比较长的时延。如果把 sysctl_tcp_low_latency 设置为 1，表示不允许低延时退出软中断，需要立刻调用 tcp_v4_do_rcv处理数据包。</p>
</li>
</ul>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-33-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-33-39">39</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">tcp_v4_do_rcv</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>rsk;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 处理数据包 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state <span style="color:#ff7b72;font-weight:bold">==</span> TCP_ESTABLISHED) { <span style="color:#8b949e;font-style:italic">/* Fast path */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">sock_rps_save_rxhash</span>(sk, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rxhash);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">tcp_rcv_established</span>(sk, skb, <span style="color:#d2a8ff;font-weight:bold">tcp_hdr</span>(skb), skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len)) {
</span></span><span style="display:flex;"><span>			rsk <span style="color:#ff7b72;font-weight:bold">=</span> sk;
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> reset;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state <span style="color:#ff7b72;font-weight:bold">==</span> TCP_LISTEN) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 查看请求包是否已经存在 并创建客户端sock*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>nsk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_v4_hnd_req</span>(sk, skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>nsk)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> discard;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (nsk <span style="color:#ff7b72;font-weight:bold">!=</span> sk) {
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 找到客户端sock 唤醒服务端进程 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">tcp_child_process</span>(sk, nsk, skb)) {
</span></span><span style="display:flex;"><span>				rsk <span style="color:#ff7b72;font-weight:bold">=</span> nsk;
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">goto</span> reset;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">sock_rps_save_rxhash</span>(sk, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rxhash);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 处理链接报文 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">tcp_rcv_state_process</span>(sk, skb, <span style="color:#d2a8ff;font-weight:bold">tcp_hdr</span>(skb), skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len)) {
</span></span><span style="display:flex;"><span>		rsk <span style="color:#ff7b72;font-weight:bold">=</span> sk;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> reset;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcp_v4_do_rcv()分两种情况，如果连接已经建立，处于 TCP_ESTABLISHED 状态，调用 tcp_rcv_established，将skb放入sk_receive_queue 队列。另一种情况，就是其他的状态，调用 tcp_rcv_state_process。先来看tcp_rcv_established -&gt; tcp_data_queue实现。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-1">  1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-2">  2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-3">  3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-4">  4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-5">  5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-6">  6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-7">  7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-8">  8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-9">  9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-10"> 10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-11"> 11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-12"> 12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-13"> 13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-14"> 14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-15"> 15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-16"> 16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-17"> 17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-18"> 18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-19"> 19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-20"> 20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-21"> 21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-22"> 22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-23"> 23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-24"> 24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-25"> 25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-26"> 26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-27"> 27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-28"> 28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-29"> 29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-30"> 30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-31"> 31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-32"> 32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-33"> 33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-34"> 34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-35"> 35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-36"> 36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-37"> 37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-38"> 38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-39"> 39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-40"> 40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-41"> 41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-42"> 42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-43"> 43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-44"> 44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-45"> 45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-46"> 46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-47"> 47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-48"> 48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-49"> 49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-50"> 50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-51"> 51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-52"> 52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-53"> 53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-54"> 54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-55"> 55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-56"> 56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-57"> 57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-58"> 58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-59"> 59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-60"> 60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-61"> 61</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-62"> 62</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-63"> 63</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-64"> 64</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-65"> 65</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-66"> 66</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-67"> 67</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-68"> 68</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-69"> 69</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-70"> 70</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-71"> 71</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-72"> 72</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-73"> 73</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-74"> 74</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-75"> 75</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-76"> 76</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-77"> 77</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-78"> 78</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-79"> 79</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-80"> 80</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-81"> 81</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-82"> 82</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-83"> 83</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-84"> 84</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-85"> 85</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-86"> 86</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-87"> 87</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-88"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-88"> 88</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-89"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-89"> 89</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-90"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-90"> 90</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-91"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-91"> 91</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-92"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-92"> 92</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-93"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-93"> 93</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-94"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-94"> 94</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-95"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-95"> 95</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-96"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-96"> 96</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-97"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-97"> 97</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-98"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-98"> 98</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-99"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-99"> 99</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-100"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-100">100</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-101"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-101">101</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-102"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-102">102</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-103"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-103">103</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-104"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-104">104</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-105"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-105">105</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-106"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-106">106</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-107"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-107">107</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-108"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-108">108</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-109"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-109">109</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-110"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-110">110</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-111"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-111">111</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-112"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-112">112</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-113"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-113">113</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-114"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-114">114</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-115"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-115">115</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-116"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-116">116</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-117"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-117">117</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-118"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-118">118</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-119"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-119">119</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-120"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-120">120</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-121"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-121">121</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-122"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-122">122</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-123"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-123">123</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-124"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-124">124</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-125"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-125">125</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-126"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-126">126</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-127"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-127">127</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-128"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-128">128</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-34-129"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-34-129">129</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">tcp_data_queue</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> tcphdr <span style="color:#ff7b72;font-weight:bold">*</span>th <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_hdr</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> tcp_sock <span style="color:#ff7b72;font-weight:bold">*</span>tp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> eaten <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 情况一：skb是期望收到的数据报文 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq <span style="color:#ff7b72;font-weight:bold">==</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">tcp_receive_window</span>(tp) <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out_of_window;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* Ok. In sequence. In window. */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 当前进程是报文接收进程 直接将数据包复制到进程中 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ucopy.task <span style="color:#ff7b72;font-weight:bold">==</span> current <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>copied_seq <span style="color:#ff7b72;font-weight:bold">==</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ucopy.len <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#d2a8ff;font-weight:bold">sock_owned_by_user</span>(sk) <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>urg_data) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">int</span> chunk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">min_t</span>(<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span>, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len,
</span></span><span style="display:flex;"><span>					  tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ucopy.len);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">__set_current_state</span>(TASK_RUNNING);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">local_bh_enable</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">skb_copy_datagram_iovec</span>(skb, <span style="color:#a5d6ff">0</span>, tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ucopy.iov, chunk)) {
</span></span><span style="display:flex;"><span>				tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ucopy.len <span style="color:#ff7b72;font-weight:bold">-=</span> chunk;
</span></span><span style="display:flex;"><span>				tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>copied_seq <span style="color:#ff7b72;font-weight:bold">+=</span> chunk;
</span></span><span style="display:flex;"><span>				eaten <span style="color:#ff7b72;font-weight:bold">=</span> (chunk <span style="color:#ff7b72;font-weight:bold">==</span> skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">tcp_rcv_space_adjust</span>(sk);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">local_bh_disable</span>();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (eaten <span style="color:#ff7b72;font-weight:bold">&lt;=</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">queue_and_out</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 不属于当前进程或者上面复制失败 复制到sk_receive_queue */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (eaten <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span> <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>			    <span style="color:#d2a8ff;font-weight:bold">tcp_try_rmem_schedule</span>(sk, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>truesize))
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">goto</span> drop;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">skb_set_owner_r</span>(skb, sk);
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">__skb_queue_tail</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_receive_queue, skb);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>end_seq;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len)
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">tcp_event_data_recv</span>(sk, skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>fin)
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">tcp_fin</span>(skb, sk, th);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 查找乱序包队列中是否有数据可以取出 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">skb_queue_empty</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>out_of_order_queue)) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">tcp_ofo_queue</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">skb_queue_empty</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>out_of_order_queue))
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">inet_csk</span>(sk)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_ack.pingpong <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rx_opt.num_sacks)
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">tcp_sack_remove</span>(tp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">tcp_fast_path_check</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (eaten <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">__kfree_skb</span>(skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">sock_flag</span>(sk, SOCK_DEAD))
</span></span><span style="display:flex;"><span>			sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">sk_data_ready</span>(sk, <span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 情况二  end_seq &lt; rcv_nxt */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">after</span>(<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>end_seq, tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt)) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* A retransmit, 2nd most common case.  Force an immediate ack. */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">NET_INC_STATS_BH</span>(<span style="color:#d2a8ff;font-weight:bold">sock_net</span>(sk), LINUX_MIB_DELAYEDACKLOST);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">tcp_dsack_set</span>(sk, <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq, <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>end_seq);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out_of_window</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">tcp_enter_quickack_mode</span>(sk);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">inet_csk_schedule_ack</span>(sk);
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">drop</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">__kfree_skb</span>(skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 情况三  seq &gt; rcv_nxt+receive_window */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">before</span>(<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq, tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#d2a8ff;font-weight:bold">tcp_receive_window</span>(tp)))
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out_of_window;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">tcp_enter_quickack_mode</span>(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 情况四  seq &lt; rcv_next */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">before</span>(<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq, tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt)) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">tcp_dsack_set</span>(sk, <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq, tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">tcp_receive_window</span>(tp))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out_of_window;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> queue_and_out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 情况五  乱序包放入out_of_order_queue */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">skb_peek</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>out_of_order_queue)) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* Initial out of order segment, build 1 SACK. */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">tcp_is_sack</span>(tp)) {
</span></span><span style="display:flex;"><span>			tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rx_opt.num_sacks <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>			tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>selective_acks[<span style="color:#a5d6ff">0</span>].start_seq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq;
</span></span><span style="display:flex;"><span>			tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>selective_acks[<span style="color:#a5d6ff">0</span>].end_seq <span style="color:#ff7b72;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>						<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>end_seq;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">__skb_queue_head</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>out_of_order_queue, skb);
</span></span><span style="display:flex;"><span>	} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb1 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_peek_tail</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>out_of_order_queue);
</span></span><span style="display:flex;"><span>		u32 seq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>seq;
</span></span><span style="display:flex;"><span>		u32 end_seq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>end_seq;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (seq <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb1)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>end_seq) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">__skb_queue_after</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>out_of_order_queue, skb1, skb);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rx_opt.num_sacks <span style="color:#ff7b72;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>			    tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>selective_acks[<span style="color:#a5d6ff">0</span>].end_seq <span style="color:#ff7b72;font-weight:bold">!=</span> seq)
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">goto</span> add_sack;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* Common case: data arrive in order after hole. */</span>
</span></span><span style="display:flex;"><span>			tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>selective_acks[<span style="color:#a5d6ff">0</span>].end_seq <span style="color:#ff7b72;font-weight:bold">=</span> end_seq;
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">add_sack</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">tcp_is_sack</span>(tp))
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">tcp_sack_new_ofo_skb</span>(sk, seq, end_seq);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcp_data_queue()中数据包有以下几种处理情况：</p>
<p>第一种情景：接收到的报文是期望收到的报文(seq=rcv_nxt)，这种情况会进一步判断当前进程是否是报文接收接收进程，如果是则将报文直接传到进程空间，否则将报文放到sk_receive_queue。</p>
<p>第二种情景：end_seq 不大于 rcv_nxt，也即服务端期望网络包 5。但是，来了一个网络包 3，怎样才会出现这种情况呢？肯定是服务端早就收到了网络包 3，但是 ACK 没有到达客户端，中途丢了，那客户端就认为网络包 3 没有发送成功，于是又发送了一遍，这种情况下，要赶紧给客户端再发送一次 ACK，表示早就收到了。</p>
<p>第三种情景：seq 不小于 rcv_nxt + tcp_receive_window。这说明客户端发送得太猛了。本来 seq 肯定应该在接收窗口里面的，这样服务端才来得及处理，结果现在超出了接收窗口，说明客户端一下子把服务端给塞满了。</p>
<p>这种情况下，服务端不能再接收数据包了，只能发送 ACK 了，在 ACK 中会将接收窗口为 0 的情况告知客户端，客户端就知道不能再发送了。这个时候双方只能交互窗口探测数据包，直到服务端因为用户进程把数据读走了，空出接收窗口，才能在 ACK 里面再次告诉客户端，又有窗口了，又能发送数据包了。</p>
<p>第四种情况，seq 小于 rcv_nxt，但是 end_seq 大于 rcv_nxt，这说明从 seq 到 rcv_nxt 这部分网络包原来的 ACK 客户端没有收到，所以重新发送了一次，从 rcv_nxt 到 end_seq 时新发送的，可以放入 <strong>sk_receive_queue</strong> 队列。</p>
<p>第五种情况，表示数据包发生乱序，将乱序包放到<strong>out_of_order_queue</strong>队列中。</p>
<p>以上就是传输层接收数据包的过程。将接收数据放入相关队列后，等待接收进程唤醒，在应用层通过read()获取数据。网络层到传输层汇总流程图如下：
<img src="/image/tcp_ip/yVBcfEN4hDTDHUHs.png" alt="输入图片说明"></p>
<p><strong>TCP三次握手</strong>
再来看tcp_v4_do_rcv()的另一种状态，这里我们结合TCP的三次握手来讲。tcp_v4_do_rcv -&gt; tcp_rcv_state_process。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-35-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-35-51">51</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">tcp_rcv_state_process</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb,
</span></span><span style="display:flex;"><span>			  <span style="color:#ff7b72">struct</span> tcphdr <span style="color:#ff7b72;font-weight:bold">*</span>th, <span style="color:#ff7b72">unsigned</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> tcp_sock <span style="color:#ff7b72;font-weight:bold">*</span>tp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> inet_connection_sock <span style="color:#ff7b72;font-weight:bold">*</span>icsk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_csk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> queued <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> res;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rx_opt.saw_tstamp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">switch</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">TCP_CLOSE</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> discard;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">TCP_LISTEN</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>syn) {
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 在sock创建中初始化了icsk-&gt;icsk_af_ops=&amp;ipv4_specific  调用tcp_v4_conn_request*/</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (icsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>icsk_af_ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">conn_request</span>(sk, skb) <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ack) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">int</span> acceptable <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_ack</span>(sk, skb, FLAG_SLOWPATH) <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">switch</span> (sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_state) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 三次握手 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">TCP_SYN_RECV</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (acceptable) {
</span></span><span style="display:flex;"><span>				tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>copied_seq <span style="color:#ff7b72;font-weight:bold">=</span> tp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rcv_nxt;
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">smp_mb</span>();
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">tcp_set_state</span>(sk, TCP_ESTABLISHED);
</span></span><span style="display:flex;"><span>				sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">sk_state_change</span>(sk);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">tcp_mtup_init</span>(sk);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">tcp_initialize_rcv_mss</span>(sk);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">tcp_init_buffer_space</span>(sk);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">tcp_fast_path_on</span>(tp);
</span></span><span style="display:flex;"><span>			} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">TCP_FIN_WAIT1</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">TCP_CLOSING</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">TCP_LAST_ACK</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>第一次握手，服务端接收到客户端发过来的syn消息，调用tcp_v4_conn_request()回复syn+ack消息并将连接请求放到icsk_accept_queue队列中。</p>
<p>第三次握手，服务端收到客户端ack消息，调用tcp_v4_do_rcv -&gt; tcp_v4_hnd_req()，如果icsk_accept_queue队列中存在连接请求，调用tcp_check_req()检查请求并创建连接sock。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-36-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-36-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/ipv4/tcp_ipv4.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#d2a8ff;font-weight:bold">tcp_v4_hnd_req</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> request_sock <span style="color:#ff7b72;font-weight:bold">*</span>req <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_csk_search_req</span>(sk, <span style="color:#ff7b72;font-weight:bold">&amp;</span>prev, th<span style="color:#ff7b72;font-weight:bold">-&gt;</span>source,
</span></span><span style="display:flex;"><span>						       iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>saddr, iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>daddr);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (req)
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 如果请求sock存在 调用接口创建客户端的sock */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">tcp_check_req</span>(sk, skb, req, prev);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在accept()分析时留了一个问题，icsk_accept_queue队列中的数据在什么时候加入呢？现在我们应该有答案了。TCP三次握手汇总流程图如下：
<img src="/image/tcp_ip/wau636HzIiLSg5fY.png" alt="输入图片说明"></p>
<h2 id="数据发送">数据发送</h2>
<p>通常用户测可以使用send/recv、sendto/recvfrom、sendmsg\recvmsg，这三组收发IO在glibc中实现，参考socket实现方式，最终通过系统调用到sys_socketcall中处理。</p>
<p>发送调用路线</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-37-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-37-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>glibc
</span></span><span style="display:flex;"><span>  SYSCALL_DEFINE2(socketcall, int, call, unsigned long __user *, args)
</span></span><span style="display:flex;"><span>    sys_send/sys_sendto/sys_sendmsg
</span></span><span style="display:flex;"><span>      sock_sendmsg
</span></span><span style="display:flex;"><span>        __sock_sendmsg
</span></span><span style="display:flex;"><span>          inet_sendmsg
</span></span><span style="display:flex;"><span>            tcp_sendmsg  //将缓冲区数据放到skb中
</span></span><span style="display:flex;"><span>              __tcp_push_pending_frames
</span></span><span style="display:flex;"><span>                tcp_write_xmit  //从tcp开始组报文头
</span></span><span style="display:flex;"><span>                  tcp_transmit_skb
</span></span></code></pre></td></tr></table>
</div>
</div><p>在tcp_sendmsg()中，负责将发送数据放到发送缓冲区。来看看源码实现：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-1">  1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-2">  2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-3">  3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-4">  4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-5">  5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-6">  6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-7">  7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-8">  8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-9">  9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-10"> 10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-11"> 11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-12"> 12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-13"> 13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-14"> 14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-15"> 15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-16"> 16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-17"> 17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-18"> 18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-19"> 19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-20"> 20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-21"> 21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-22"> 22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-23"> 23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-24"> 24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-25"> 25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-26"> 26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-27"> 27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-28"> 28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-29"> 29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-30"> 30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-31"> 31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-32"> 32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-33"> 33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-34"> 34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-35"> 35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-36"> 36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-37"> 37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-38"> 38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-39"> 39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-40"> 40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-41"> 41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-42"> 42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-43"> 43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-44"> 44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-45"> 45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-46"> 46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-47"> 47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-48"> 48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-49"> 49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-50"> 50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-51"> 51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-52"> 52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-53"> 53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-54"> 54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-55"> 55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-56"> 56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-57"> 57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-58"> 58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-59"> 59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-60"> 60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-61"> 61</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-62"> 62</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-63"> 63</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-64"> 64</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-65"> 65</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-66"> 66</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-67"> 67</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-68"> 68</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-69"> 69</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-70"> 70</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-71"> 71</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-72"> 72</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-73"> 73</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-74"> 74</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-75"> 75</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-76"> 76</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-77"> 77</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-78"> 78</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-79"> 79</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-80"> 80</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-81"> 81</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-82"> 82</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-83"> 83</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-84"> 84</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-85"> 85</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-86"> 86</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-87"> 87</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-88"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-88"> 88</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-89"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-89"> 89</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-90"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-90"> 90</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-91"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-91"> 91</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-92"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-92"> 92</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-93"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-93"> 93</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-94"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-94"> 94</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-95"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-95"> 95</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-96"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-96"> 96</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-97"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-97"> 97</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-98"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-98"> 98</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-99"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-99"> 99</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-100"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-100">100</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-101"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-101">101</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-102"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-102">102</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-103"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-103">103</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-104"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-104">104</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-105"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-105">105</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-106"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-106">106</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-107"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-107">107</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-108"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-108">108</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-109"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-109">109</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-110"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-110">110</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-111"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-111">111</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-112"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-112">112</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-113"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-113">113</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-114"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-114">114</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-115"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-115">115</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-116"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-116">116</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-117"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-117">117</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-118"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-118">118</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-119"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-119">119</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-120"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-120">120</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-121"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-121">121</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-122"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-122">122</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-123"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-123">123</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-124"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-124">124</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-125"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-125">125</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-126"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-126">126</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-127"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-127">127</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-128"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-128">128</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-38-129"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-38-129">129</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>int tcp_sendmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg,
</span></span><span style="display:flex;"><span>		size_t size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	struct iovec *iov;
</span></span><span style="display:flex;"><span>	struct tcp_sock *tp = tcp_sk(sk);
</span></span><span style="display:flex;"><span>	struct sk_buff *skb;
</span></span><span style="display:flex;"><span>	int iovlen, flags;
</span></span><span style="display:flex;"><span>	int mss_now, size_goal;
</span></span><span style="display:flex;"><span>	int sg, err, copied;
</span></span><span style="display:flex;"><span>	long timeo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	lock_sock(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	flags = msg-&gt;msg_flags;
</span></span><span style="display:flex;"><span>	/* 确定超时时间 */
</span></span><span style="display:flex;"><span>	timeo = sock_sndtimeo(sk, flags &amp; MSG_DONTWAIT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* 确定mss大小 */
</span></span><span style="display:flex;"><span>	mss_now = tcp_send_mss(sk, &amp;size_goal, flags);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	while (--iovlen &gt;= 0) {
</span></span><span style="display:flex;"><span>		size_t seglen = iov-&gt;iov_len;
</span></span><span style="display:flex;"><span>		unsigned char __user *from = iov-&gt;iov_base;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		iov++;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		while (seglen &gt; 0) {
</span></span><span style="display:flex;"><span>			int copy = 0;
</span></span><span style="display:flex;"><span>			int max = size_goal;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			/* 获取发送队列中最后一个数据包 */
</span></span><span style="display:flex;"><span>			skb = tcp_write_queue_tail(sk);
</span></span><span style="display:flex;"><span>			if (tcp_send_head(sk)) {
</span></span><span style="display:flex;"><span>				if (skb-&gt;ip_summed == CHECKSUM_NONE)
</span></span><span style="display:flex;"><span>					max = mss_now;
</span></span><span style="display:flex;"><span>				copy = max - skb-&gt;len;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			/* 最后一个包不能添加数据*/
</span></span><span style="display:flex;"><span>			if (copy &lt;= 0) {
</span></span><span style="display:flex;"><span>new_segment:
</span></span><span style="display:flex;"><span>				/* 发送缓存不足就调整等待 */
</span></span><span style="display:flex;"><span>				if (!sk_stream_memory_free(sk))
</span></span><span style="display:flex;"><span>					goto wait_for_sndbuf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				/* 重新安装mss创建skb */
</span></span><span style="display:flex;"><span>				skb = sk_stream_alloc_skb(sk,
</span></span><span style="display:flex;"><span>							  select_size(sk, sg),
</span></span><span style="display:flex;"><span>							  sk-&gt;sk_allocation);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>				/* 将skb加入发送队列 */
</span></span><span style="display:flex;"><span>				skb_entail(sk, skb);
</span></span><span style="display:flex;"><span>				copy = size_goal;
</span></span><span style="display:flex;"><span>				max = size_goal;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>			/* Where to copy to? */
</span></span><span style="display:flex;"><span>			/* 如果是新建的skb  */
</span></span><span style="display:flex;"><span>			if (skb_tailroom(skb) &gt; 0) {
</span></span><span style="display:flex;"><span>				/* We have some space in skb head. Superb! */
</span></span><span style="display:flex;"><span>				if (copy &gt; skb_tailroom(skb))
</span></span><span style="display:flex;"><span>					copy = skb_tailroom(skb);
</span></span><span style="display:flex;"><span>				if ((err = skb_add_data(skb, from, copy)) != 0)
</span></span><span style="display:flex;"><span>					goto do_fault;
</span></span><span style="display:flex;"><span>			} else { //是最后一个skb
</span></span><span style="display:flex;"><span>				int merge = 0;
</span></span><span style="display:flex;"><span>				int i = skb_shinfo(skb)-&gt;nr_frags;  //分散数据块的数量
</span></span><span style="display:flex;"><span>				struct page *page = TCP_PAGE(sk);
</span></span><span style="display:flex;"><span>				int off = TCP_OFF(sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				if (skb_can_coalesce(skb, i, page, off) &amp;&amp; 
</span></span><span style="display:flex;"><span>				    off != PAGE_SIZE) {
</span></span><span style="display:flex;"><span>					/* We can extend the last page
</span></span><span style="display:flex;"><span>					 * fragment. */
</span></span><span style="display:flex;"><span>					merge = 1;
</span></span><span style="display:flex;"><span>				} else if (i == MAX_SKB_FRAGS || !sg) {  //离散数据块没有了
</span></span><span style="display:flex;"><span>					/* Need to add new fragment and cannot
</span></span><span style="display:flex;"><span>					 * do this because interface is non-SG,
</span></span><span style="display:flex;"><span>					 * or because all the page slots are
</span></span><span style="display:flex;"><span>					 * busy. */
</span></span><span style="display:flex;"><span>					tcp_mark_push(tp, skb);
</span></span><span style="display:flex;"><span>					goto new_segment;
</span></span><span style="display:flex;"><span>				} else if (page) {
</span></span><span style="display:flex;"><span>					if (off == PAGE_SIZE) {	//page没有空间了
</span></span><span style="display:flex;"><span>						put_page(page);
</span></span><span style="display:flex;"><span>						TCP_PAGE(sk) = page = NULL;
</span></span><span style="display:flex;"><span>						off = 0;
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				} else
</span></span><span style="display:flex;"><span>					off = 0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				if (copy &gt; PAGE_SIZE - off)
</span></span><span style="display:flex;"><span>					copy = PAGE_SIZE - off;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				if (!sk_wmem_schedule(sk, copy))
</span></span><span style="display:flex;"><span>					goto wait_for_memory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				/* 4 page用完 重新申请 */
</span></span><span style="display:flex;"><span>				if (!page) {
</span></span><span style="display:flex;"><span>					/* Allocate new cache page. */
</span></span><span style="display:flex;"><span>					if (!(page = sk_stream_alloc_page(sk)))
</span></span><span style="display:flex;"><span>						goto wait_for_memory;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				err = skb_copy_to_page(sk, from, skb, page,
</span></span><span style="display:flex;"><span>						       off, copy);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>			/* 发送多个包 */
</span></span><span style="display:flex;"><span>			if (forced_push(tp)) {
</span></span><span style="display:flex;"><span>				tcp_mark_push(tp, skb);
</span></span><span style="display:flex;"><span>				/* 发送数据包 */
</span></span><span style="display:flex;"><span>				__tcp_push_pending_frames(sk, mss_now, TCP_NAGLE_PUSH);
</span></span><span style="display:flex;"><span>			/* 发送一个包 */
</span></span><span style="display:flex;"><span>			} else if (skb == tcp_send_head(sk))
</span></span><span style="display:flex;"><span>				tcp_push_one(sk, mss_now);
</span></span><span style="display:flex;"><span>			continue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wait_for_sndbuf:
</span></span><span style="display:flex;"><span>			set_bit(SOCK_NOSPACE, &amp;sk-&gt;sk_socket-&gt;flags);
</span></span><span style="display:flex;"><span>wait_for_memory:
</span></span><span style="display:flex;"><span>			if (copied)
</span></span><span style="display:flex;"><span>				tcp_push(sk, flags &amp; ~MSG_MORE, mss_now, TCP_NAGLE_PUSH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			if ((err = sk_stream_wait_memory(sk, &amp;timeo)) != 0)
</span></span><span style="display:flex;"><span>				goto do_error;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			mss_now = tcp_send_mss(sk, &amp;size_goal, flags);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数首先计算mss大小，mss表示传输层允许发送的最大字节长度，mss常用的计算公式：mss=mtu-tcp头-ip头，其中mtu表示网络报文在IP层的最大长度。在tcp3次握手过程中，client与server都会计算并告知自己的mss大小，最终以双方最小的mss值传输数据。</p>
<p>接着是两层while循环，第一层负责循环将数据从msg中取出，第二层首先从sk_write_queue队列中取出最后一个skb数据包，有两种处理情况。</p>
<p>第一种情况：skb数据包还有剩余空间存放，将发送数据放到skb指向的skb_shared_info，减少了内存拷贝。skb结构如下图所示：
<img src="/image/tcp_ip/InX0lGwTA11DwJws.png" alt="输入图片说明"></p>
<p>第二种情况：skb数据包没有多余空间，调用sk_stream_alloc_skb()创建一个新的sbk结构存放数据。</p>
<p>最后如果有多个包准备发送调用__tcp_push_pending_frames()，单包发送调用tcp_push_one，他们最后都调用tcp_write_xmit()发送。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-39-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-39-57">57</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">tcp_write_xmit</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> mss_now, <span style="color:#ff7b72">int</span> nonagle,
</span></span><span style="display:flex;"><span>			  <span style="color:#ff7b72">int</span> push_one, <span style="color:#ff7b72">gfp_t</span> gfp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> tcp_sock <span style="color:#ff7b72;font-weight:bold">*</span>tp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> tso_segs, sent_pkts;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> cwnd_quota;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> result;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">while</span> ((skb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_send_head</span>(sk))) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> limit;
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 判断是否设置了分段 skb_shared_info.gso_seg*/</span>
</span></span><span style="display:flex;"><span>		tso_segs <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_init_tso_segs</span>(sk, skb, mss_now);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">BUG_ON</span>(<span style="color:#ff7b72;font-weight:bold">!</span>tso_segs);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 计算拥塞窗口大小 发送窗口-网络中需要发送的数据包 */</span>
</span></span><span style="display:flex;"><span>		cwnd_quota <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_cwnd_test</span>(tp, skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>cwnd_quota)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 比较接收窗口与当前end_seq,如果不在接收范围 立刻退出 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">unlikely</span>(<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">tcp_snd_wnd_test</span>(tp, skb, mss_now)))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (tso_segs <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">1</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">unlikely</span>(<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">tcp_nagle_test</span>(tp, skb, mss_now,
</span></span><span style="display:flex;"><span>						     (<span style="color:#d2a8ff;font-weight:bold">tcp_skb_is_last</span>(sk, skb) <span style="color:#ff7b72;font-weight:bold">?</span>
</span></span><span style="display:flex;"><span>						      <span style="color:#79c0ff;font-weight:bold">nonagle</span> : TCP_NAGLE_PUSH))))
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>		} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 判断延时发送 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>push_one <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#d2a8ff;font-weight:bold">tcp_tso_should_defer</span>(sk, skb))
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 确定每包发送限制长度 */</span>
</span></span><span style="display:flex;"><span>		limit <span style="color:#ff7b72;font-weight:bold">=</span> mss_now;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (tso_segs <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">1</span> <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">tcp_urg_mode</span>(tp))
</span></span><span style="display:flex;"><span>			limit <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">tcp_mss_split_point</span>(sk, skb, mss_now,
</span></span><span style="display:flex;"><span>						    cwnd_quota);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 数据包分段 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len <span style="color:#ff7b72;font-weight:bold">&gt;</span> limit <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#d2a8ff;font-weight:bold">unlikely</span>(<span style="color:#d2a8ff;font-weight:bold">tso_fragment</span>(sk, skb, limit, mss_now, gfp)))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">TCP_SKB_CB</span>(skb)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>when <span style="color:#ff7b72;font-weight:bold">=</span> tcp_time_stamp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 开始发送 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">unlikely</span>(<span style="color:#d2a8ff;font-weight:bold">tcp_transmit_skb</span>(sk, skb, <span style="color:#a5d6ff">1</span>, gfp)))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 取下一个包 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">tcp_event_new_data_sent</span>(sk, skb);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcp_write_xmit()从sk_write_queue队列循环取出skb，在while循环中依次对skb包判断是否分段处理、计算拥塞窗口大小、发送窗口大小等，然后调用tcp_transmit_skb发送数据包。下面介绍几个算法概念：</p>
<p>第一个概念是 TSO（TCP Segmentation Offload）。如果发送的网络包非常大，就像上面说的一样，要进行分段。分段这个事情可以由协议栈代码在内核做，但是缺点是比较费 CPU，另一种方式是延迟到硬件网卡去做，需要网卡支持对大数据包进行自动分段，可以降低 CPU 负载</p>
<p>函数在tcp_init_tso_segs()中计算将skb分为几个段。tso_fragment()分段有两种情况，数据块在连续内存区域，调用tcp_fragment()，将基本数据块按指定长度分段，超出部分转移到新skb中。如果离散区也存在数据，则调用skb_split()，将离散数据加到基本数据块中，超出部分转移到新skb上。</p>
<p>第二个概念是拥塞窗口的概念（cwnd，congestion window），也就是说为了避免拼命发包，把网络塞满了，定义一个窗口的概念，在这个窗口之内的才能发送，超过这个窗口的就不能发送，来控制发送的频率。</p>
<p>拥塞窗口是动态变化的，主要分四个阶段，如下图所示：
<img src="/image/tcp_ip/Q9mXgxeBR3V5fv7D.png" alt="输入图片说明"></p>
<p>慢启动：
初始时tp-&gt;snd_cwnd = 2，每经过一个RTT，cwnd指数增长，虽然叫慢启动，但是我们看到并不慢。那会无线增长么？当然不会，存在一个极限值ssthresh，一旦达到这个值就进入下一阶段。</p>
<p>拥塞避免：
cwnd超过ssthresh后，增长速度开始变慢，每过一个RTT cwnd+1，这样就可以避免增长过快导致网络拥塞，慢慢的增加调整到网络的最佳值。很明显，是一个线性上升的算法。</p>
<p>拥塞发生：
发生超时丢包、重传时，Fast Retransmit算法，也就是在收到3个duplicate ACK时就开启重传，而不用等到RTO超时。cwnd = cwnd /2，cwnd = cwnd /2并进到快速回复算法。</p>
<p>快速恢复：
这个算法定义在RFC5681。快速重传和快速恢复算法一般同时使用。快速恢复算法是认为，你还有3个Duplicated Acks说明网络也不那么糟糕，所以没有必要像RTO超时那么强烈。 注意，正如前面所说，进入Fast Recovery之前，cwnd 和 sshthresh已被更新。重发快重传阶段cwnd的变化，快重传阶段cwnd的变化，如果收到了新的Ack，那么，cwnd = sshthresh ，然后就进入了拥塞避免的算法了。</p>
<p>第三个概念就是接收窗口rwnd 的概念（receive window），也叫滑动窗口。如果说拥塞窗口是为了怕把网络塞满，在出现丢包的时候减少发送速度，那么滑动窗口就是为了怕把接收方塞满，而控制发送速度。</p>
<p>TCP头里有一个字段叫Window，又叫Advertised-Window，这个字段是接收端告诉发送端自己还有多少缓冲区可以接收数据。函数调用tcp_snd_wnd_test()比较tp-&gt;snd_wnd与skb-&gt;end_seq判断发送数据是否在接收窗口范围。</p>
<p>算法执行完成后，调用tcp_transmit_skb()发送数据包。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-57">57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-40-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-40-58">58</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>static int tcp_transmit_skb(struct sock *sk, struct sk_buff *skb, int clone_it,
</span></span><span style="display:flex;"><span>			    gfp_t gfp_mask)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	const struct inet_connection_sock *icsk = inet_csk(sk);
</span></span><span style="display:flex;"><span>	struct inet_sock *inet;
</span></span><span style="display:flex;"><span>	struct tcp_sock *tp;
</span></span><span style="display:flex;"><span>	struct tcp_skb_cb *tcb;
</span></span><span style="display:flex;"><span>	struct tcp_out_options opts;
</span></span><span style="display:flex;"><span>	unsigned tcp_options_size, tcp_header_size;
</span></span><span style="display:flex;"><span>	struct tcp_md5sig_key *md5;
</span></span><span style="display:flex;"><span>	struct tcphdr *th;
</span></span><span style="display:flex;"><span>	int err;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	/* skb.date数据块开辟tcp头 skb.date 下移*/
</span></span><span style="display:flex;"><span>	skb_push(skb, tcp_header_size);
</span></span><span style="display:flex;"><span>	/* skb_reset_transport_header */
</span></span><span style="display:flex;"><span>	skb_reset_transport_header(skb);
</span></span><span style="display:flex;"><span>	/* skb.sk = sk */
</span></span><span style="display:flex;"><span>	skb_set_owner_w(skb, sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* skb_transport_header(skb) */
</span></span><span style="display:flex;"><span>	th = tcp_hdr(skb);
</span></span><span style="display:flex;"><span>	th-&gt;source		= inet-&gt;inet_sport;
</span></span><span style="display:flex;"><span>	th-&gt;dest		= inet-&gt;inet_dport;
</span></span><span style="display:flex;"><span>	th-&gt;seq			= htonl(tcb-&gt;seq);
</span></span><span style="display:flex;"><span>	th-&gt;ack_seq		= htonl(tp-&gt;rcv_nxt);
</span></span><span style="display:flex;"><span>	*(((__be16 *)th) + 6)	= htons(((tcp_header_size &gt;&gt; 2) &lt;&lt; 12) |
</span></span><span style="display:flex;"><span>					tcb-&gt;flags);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	if (unlikely(tcb-&gt;flags &amp; TCPHDR_SYN)) {
</span></span><span style="display:flex;"><span>		th-&gt;window	= htons(min(tp-&gt;rcv_wnd, 65535U));
</span></span><span style="display:flex;"><span>	} else {
</span></span><span style="display:flex;"><span>		th-&gt;window	= htons(tcp_select_window(sk));
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	th-&gt;check		= 0;
</span></span><span style="display:flex;"><span>	th-&gt;urg_ptr		= 0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* The urg_mode check is necessary during a below snd_una win probe */
</span></span><span style="display:flex;"><span>	if (unlikely(tcp_urg_mode(tp) &amp;&amp; before(tcb-&gt;seq, tp-&gt;snd_up))) {
</span></span><span style="display:flex;"><span>		if (before(tp-&gt;snd_up, tcb-&gt;seq + 0x10000)) {
</span></span><span style="display:flex;"><span>			th-&gt;urg_ptr = htons(tp-&gt;snd_up - tcb-&gt;seq);
</span></span><span style="display:flex;"><span>			th-&gt;urg = 1;
</span></span><span style="display:flex;"><span>		} else if (after(tcb-&gt;seq + 0xFFFF, tp-&gt;snd_nxt)) {
</span></span><span style="display:flex;"><span>			th-&gt;urg_ptr = htons(0xFFFF);
</span></span><span style="display:flex;"><span>			th-&gt;urg = 1;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	/* 调用链接表中的发送函数ip_queue_xmit 走到IP层 */
</span></span><span style="display:flex;"><span>	err = icsk-&gt;icsk_af_ops-&gt;queue_xmit(skb);
</span></span><span style="display:flex;"><span>	if (likely(err &lt;= 0))
</span></span><span style="display:flex;"><span>		return err;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	/* 计算慢启动阈值 */
</span></span><span style="display:flex;"><span>	tcp_enter_cwr(sk, 1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	return net_xmit_eval(err);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tcp_transmit_skb()完成两件事，添加TCP头和进入到IP层组包。TCP报文有如下定义：
<img src="/image/tcp_ip/7JJ0pBCBMJr1IzRz.png" alt="输入图片说明"></p>
<p>TCP报头占20字节(不含option字段)，用tcphdr结构体表示，填充完后调用ip_queue_xmit进入IP层。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-41-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-41-57">57</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">ip_queue_xmit</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk <span style="color:#ff7b72;font-weight:bold">=</span> skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> inet_sock <span style="color:#ff7b72;font-weight:bold">*</span>inet <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> ip_options <span style="color:#ff7b72;font-weight:bold">*</span>opt <span style="color:#ff7b72;font-weight:bold">=</span> inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>opt;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span>rt;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> iphdr <span style="color:#ff7b72;font-weight:bold">*</span>iph;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> res;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_read_lock</span>();
</span></span><span style="display:flex;"><span>	rt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_rtable</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (rt <span style="color:#ff7b72;font-weight:bold">!=</span> NULL)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> packet_routed;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Make sure we can route this packet. */</span>
</span></span><span style="display:flex;"><span>	rt <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span>)<span style="color:#d2a8ff;font-weight:bold">__sk_dst_check</span>(sk, <span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (rt <span style="color:#ff7b72;font-weight:bold">==</span> NULL) {
</span></span><span style="display:flex;"><span>		__be32 daddr;
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 查找路由并创建路由项 */</span>
</span></span><span style="display:flex;"><span>		rt <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_route_output_ports</span>(<span style="color:#d2a8ff;font-weight:bold">sock_net</span>(sk), sk,
</span></span><span style="display:flex;"><span>					   daddr, inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_saddr,
</span></span><span style="display:flex;"><span>					   inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_dport,
</span></span><span style="display:flex;"><span>					   inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>inet_sport,
</span></span><span style="display:flex;"><span>					   sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_protocol,
</span></span><span style="display:flex;"><span>					   <span style="color:#d2a8ff;font-weight:bold">RT_CONN_FLAGS</span>(sk),
</span></span><span style="display:flex;"><span>					   sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_bound_dev_if);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">IS_ERR</span>(rt))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> no_route;
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">sk_setup_caps</span>(sk, <span style="color:#ff7b72;font-weight:bold">&amp;</span>rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">skb_dst_set_noref</span>(skb, <span style="color:#ff7b72;font-weight:bold">&amp;</span>rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">packet_routed</span>:
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">skb_push</span>(skb, <span style="color:#ff7b72">sizeof</span>(<span style="color:#ff7b72">struct</span> iphdr) <span style="color:#ff7b72;font-weight:bold">+</span> (opt <span style="color:#ff7b72;font-weight:bold">?</span> opt<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#79c0ff;font-weight:bold">optlen</span> : <span style="color:#a5d6ff">0</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">skb_reset_network_header</span>(skb);
</span></span><span style="display:flex;"><span>	iph <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_hdr</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72;font-weight:bold">*</span>((__be16 <span style="color:#ff7b72;font-weight:bold">*</span>)iph) <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">htons</span>((<span style="color:#a5d6ff">4</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> <span style="color:#a5d6ff">12</span>) <span style="color:#ff7b72;font-weight:bold">|</span> (<span style="color:#a5d6ff">5</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> <span style="color:#a5d6ff">8</span>) <span style="color:#ff7b72;font-weight:bold">|</span> (inet<span style="color:#ff7b72;font-weight:bold">-&gt;</span>tos <span style="color:#ff7b72;font-weight:bold">&amp;</span> <span style="color:#a5d6ff">0xff</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">ip_dont_fragment</span>(sk, <span style="color:#ff7b72;font-weight:bold">&amp;</span>rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst) <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span>skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>local_df)
</span></span><span style="display:flex;"><span>		iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>frag_off <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">htons</span>(IP_DF);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>		iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>frag_off <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ttl      <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_select_ttl</span>(inet, <span style="color:#ff7b72;font-weight:bold">&amp;</span>rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst);
</span></span><span style="display:flex;"><span>	iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>protocol <span style="color:#ff7b72;font-weight:bold">=</span> sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_protocol;
</span></span><span style="display:flex;"><span>	iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>saddr    <span style="color:#ff7b72;font-weight:bold">=</span> rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_src;
</span></span><span style="display:flex;"><span>	iph<span style="color:#ff7b72;font-weight:bold">-&gt;</span>daddr    <span style="color:#ff7b72;font-weight:bold">=</span> rt<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_dst;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	res <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ip_local_out</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_read_unlock</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> res;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">no_route</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_read_unlock</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">IP_INC_STATS</span>(<span style="color:#d2a8ff;font-weight:bold">sock_net</span>(sk), IPSTATS_MIB_OUTNOROUTES);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">kfree_skb</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>EHOSTUNREACH;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ip_queue_xmit()可以划分成三部分工作，首先调用__sk_dst_check -&gt; ipv4_dst_check检查路由项是否过期或有新增路由，如果检查不通过，调用ip_route_output_ports -&gt;ip_route_output_flow -&gt; __ip_route_output_key -&gt; ip_route_output_slow -&gt; __mkroute_output()创建路由项</p>
<p>第二部分函数进入packet_routed，填充IP报头信息到skb缓冲，IP报头用iphdr表示，IP报文信息如下所示：
<img src="/image/tcp_ip/ivzL4pHl2W5UACVN.png" alt="输入图片说明"></p>
<p>第三部分进入ip_local_out -&gt; ip_output -&gt;ip_finish_output -&gt; ip_finish_output2</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-42-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-42-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">inline</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">ip_finish_output2</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 判断是否缓存了数据链路层的发送设备mac信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hh)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">neigh_hh_output</span>(dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hh, skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>neighbour)
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 没有缓存调用neigh_resolve_output 在neight_hh_init初始化 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>neighbour<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">output</span>(skb);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果路由项中缓存了发送设备的mac信息，调用neigh_hh_output -&gt; dev_queue_xmit。
如果没有，则使用arp广播探测发送端的mac地址信息，调用neigh_resolve_output -&gt; neigh_timer_handler -&gt; arp_solicit()。这里neigh_resolve_output()的实现我们在邻居子系统中了解。</p>
<p>最后调用neigh_resolve_output -&gt; dev_queue_xmit()将数据包发送到物理网卡。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-43-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-43-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">dev_queue_xmit</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev <span style="color:#ff7b72;font-weight:bold">=</span> skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> netdev_queue <span style="color:#ff7b72;font-weight:bold">*</span>txq;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> Qdisc <span style="color:#ff7b72;font-weight:bold">*</span>q;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> rc <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	txq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">dev_pick_tx</span>(dev, skb);
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 获取设备结构中的排队规则 */</span>
</span></span><span style="display:flex;"><span>	q <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference_bh</span>(txq<span style="color:#ff7b72;font-weight:bold">-&gt;</span>qdisc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 指定了入队函数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>enqueue) {
</span></span><span style="display:flex;"><span>		rc <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__dev_xmit_skb</span>(skb, q, dev, txq);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>网络设备有一个Qdisc结构，用于存放内核中的待发送的数据报文，驱动层负责从这个队列中取出报文并发给设备。我们可以用ip addr查看网络设备的队列结构：
<img src="/image/tcp_ip/6RocYgKqgdayucbK.png" alt="输入图片说明"></p>
<p>disc 全称是 queueing discipline，中文叫排队规则。内核如果需要通过某个网络接口发送数据包，都需要按照为这个接口配置的 qdisc（排队规则）把数据包加入队列。</p>
<p>最简单的 qdisc 是 pfifo，它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。pfifo_fast 稍微复杂一些，它的队列包括三个波段（band）。在每个波段里面，使用先进先出规则。</p>
<p>三个波段的优先级也不相同。band 0 的优先级最高，band 2 的最低。如果 band 0 里面有数据包，系统就不会处理 band 1 里面的数据包，band 1 和 band 2 之间也是一样。</p>
<p>数据包是按照服务类型（Type of Service，TOS）被分配到三个波段里面的。TOS 是 IP 头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的。</p>
<p>__dev_xmit_skb()将数据报放到网络设备的队列中，调用__qdisc_run()处理队列中数据。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-44-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-44-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">__qdisc_run</span>(<span style="color:#ff7b72">struct</span> Qdisc <span style="color:#ff7b72;font-weight:bold">*</span>q)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> start_time <span style="color:#ff7b72;font-weight:bold">=</span> jiffies;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">while</span> (<span style="color:#d2a8ff;font-weight:bold">qdisc_restart</span>(q)) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">need_resched</span>() <span style="color:#ff7b72;font-weight:bold">||</span> jiffies <span style="color:#ff7b72;font-weight:bold">!=</span> start_time) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">__netif_schedule</span>(q);
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">qdisc_run_end</span>(q);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>__netif_schedule()调度进入软中断，执行发送处理函数net_tx_action -&gt; __qdisc_run -&gt; qdisc_restart()。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-45-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-45-19">19</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/sched/sch_generic.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">inline</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">qdisc_restart</span>(<span style="color:#ff7b72">struct</span> Qdisc <span style="color:#ff7b72;font-weight:bold">*</span>q)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> netdev_queue <span style="color:#ff7b72;font-weight:bold">*</span>txq;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">spinlock_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>root_lock;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Dequeue packet */</span>
</span></span><span style="display:flex;"><span>	skb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">dequeue_skb</span>(q);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">unlikely</span>(<span style="color:#ff7b72;font-weight:bold">!</span>skb))
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">WARN_ON_ONCE</span>(<span style="color:#d2a8ff;font-weight:bold">skb_dst_is_noref</span>(skb));
</span></span><span style="display:flex;"><span>	root_lock <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">qdisc_lock</span>(q);
</span></span><span style="display:flex;"><span>	dev <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">qdisc_dev</span>(q);
</span></span><span style="display:flex;"><span>	txq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">netdev_get_tx_queue</span>(dev, <span style="color:#d2a8ff;font-weight:bold">skb_get_queue_mapping</span>(skb));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">sch_direct_xmit</span>(skb, q, dev, txq, root_lock);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>sch_direct_xmit -&gt; dev_hard_start_xmit()</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-46-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-46-26">26</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">dev_hard_start_xmit</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb, <span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev,
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">struct</span> netdev_queue <span style="color:#ff7b72;font-weight:bold">*</span>txq)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">struct</span> net_device_ops <span style="color:#ff7b72;font-weight:bold">*</span>ops <span style="color:#ff7b72;font-weight:bold">=</span> dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>netdev_ops;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> rc <span style="color:#ff7b72;font-weight:bold">=</span> NETDEV_TX_OK;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 分段发送 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">netif_needs_gso</span>(skb, features)) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">unlikely</span>(<span style="color:#d2a8ff;font-weight:bold">dev_gso_segment</span>(skb, features)))
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">goto</span> out_kfree_skb;
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next)
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">goto</span> gso;
</span></span><span style="display:flex;"><span>		} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">skb_needs_linearize</span>(skb, features) <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>			    <span style="color:#d2a8ff;font-weight:bold">__skb_linearize</span>(skb))
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">goto</span> out_kfree_skb;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 走网卡注册的dm9000_start_xmit等发送函数*/</span>
</span></span><span style="display:flex;"><span>		rc <span style="color:#ff7b72;font-weight:bold">=</span> ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">ndo_start_xmit</span>(skb, dev);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">trace_net_dev_xmit</span>(skb, rc);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (rc <span style="color:#ff7b72;font-weight:bold">==</span> NETDEV_TX_OK)
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">txq_trans_update</span>(txq);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> rc;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>dev_hard_start_xmit()先判断skb报是否需要分段发送，根据skb_shared_info.gso_seg标志判断。然后走到驱动层调用ndo_start_xmit()发送到网络设备中。到这里，协议栈的发送就结束了。下面是发送报文的流程图：
<img src="/image/tcp_ip/cDVnsta3bjivMD70.png" alt="输入图片说明"></p>
<h2 id="邻居子系统">邻居子系统</h2>
<p>计算机领域,我们认为在同一局域网下的终端设备互为邻居关系。在 Linux 中,邻居子系统为 IP 网络层与链路层提供了地址转换关系,也就是说它指明了 IP 地址向 MAC 地址的转换关系,这就不得不提及ARP 协议，它就是一种邻居协议。下面来看看linux系统中邻居子系统的源码实现。</p>
<h3 id="初始化">初始化</h3>
<p>邻居子系统在inet_init -&gt; arp_init()中初始化</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-47-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-47-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">void</span> __init <span style="color:#d2a8ff;font-weight:bold">arp_init</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始化neigh_tables = arp_tbl */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">neigh_table_init</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_tbl);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 新增arp报文处理流程 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">dev_add_pack</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_packet_type);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">arp_proc_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">register_netdevice_notifier</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_netdev_notifier);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数中arp_tbl是一个全局变量，在neigh_table_init()中初始化并赋值给neigh_tables。接着调用dev_add_pack()注册arp报文的处理流程，如果网络设备收到arp包，则走arp_rcv，流程如下：
<img src="/image/tcp_ip/ovagjC1JnjB0KsyV.png" alt="输入图片说明"></p>
<p>最后调用register_netdevice_notifier()注册设备通知消息，如果网络设备IP地址发生改变，需通知子系统修改路由的邻居缓存。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-48-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-48-21">21</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/ipv4/arp.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">struct</span> notifier_block arp_netdev_notifier <span style="color:#ff7b72;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>	.notifier_call <span style="color:#ff7b72;font-weight:bold">=</span> arp_netdev_event,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">arp_netdev_event</span>(<span style="color:#ff7b72">struct</span> notifier_block <span style="color:#ff7b72;font-weight:bold">*</span>this, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> event,
</span></span><span style="display:flex;"><span>			    <span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span>ptr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev <span style="color:#ff7b72;font-weight:bold">=</span> ptr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">switch</span> (event) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">case</span> <span style="color:#79c0ff;font-weight:bold">NETDEV_CHANGEADDR</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">neigh_changeaddr</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_tbl, dev);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">rt_cache_flush</span>(<span style="color:#d2a8ff;font-weight:bold">dev_net</span>(dev), <span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">default</span><span style="color:#ff7b72;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> NOTIFY_DONE;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="邻居探测">邻居探测</h3>
<p>邻居探测是在数据报文发送过程的查找路由阶段完成，回到路由项创建的调用链：
ip_queue_xmit -&gt; ip_route_output_ports -&gt; ip_route_output_flow -&gt; __ip_route_output_key -&gt; ip_route_output_slow -&gt; rt_intern_hash -&gt; arp_bind_neighbour</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-49-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-49-19">19</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/ipv4/arp.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">arp_bind_neighbour</span>(<span style="color:#ff7b72">struct</span> dst_entry <span style="color:#ff7b72;font-weight:bold">*</span>dst)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev <span style="color:#ff7b72;font-weight:bold">=</span> dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>n <span style="color:#ff7b72;font-weight:bold">=</span> dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>neighbour;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (n <span style="color:#ff7b72;font-weight:bold">==</span> NULL) {
</span></span><span style="display:flex;"><span>		__be32 nexthop <span style="color:#ff7b72;font-weight:bold">=</span> ((<span style="color:#ff7b72">struct</span> rtable <span style="color:#ff7b72;font-weight:bold">*</span>)dst)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rt_gateway;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> (IFF_LOOPBACK <span style="color:#ff7b72;font-weight:bold">|</span> IFF_POINTOPOINT))
</span></span><span style="display:flex;"><span>			nexthop <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 对新建的路由项查找邻居结构 以网关地址或者下一跳目标IP为key 查找neighbour结构 */</span>
</span></span><span style="display:flex;"><span>		n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__neigh_lookup_errno</span>(
</span></span><span style="display:flex;"><span>					 <span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_tbl, <span style="color:#ff7b72;font-weight:bold">&amp;</span>nexthop, dev);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">IS_ERR</span>(n))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">PTR_ERR</span>(n);
</span></span><span style="display:flex;"><span>		dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>neighbour <span style="color:#ff7b72;font-weight:bold">=</span> n;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>__neigh_lookup_errno()函数根据子系统初始化的arp_tbl结构，查找路由结构，未找到则创建一个新的neighbour结构并赋值给dst-&gt;neighbour。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-50-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-50-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/include/net/neighbour.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">inline</span> <span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">__neigh_lookup_errno</span>(<span style="color:#ff7b72">struct</span> neigh_table <span style="color:#ff7b72;font-weight:bold">*</span>tbl, <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span>pkey,
</span></span><span style="display:flex;"><span>  <span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">neigh_lookup</span>(tbl, pkey, dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (n)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 没找直接创建新的neighbour */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">neigh_create</span>(tbl, pkey, dev);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>neigh_lookup()从neigh_table.nht.hash_buckets哈希桶中取出neighbour结构，哈希桶采用链式存储所有neighbour结构。neighbour.primary_key与传入的目的地址比较，相同表示找了邻居。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-51-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-51-28">28</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/include/net/neighbour.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#d2a8ff;font-weight:bold">neigh_lookup</span>(<span style="color:#ff7b72">struct</span> neigh_table <span style="color:#ff7b72;font-weight:bold">*</span>tbl, <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span>pkey,
</span></span><span style="display:flex;"><span>			       <span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>n;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> key_len <span style="color:#ff7b72;font-weight:bold">=</span> tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>key_len;
</span></span><span style="display:flex;"><span>	u32 hash_val;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> neigh_hash_table <span style="color:#ff7b72;font-weight:bold">*</span>nht;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	nht <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference_bh</span>(tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nht);
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 根据网卡设备和传入目的地址计算哈希值*/</span>
</span></span><span style="display:flex;"><span>	hash_val <span style="color:#ff7b72;font-weight:bold">=</span> tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">hash</span>(pkey, dev, nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_rnd) <span style="color:#ff7b72;font-weight:bold">&amp;</span> nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_mask;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 从tbl-&gt;nht-&gt;hash_buckets哈希捅中找邻居结构 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">for</span> (n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference_bh</span>(nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_buckets[hash_val]);
</span></span><span style="display:flex;"><span>	     n <span style="color:#ff7b72;font-weight:bold">!=</span> NULL;
</span></span><span style="display:flex;"><span>	     n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference_bh</span>(n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next)) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (dev <span style="color:#ff7b72;font-weight:bold">==</span> n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">memcmp</span>(n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>primary_key, pkey, key_len)) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">atomic_inc_not_zero</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>refcnt))
</span></span><span style="display:flex;"><span>				n <span style="color:#ff7b72;font-weight:bold">=</span> NULL;
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">NEIGH_CACHE_STAT_INC</span>(tbl, hits);
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_read_unlock_bh</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> n;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>没找到邻居结构，说明系统中还没有改目的ip对应的mac信息，调用neigh_create()为目标IP地址新建neighbour，并将新建的邻居结构存到neigh_table.nht.hash_buckets哈希桶中。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-52-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-52-39">39</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/core/neighbour.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#d2a8ff;font-weight:bold">neigh_create</span>(<span style="color:#ff7b72">struct</span> neigh_table <span style="color:#ff7b72;font-weight:bold">*</span>tbl, <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span>pkey,
</span></span><span style="display:flex;"><span>			       <span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	u32 hash_val;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> key_len <span style="color:#ff7b72;font-weight:bold">=</span> tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>key_len;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> error;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>n1, <span style="color:#ff7b72;font-weight:bold">*</span>rc, <span style="color:#ff7b72;font-weight:bold">*</span>n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">neigh_alloc</span>(tbl);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> neigh_hash_table <span style="color:#ff7b72;font-weight:bold">*</span>nht;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 调用neigh_table.constructor设置邻居结构的output指向 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>constructor <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>	(error <span style="color:#ff7b72;font-weight:bold">=</span> tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">constructor</span>(n)) <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>		rc <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ERR_PTR</span>(error);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out_neigh_release;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	hash_val <span style="color:#ff7b72;font-weight:bold">=</span> tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">hash</span>(pkey, dev, nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_rnd) <span style="color:#ff7b72;font-weight:bold">&amp;</span> nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_mask;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">for</span> (n1 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference_protected</span>(nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_buckets[hash_val],
</span></span><span style="display:flex;"><span>					    <span style="color:#d2a8ff;font-weight:bold">lockdep_is_held</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>lock));
</span></span><span style="display:flex;"><span>	     n1 <span style="color:#ff7b72;font-weight:bold">!=</span> NULL;
</span></span><span style="display:flex;"><span>	     n1 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">rcu_dereference_protected</span>(n1<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next,
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">lockdep_is_held</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>lock))) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (dev <span style="color:#ff7b72;font-weight:bold">==</span> n1<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">memcmp</span>(n1<span style="color:#ff7b72;font-weight:bold">-&gt;</span>primary_key, pkey, key_len)) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">neigh_hold</span>(n1);
</span></span><span style="display:flex;"><span>			rc <span style="color:#ff7b72;font-weight:bold">=</span> n1;
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out_tbl_unlock;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dead <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">neigh_hold</span>(n);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_assign_pointer</span>(n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next,
</span></span><span style="display:flex;"><span>			   <span style="color:#d2a8ff;font-weight:bold">rcu_dereference_protected</span>(nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_buckets[hash_val],
</span></span><span style="display:flex;"><span>						     <span style="color:#d2a8ff;font-weight:bold">lockdep_is_held</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>lock)));
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 将邻居结构加到hash_buckets中 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_assign_pointer</span>(nht<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hash_buckets[hash_val], n);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>neigh_alloc()中创建并初始化了neighbour结构，这里也初始化了一个定时器并绑定了定时处理函数，用于定时发送arp_queue队列中的arp请求报文。neighbour的状态初始化为<strong>NUD_NONE</strong>。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-53-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-53-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#d2a8ff;font-weight:bold">neigh_alloc</span>(<span style="color:#ff7b72">struct</span> neigh_table <span style="color:#ff7b72;font-weight:bold">*</span>tbl)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">kmem_cache_zalloc</span>(tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>kmem_cachep, GFP_ATOMIC);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">skb_queue_head_init</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>arp_queue);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rwlock_init</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">seqlock_init</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ha_lock);
</span></span><span style="display:flex;"><span>	n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>updated	  <span style="color:#ff7b72;font-weight:bold">=</span> n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>used <span style="color:#ff7b72;font-weight:bold">=</span> now;
</span></span><span style="display:flex;"><span>	n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state	  <span style="color:#ff7b72;font-weight:bold">=</span> NUD_NONE;
</span></span><span style="display:flex;"><span>	n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>output	  <span style="color:#ff7b72;font-weight:bold">=</span> neigh_blackhole;
</span></span><span style="display:flex;"><span>	n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>parms	  <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">neigh_parms_clone</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tbl<span style="color:#ff7b72;font-weight:bold">-&gt;</span>parms);
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始定时器，在arp发送需要用到 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">setup_timer</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>n<span style="color:#ff7b72;font-weight:bold">-&gt;</span>timer, neigh_timer_handler, (<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span>)n);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>tbl-&gt;constructor(n)重构了n-&gt;output的指向，为数据链路层的报文指明了去向。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-54-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-54-30">30</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>tatic <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">arp_constructor</span>(<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>neigh)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>type <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">inet_addr_type</span>(<span style="color:#d2a8ff;font-weight:bold">dev_net</span>(dev), addr);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>type <span style="color:#ff7b72;font-weight:bold">==</span> RTN_MULTICAST) {
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state <span style="color:#ff7b72;font-weight:bold">=</span> NUD_NOARP;
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">arp_mc_map</span>(addr, neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ha, dev, <span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span>		} <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> (IFF_NOARP <span style="color:#ff7b72;font-weight:bold">|</span> IFF_LOOPBACK)) {
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state <span style="color:#ff7b72;font-weight:bold">=</span> NUD_NOARP;
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ha, dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev_addr, dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>addr_len);
</span></span><span style="display:flex;"><span>		} <span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>type <span style="color:#ff7b72;font-weight:bold">==</span> RTN_BROADCAST <span style="color:#ff7b72;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>			   (dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> IFF_POINTOPOINT)) {
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state <span style="color:#ff7b72;font-weight:bold">=</span> NUD_NOARP;
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ha, dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>broadcast, dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>addr_len);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 根据网卡驱动是否提供了cache功能 如eth.c中定义 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>header_ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span>cache)
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_hh_ops;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_generic_ops;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state <span style="color:#ff7b72;font-weight:bold">&amp;</span> NUD_VALID)
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>output <span style="color:#ff7b72;font-weight:bold">=</span> neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span>connected_output;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>output <span style="color:#ff7b72;font-weight:bold">=</span> neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span>output;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终output指向neigh_resolve_output，ops会根据网卡驱动是否支持缓存定义不同操作。</p>
<p>到这里我们已经为路由项创建了一个邻居结构，但是其中还没有找到目标地址对应的mac信息，路由创建成功，从ip_route_output_ports()返回。继续往下走
ip_queue_xmit -&gt; ip_local_out -&gt; ip_output -&gt;ip_finish_output -&gt; ip_finish_output2</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-55-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-55-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">inline</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">ip_finish_output2</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 判断是否缓存了数据链路层的发送设备mac信息 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hh)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">neigh_hh_output</span>(dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hh, skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">else</span> <span style="color:#ff7b72">if</span> (dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>neighbour)
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 没有缓存调用neigh_resolve_output 在neight_hh_init初始化 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>neighbour<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">output</span>(skb);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数中，由于路由项是刚创建的，还没有缓存目的端的mac信息，走else if分支。又因为在创建neighbour时，output指向neigh_resolve_output。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-56-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-56-37">37</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/core/neighbour.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">neigh_resolve_output</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> dst_entry <span style="color:#ff7b72;font-weight:bold">*</span>dst <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_dst</span>(skb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>neigh;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> rc <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 开辟网络包头部空间 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">__skb_pull</span>(skb, <span style="color:#d2a8ff;font-weight:bold">skb_network_offset</span>(skb));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 发送arp事件 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">neigh_event_send</span>(neigh, skb)) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev <span style="color:#ff7b72;font-weight:bold">=</span> neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> seq;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>header_ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span>cache <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#ff7b72;font-weight:bold">!</span>dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>hh <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#ff7b72;font-weight:bold">!</span>(dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags <span style="color:#ff7b72;font-weight:bold">&amp;</span> DST_NOCACHE))
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 创建缓冲头部并初始化 mac地址就是放在里面 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">neigh_hh_init</span>(neigh, dst, dst<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span>protocol);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">do</span> {
</span></span><span style="display:flex;"><span>			seq <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">read_seqbegin</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ha_lock);
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 准备数据链路层头部 */</span>
</span></span><span style="display:flex;"><span>			err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">dev_hard_header</span>(skb, dev, <span style="color:#d2a8ff;font-weight:bold">ntohs</span>(skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>protocol),
</span></span><span style="display:flex;"><span>					      neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ha, NULL, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len);
</span></span><span style="display:flex;"><span>		} <span style="color:#ff7b72">while</span> (<span style="color:#d2a8ff;font-weight:bold">read_seqretry</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ha_lock, seq));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err <span style="color:#ff7b72;font-weight:bold">&gt;=</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 调用邻居函数表的发送函数 ops对应arp_hh_ops queue_xmit指向dev_queue_xmit */</span>
</span></span><span style="display:flex;"><span>			rc <span style="color:#ff7b72;font-weight:bold">=</span> neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">queue_xmit</span>(skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out_kfree_skb;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数先调用neigh_event_send()将skb加入到arp_queue中并启动了定时器。接着调用neigh_hh_init()创建一个缓存结构，供存放链路头信息。最后在do&hellip;while中顺序读将目标地址mac信息放到skb的链路层头部接着调用dev_queue_xmit发往物理网卡。</p>
<p>neigh_event_send -&gt; __neigh_event_send()</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-57-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-57-31">31</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">__neigh_event_send</span>(<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>neigh, <span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始时neigh-&gt;nud_state  = NUD_NONE */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>(neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state <span style="color:#ff7b72;font-weight:bold">&amp;</span> (NUD_STALE <span style="color:#ff7b72;font-weight:bold">|</span> NUD_INCOMPLETE))) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 检查邻居结构的参数值 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>parms<span style="color:#ff7b72;font-weight:bold">-&gt;</span>mcast_probes <span style="color:#ff7b72;font-weight:bold">+</span> neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>parms<span style="color:#ff7b72;font-weight:bold">-&gt;</span>app_probes) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">atomic_set</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>probes, neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>parms<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ucast_probes);
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state     <span style="color:#ff7b72;font-weight:bold">=</span> NUD_INCOMPLETE;
</span></span><span style="display:flex;"><span>			neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>updated <span style="color:#ff7b72;font-weight:bold">=</span> jiffies;
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 新增探测定时 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">neigh_add_timer</span>(neigh, now <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span>		} 
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state <span style="color:#ff7b72;font-weight:bold">==</span> NUD_INCOMPLETE) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (skb) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">skb_queue_len</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>arp_queue) <span style="color:#ff7b72;font-weight:bold">&gt;=</span>
</span></span><span style="display:flex;"><span>			    neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>parms<span style="color:#ff7b72;font-weight:bold">-&gt;</span>queue_len) {
</span></span><span style="display:flex;"><span>				<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>buff;
</span></span><span style="display:flex;"><span>				buff <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__skb_dequeue</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>arp_queue);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">kfree_skb</span>(buff);
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">NEIGH_CACHE_STAT_INC</span>(neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>tbl, unres_discards);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">skb_dst_force</span>(skb);
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* 将skb加入探测队列 等待定时器超时执行 */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">__skb_queue_tail</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>arp_queue, skb);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		rc <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数将neighbour的状态设置为<strong>NUD_INCOMPLETE</strong>，并新增了一个定时器，接着将skb加到arp_queue队列上，等待定时到期在继续处理。</p>
<p>定时到期后，进入处理函数neigh_timer_handler()</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-58-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-58-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">neigh_timer_handler</span>(<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> arg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	state <span style="color:#ff7b72;font-weight:bold">=</span> neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nud_state <span style="color:#ff7b72;font-weight:bold">&amp;</span> (NUD_INCOMPLETE <span style="color:#ff7b72;font-weight:bold">|</span> NUD_PROBE)) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_peek</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>arp_queue);
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* keep skb alive even if arp_queue overflows */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (skb)
</span></span><span style="display:flex;"><span>			skb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_copy</span>(skb, GFP_ATOMIC);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">write_unlock</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 发送探测包solicit */</span>
</span></span><span style="display:flex;"><span>		neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">solicit</span>(neigh, skb);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">atomic_inc</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>probes);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">kfree_skb</span>(skb);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在arp_constructor()中定义了neigh-&gt;ops指向arp_hh_ops或者arp_generic_ops，neigh-&gt;ops-&gt;solicit都指向arp_solicit()</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-59-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-59-29">29</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/ipv4/arp.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">arp_solicit</span>(<span style="color:#ff7b72">struct</span> neighbour <span style="color:#ff7b72;font-weight:bold">*</span>neigh, <span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/*  */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">arp_send</span>(ARPOP_REQUEST, ETH_P_ARP, target, dev, saddr,
</span></span><span style="display:flex;"><span>		 dst_ha, dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev_addr, NULL);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (dst_ha)
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">read_unlock_bh</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>neigh<span style="color:#ff7b72;font-weight:bold">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">arp_send</span>(<span style="color:#ff7b72">int</span> type, <span style="color:#ff7b72">int</span> ptype, __be32 dest_ip,
</span></span><span style="display:flex;"><span>	      <span style="color:#ff7b72">struct</span> net_device <span style="color:#ff7b72;font-weight:bold">*</span>dev, __be32 src_ip,
</span></span><span style="display:flex;"><span>	      <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>dest_hw, <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>src_hw,
</span></span><span style="display:flex;"><span>	      <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>target_hw)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	skb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">arp_create</span>(type, ptype, dest_ip, dev, src_ip,
</span></span><span style="display:flex;"><span>			 dest_hw, src_hw, target_hw);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (skb <span style="color:#ff7b72;font-weight:bold">==</span> NULL)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">arp_xmit</span>(skb);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">arp_xmit</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">NF_HOOK</span>(NFPROTO_ARP, NF_ARP_OUT, skb, NULL, skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dev, dev_queue_xmit);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>arp_send中调用arp_create重新生成一个skb_buff报文，因为arp报文信息与tcp信息不同。新生成skb_buff包含arp的协议信息，如下所示：
<img src="/image/tcp_ip/kdwZKPQB3pSafsnM.png" alt="输入图片说明"></p>
<p>其中目标AMC地址填充为000000，最后调用arp_xmit -&gt; dev_queue_xmit发送arp请求消息到网卡。</p>
<p>如果网关设备或者局域网中找到了目标IP对应的MAC，内核会收到ARP的reply消息，也是先由网卡接收，从物理层到网络层，进到**arp_rcv()**中处理。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-60-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-60-41">41</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">arp_process</span>(<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 获取arp */</span>
</span></span><span style="display:flex;"><span>	arp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">arp_hdr</span>(skb);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	arp_ptr <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>)(arp <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 获取客户端mac */</span>
</span></span><span style="display:flex;"><span>	sha	<span style="color:#ff7b72;font-weight:bold">=</span> arp_ptr;
</span></span><span style="display:flex;"><span>	arp_ptr <span style="color:#ff7b72;font-weight:bold">+=</span> dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>addr_len;
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 获取客户端IP */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>sip, arp_ptr, <span style="color:#a5d6ff">4</span>);
</span></span><span style="display:flex;"><span>	arp_ptr <span style="color:#ff7b72;font-weight:bold">+=</span> <span style="color:#a5d6ff">4</span>;
</span></span><span style="display:flex;"><span>	arp_ptr <span style="color:#ff7b72;font-weight:bold">+=</span> dev<span style="color:#ff7b72;font-weight:bold">-&gt;</span>addr_len;
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 获取服务端IP */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>tip, arp_ptr, <span style="color:#a5d6ff">4</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 从哈希捅中查找邻居结构 */</span>
</span></span><span style="display:flex;"><span>	n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__neigh_lookup</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_tbl, <span style="color:#ff7b72;font-weight:bold">&amp;</span>sip, dev, <span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">IPV4_DEVCONF_ALL</span>(<span style="color:#d2a8ff;font-weight:bold">dev_net</span>(dev), ARP_ACCEPT)) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (n <span style="color:#ff7b72;font-weight:bold">==</span> NULL <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    (arp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ar_op <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#d2a8ff;font-weight:bold">htons</span>(ARPOP_REPLY) <span style="color:#ff7b72;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>		     (arp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ar_op <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#d2a8ff;font-weight:bold">htons</span>(ARPOP_REQUEST) <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> tip <span style="color:#ff7b72;font-weight:bold">==</span> sip)) <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#d2a8ff;font-weight:bold">inet_addr_type</span>(net, sip) <span style="color:#ff7b72;font-weight:bold">==</span> RTN_UNICAST)
</span></span><span style="display:flex;"><span>			n <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__neigh_lookup</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>arp_tbl, <span style="color:#ff7b72;font-weight:bold">&amp;</span>sip, dev, <span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (n) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">int</span> state <span style="color:#ff7b72;font-weight:bold">=</span> NUD_REACHABLE;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">int</span> override;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (arp<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ar_op <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#d2a8ff;font-weight:bold">htons</span>(ARPOP_REPLY) <span style="color:#ff7b72;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>		    skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pkt_type <span style="color:#ff7b72;font-weight:bold">!=</span> PACKET_HOST)
</span></span><span style="display:flex;"><span>			state <span style="color:#ff7b72;font-weight:bold">=</span> NUD_STALE;
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 根据邻居结构 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">neigh_update</span>(n, sha, state,
</span></span><span style="display:flex;"><span>			     override <span style="color:#ff7b72;font-weight:bold">?</span> <span style="color:#79c0ff;font-weight:bold">NEIGH_UPDATE_F_OVERRIDE</span> : <span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">neigh_release</span>(n);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>arp_rcv从skb中解析出接收端与发送端的MAC、IP信息，调用__neigh_lookup()查找以客户端IP为key创建的neighbour结构，找到后调用neigh_update()更新neighbour中记录的mac信息。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-61-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-61-37">37</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>int neigh_update(struct neighbour *neigh, const u8 *lladdr, u8 new,
</span></span><span style="display:flex;"><span>		 u32 flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	/* 更新邻居的mac地址 */
</span></span><span style="display:flex;"><span>	if (lladdr != neigh-&gt;ha) {
</span></span><span style="display:flex;"><span>		write_seqlock(&amp;neigh-&gt;ha_lock);
</span></span><span style="display:flex;"><span>		memcpy(&amp;neigh-&gt;ha, lladdr, dev-&gt;addr_len);
</span></span><span style="display:flex;"><span>		write_sequnlock(&amp;neigh-&gt;ha_lock);
</span></span><span style="display:flex;"><span>		neigh_update_hhs(neigh);
</span></span><span style="display:flex;"><span>		if (!(new &amp; NUD_CONNECTED))
</span></span><span style="display:flex;"><span>			neigh-&gt;confirmed = jiffies -
</span></span><span style="display:flex;"><span>				      (neigh-&gt;parms-&gt;base_reachable_time &lt;&lt; 1);
</span></span><span style="display:flex;"><span>		notify = 1;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		if (!(old &amp; NUD_VALID)) {
</span></span><span style="display:flex;"><span>		struct sk_buff *skb;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		/* Again: avoid dead loop if something went wrong */
</span></span><span style="display:flex;"><span>		/* 继续调用neigh_resolve_output发送数据 */
</span></span><span style="display:flex;"><span>		while (neigh-&gt;nud_state &amp; NUD_VALID &amp;&amp;
</span></span><span style="display:flex;"><span>		       (skb = __skb_dequeue(&amp;neigh-&gt;arp_queue)) != NULL) {
</span></span><span style="display:flex;"><span>			struct neighbour *n1 = neigh;
</span></span><span style="display:flex;"><span>			write_unlock_bh(&amp;neigh-&gt;lock);
</span></span><span style="display:flex;"><span>			/* On shaper/eql skb-&gt;dst-&gt;neighbour != neigh :( */
</span></span><span style="display:flex;"><span>			if (skb_dst(skb) &amp;&amp; skb_dst(skb)-&gt;neighbour)
</span></span><span style="display:flex;"><span>				n1 = skb_dst(skb)-&gt;neighbour;
</span></span><span style="display:flex;"><span>			n1-&gt;output(skb);
</span></span><span style="display:flex;"><span>			write_lock_bh(&amp;neigh-&gt;lock);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		skb_queue_purge(&amp;neigh-&gt;arp_queue);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>		if (notify)
</span></span><span style="display:flex;"><span>		neigh_update_notify(neigh);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/image/tcp_ip/w5jE7mAk27tD3nbj.png" alt="输入图片说明"></p>
<h3 id="接收处理">接收处理</h3>
<p>除了上面三组文件读写方式，linux系统还支持read/write读写文件。不同于上面三组文件读写在glibc中实现，read/write在linux内核中的fs文件中实现。调用路线如下</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-62-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-62-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-62-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-62-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-62-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-62-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-6">6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-62-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-62-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>write					//系统调用 属于库函数 供用户侧调用
</span></span><span style="display:flex;"><span>  SYSCALL_DEFINE3(write  //内核中实现sys_write通过该宏定义
</span></span><span style="display:flex;"><span>    vfs_write						//虚拟文件系统
</span></span><span style="display:flex;"><span>      file-&gt;f_op-&gt;write/filp-&gt;f_op-&gt;aio_write  //找到具体的文件系统的文件操作函数
</span></span><span style="display:flex;"><span>        sock_aio_write		//socket文件异步写
</span></span><span style="display:flex;"><span>          do_sock_write
</span></span><span style="display:flex;"><span>            __sock_sendmsg  //发送sock数据
</span></span></code></pre></td></tr></table>
</div>
</div><p>接收调用路线</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-63-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-63-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>SYSCALL_DEFINE2(socketcall, int, call, unsigned long __user *, args)
</span></span><span style="display:flex;"><span>    sys_recv/sys_recvfrom/sys_recvmsg
</span></span><span style="display:flex;"><span>      sock_recvmsg     //查找fd对应的文件并找到sock
</span></span><span style="display:flex;"><span>        __sock_recvmsg
</span></span><span style="display:flex;"><span>          inet_recvmsg
</span></span><span style="display:flex;"><span>            tcp_recvmsg  //将缓冲区数据放到skb中
</span></span><span style="display:flex;"><span>              tcp_prequeue_process  //预处理时 将skb数据存到iovec中
</span></span><span style="display:flex;"><span>                __skb_dequeue
</span></span><span style="display:flex;"><span>                sk_backlog_rcv   //到tcp_v4_do_rcv中处理
</span></span><span style="display:flex;"><span>              skb_copy_datagram_iovec  //从接收队列中取skb 调用下面IO复制数据
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="netfilter子系统">netfilter子系统</h1>
<h3 id="作用">作用</h3>
<p>在 Linux 系统中，Netfilter 子系统是一个用于网络数据包过滤、网络地址转换（NAT）以及网络连接跟踪的重要组件。它提供了对网络数据包进行操作和处理的机制，用于实现防火墙、网络地址转换、流量控制等功能。</p>
<p>Netfilter 使用一系列内核模块和用户空间工具来实现上述功能。其中，最常用的用户空间工具是 iptables 和 nftables，用于配置和管理 Netfilter 规则。</p>
<p>总的来说，Netfilter 子系统是 Linux 网络协议栈中非常重要的一个模块，提供了强大的网络数据包处理和管理功能，使管理员能够控制和保护网络的安全性、可靠性和性能。</p>
<h3 id="netfilter-初始化">netfilter 初始化</h3>
<h3 id="hook点">HOOK点</h3>
<p>在上面数据包收发过程中，在ip_rcv中调用了NF_HOOK接口进入netfiter中，继续看接口实现</p>
<h1 id="netlink子系统">netlink子系统</h1>
<p>我们先来跑两个demo，分别编译并运行netlink_user与netlink_kernel，观察串口输出。</p>
<p>看到了么，这就是netlink的使用场景之一，实现用户侧与内核通信。让我们一起来探究netlink子系统的实现。</p>
<h2 id="netllink是什么">netllink是什么？</h2>
<p>Netlink套接字家族（英语：Netlink socket family）是一组Linux核心接口（Linux kernel interfaces），可用于进程间通信，Linux内核与用户空间的进程间、用户进程间的通讯。然而它并不像网络套接字可以用于主机间通讯，Netlink<strong>只能用于同一主机上进程通讯</strong>，并通过PID来标识它们。</p>
<p>Netlink被设计为在<strong>Linux内核与用户空间进程传送各种网络信息</strong>。网络工具iproute2利用 Netlink从用户空间与内核进行通讯。Netlink由一个在用户空间的标准的Socket接口和内核模块 提供的内核API组成。Netlink的设计比ioctl更加灵活，Netlink使用了AF_NETLINK Socket 家族。以上是维基百科对netlink的介绍。</p>
<p>我们先来跑两个demo，分别编译并运行netlink_user与netlink_kernel，观察串口输出。
<a href="https://www.cnblogs.com/wenqiang/p/6306727.html">demo</a></p>
<p>看到了么，这就是netlink的使用场景之一，实现用户侧与内核通信。让我们一起来探究netlink子系统的实现。</p>
<h2 id="初始化-1">初始化</h2>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-64-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-64-33">33</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> __init <span style="color:#d2a8ff;font-weight:bold">netlink_proto_init</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 创建netlink_table结构的全局变量 */</span>
</span></span><span style="display:flex;"><span>	nl_table <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">kcalloc</span>(MAX_LINKS, <span style="color:#ff7b72">sizeof</span>(<span style="color:#ff7b72;font-weight:bold">*</span>nl_table), GFP_KERNEL);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>nl_table)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> panic;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">for</span> (i <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>; i <span style="color:#ff7b72;font-weight:bold">&lt;</span> MAX_LINKS; i<span style="color:#ff7b72;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">struct</span> nl_pid_hash <span style="color:#ff7b72;font-weight:bold">*</span>hash <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>nl_table[i].hash;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>table <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">nl_pid_hash_zalloc</span>(<span style="color:#a5d6ff">1</span> <span style="color:#ff7b72;font-weight:bold">*</span> <span style="color:#ff7b72">sizeof</span>(<span style="color:#ff7b72;font-weight:bold">*</span>hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>table));
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>table) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">while</span> (i<span style="color:#ff7b72;font-weight:bold">--</span> <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#d2a8ff;font-weight:bold">nl_pid_hash_free</span>(nl_table[i].hash.table,
</span></span><span style="display:flex;"><span>						 <span style="color:#a5d6ff">1</span> <span style="color:#ff7b72;font-weight:bold">*</span> <span style="color:#ff7b72">sizeof</span>(<span style="color:#ff7b72;font-weight:bold">*</span>hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>table));
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">kfree</span>(nl_table);
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> panic;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>max_shift <span style="color:#ff7b72;font-weight:bold">=</span> order;
</span></span><span style="display:flex;"><span>		hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>shift <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>mask <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		hash<span style="color:#ff7b72;font-weight:bold">-&gt;</span>rehash_time <span style="color:#ff7b72;font-weight:bold">=</span> jiffies;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">netlink_add_usersock_entry</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sock_register</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>netlink_family_ops);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">register_pernet_subsys</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>netlink_net_ops);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">core_initcall</span>(netlink_proto_init);
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数创建了一个netlink_table结构的全局变量nl_table，并初始化成员量hash，最后注册了AF_NETLINK到net_families中，还记得net_families中包含那些参数了么？
<img src="/image/tcp_ip/ZoohF0EJjmvaTiGD.png" alt="输入图片说明"></p>
<h2 id="创建">创建</h2>
<p>netlink与tcp连接步骤非常相识，都是通过socket函数完成套接字创建，netlink套接字的创建流程如下图：
<img src="/image/tcp_ip/cV5rRyFlFy7jQrgp.png" alt="输入图片说明"></p>
<p>netlink走了AF_NETLINK这个协议族，调用__netlink_create创建sock与netlink_sock结构。<strong>注意：protocol最大值不能超过32</strong></p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-65-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-65-29">29</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/net/netlink/af_netlink.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">__netlink_create</span>(<span style="color:#ff7b72">struct</span> net <span style="color:#ff7b72;font-weight:bold">*</span>net, <span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock,
</span></span><span style="display:flex;"><span>			    <span style="color:#ff7b72">struct</span> mutex <span style="color:#ff7b72;font-weight:bold">*</span>cb_mutex, <span style="color:#ff7b72">int</span> protocol)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> netlink_sock <span style="color:#ff7b72;font-weight:bold">*</span>nlk;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ops <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>netlink_ops;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 与AF_INET的sk只有两个参数不同 */</span>
</span></span><span style="display:flex;"><span>	sk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sk_alloc</span>(net, PF_NETLINK, GFP_KERNEL, <span style="color:#ff7b72;font-weight:bold">&amp;</span>netlink_proto);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>sk)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sock_init_data</span>(sock, sk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	nlk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">nlk_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (cb_mutex)
</span></span><span style="display:flex;"><span>		nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>cb_mutex <span style="color:#ff7b72;font-weight:bold">=</span> cb_mutex;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>		nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>cb_mutex <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>cb_def_mutex;
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">mutex_init</span>(nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>cb_mutex);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">init_waitqueue_head</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>wait);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_destruct <span style="color:#ff7b72;font-weight:bold">=</span> netlink_sock_destruct;
</span></span><span style="display:flex;"><span>	sk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk_protocol <span style="color:#ff7b72;font-weight:bold">=</span> protocol;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="绑定">绑定</h2>
<p>在用户侧也是调用bind()实现地址绑定，来看看netlink_bind实现</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-66-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-66-38">38</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">struct</span> sockaddr_nl {
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">sa_family_t</span>	nl_family;	<span style="color:#8b949e;font-style:italic">/* AF_NETLINK	*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">short</span>	nl_pad;		<span style="color:#8b949e;font-style:italic">/* zero		*/</span>
</span></span><span style="display:flex;"><span>	__u32		nl_pid;		<span style="color:#8b949e;font-style:italic">/* port ID	*/</span>
</span></span><span style="display:flex;"><span>	__u32		nl_groups;	<span style="color:#8b949e;font-style:italic">/* multicast groups mask */</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">netlink_bind</span>(<span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock, <span style="color:#ff7b72">struct</span> sockaddr <span style="color:#ff7b72;font-weight:bold">*</span>addr,
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">int</span> addr_len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> net <span style="color:#ff7b72;font-weight:bold">*</span>net <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sock_net</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> netlink_sock <span style="color:#ff7b72;font-weight:bold">*</span>nlk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">nlk_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sockaddr_nl <span style="color:#ff7b72;font-weight:bold">*</span>nladdr <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">struct</span> sockaddr_nl <span style="color:#ff7b72;font-weight:bold">*</span>)addr;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Only superuser is allowed to listen multicasts */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (nladdr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_groups) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">netlink_capable</span>(sock, NL_NONROOT_RECV))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>EPERM;
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">netlink_realloc_groups</span>(sk);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> err;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pid) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (nladdr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_pid <span style="color:#ff7b72;font-weight:bold">!=</span> nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pid)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>EINVAL;
</span></span><span style="display:flex;"><span>	} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> nladdr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_pid <span style="color:#ff7b72;font-weight:bold">?</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">netlink_insert</span>(sk, net, nladdr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_pid) <span style="color:#ff7b72;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">netlink_autobind</span>(sock);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> err;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>netlink_bind()函数接收用户侧传进来的地址信息，地址由结构体sockaddr_nl表示，其中nl_pid表示端口ID，每个netlink sock只有唯一一个端口ID，nl_groups表示组ID，每个netlink sock可以公用一个组ID。在netlink_insert中将sock结构添加到<strong>nl_table[sk-&gt;sk_protocol].hash</strong>这个哈希表上，可以使用端口ID在哈希表上找到sock。</p>
<h2 id="发送消息">发送消息</h2>
<p>在用户侧也是调用write/send/sendto实现地址消息发送，来看看netlink_sendmsg实现</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-67-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-67-50">50</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">netlink_sendmsg</span>(<span style="color:#ff7b72">struct</span> kiocb <span style="color:#ff7b72;font-weight:bold">*</span>kiocb, <span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock,
</span></span><span style="display:flex;"><span>			   <span style="color:#ff7b72">struct</span> msghdr <span style="color:#ff7b72;font-weight:bold">*</span>msg, <span style="color:#ff7b72">size_t</span> len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock_iocb <span style="color:#ff7b72;font-weight:bold">*</span>siocb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">kiocb_to_siocb</span>(kiocb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> netlink_sock <span style="color:#ff7b72;font-weight:bold">*</span>nlk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">nlk_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sockaddr_nl <span style="color:#ff7b72;font-weight:bold">*</span>addr <span style="color:#ff7b72;font-weight:bold">=</span> msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_name;
</span></span><span style="display:flex;"><span>	u32 dst_pid;
</span></span><span style="display:flex;"><span>	u32 dst_group;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> scm_cookie scm;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 获取发送地址的端口ID与组ID */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_namelen) {
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">-</span>EINVAL;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_family <span style="color:#ff7b72;font-weight:bold">!=</span> AF_NETLINK)
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>		dst_pid <span style="color:#ff7b72;font-weight:bold">=</span> addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_pid;
</span></span><span style="display:flex;"><span>		dst_group <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">ffs</span>(addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_groups);
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span>  <span style="color:#ff7b72;font-weight:bold">-</span>EPERM;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (dst_group <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">netlink_capable</span>(sock, NL_NONROOT_SEND))
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>	} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>		dst_pid <span style="color:#ff7b72;font-weight:bold">=</span> nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst_pid;
</span></span><span style="display:flex;"><span>		dst_group <span style="color:#ff7b72;font-weight:bold">=</span> nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>dst_group;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	skb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">alloc_skb</span>(len, GFP_KERNEL);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (skb <span style="color:#ff7b72;font-weight:bold">==</span> NULL)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">NETLINK_CB</span>(skb).pid	<span style="color:#ff7b72;font-weight:bold">=</span> nlk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">NETLINK_CB</span>(skb).dst_group <span style="color:#ff7b72;font-weight:bold">=</span> dst_group;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">memcpy</span>(<span style="color:#d2a8ff;font-weight:bold">NETLINK_CREDS</span>(skb), <span style="color:#ff7b72;font-weight:bold">&amp;</span>siocb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>scm<span style="color:#ff7b72;font-weight:bold">-&gt;</span>creds, <span style="color:#ff7b72">sizeof</span>(<span style="color:#ff7b72">struct</span> ucred));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">memcpy_fromiovec</span>(<span style="color:#d2a8ff;font-weight:bold">skb_put</span>(skb, len), msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_iov, len)) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">kfree_skb</span>(skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (dst_group) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">atomic_inc</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>users);
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 组播发送 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">netlink_broadcast</span>(sk, skb, dst_pid, dst_group, GFP_KERNEL);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 单播发送 */</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">netlink_unicast</span>(sk, skb, dst_pid, msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_flags<span style="color:#ff7b72;font-weight:bold">&amp;</span>MSG_DONTWAIT);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>netlink_sendmsg()允许将数据单播发送与组播发送，其中组播发送原理为找出哈希表中所有与组ID与发送组ID一致的sock结构，将skb包放到sock结构的接收队列上。单播发送只是找出端口ID与发送的端口ID一致的的sock，将skb包放到sock结构的接收队列上。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-68-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-68-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">netlink_unicast</span>(<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>ssk, <span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb,
</span></span><span style="display:flex;"><span>		    u32 pid, <span style="color:#ff7b72">int</span> nonblock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	sk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">netlink_getsockbypid</span>(ssk, pid);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">IS_ERR</span>(sk)) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">kfree_skb</span>(skb);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">PTR_ERR</span>(sk);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* nlk_sk(sk)-&gt;flags &amp; NETLINK_KERNEL_SOCKET 条件成立直接发送到内核*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">netlink_is_kernel</span>(sk))
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">netlink_unicast_kernel</span>(sk, skb);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 将skb放到sk的接收缓存上 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">netlink_sendskb</span>(sk, skb);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="接收消息">接收消息</h2>
<p>在用户侧也是调用read/recive/recivefrom实现地址消息发送，来看看netlink_recvmsg实现</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-69-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-69-47">47</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">netlink_recvmsg</span>(<span style="color:#ff7b72">struct</span> kiocb <span style="color:#ff7b72;font-weight:bold">*</span>kiocb, <span style="color:#ff7b72">struct</span> socket <span style="color:#ff7b72;font-weight:bold">*</span>sock,
</span></span><span style="display:flex;"><span>			   <span style="color:#ff7b72">struct</span> msghdr <span style="color:#ff7b72;font-weight:bold">*</span>msg, <span style="color:#ff7b72">size_t</span> len,
</span></span><span style="display:flex;"><span>			   <span style="color:#ff7b72">int</span> flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock_iocb <span style="color:#ff7b72;font-weight:bold">*</span>siocb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">kiocb_to_siocb</span>(kiocb);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> scm_cookie scm;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sock <span style="color:#ff7b72;font-weight:bold">*</span>sk <span style="color:#ff7b72;font-weight:bold">=</span> sock<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sk;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> netlink_sock <span style="color:#ff7b72;font-weight:bold">*</span>nlk <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">nlk_sk</span>(sk);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> noblock <span style="color:#ff7b72;font-weight:bold">=</span> flags<span style="color:#ff7b72;font-weight:bold">&amp;</span>MSG_DONTWAIT;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">size_t</span> copied;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> sk_buff <span style="color:#ff7b72;font-weight:bold">*</span>skb, <span style="color:#ff7b72;font-weight:bold">*</span>data_skb;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> err, ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (flags<span style="color:#ff7b72;font-weight:bold">&amp;</span>MSG_OOB)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">return</span> <span style="color:#ff7b72;font-weight:bold">-</span>EOPNOTSUPP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	copied <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 从sock的接收队列取出skb */</span>
</span></span><span style="display:flex;"><span>	skb <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_recv_datagram</span>(sk, flags, noblock, <span style="color:#ff7b72;font-weight:bold">&amp;</span>err);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (skb <span style="color:#ff7b72;font-weight:bold">==</span> NULL)
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	data_skb <span style="color:#ff7b72;font-weight:bold">=</span> skb;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_namelen <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	copied <span style="color:#ff7b72;font-weight:bold">=</span> data_skb<span style="color:#ff7b72;font-weight:bold">-&gt;</span>len;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (len <span style="color:#ff7b72;font-weight:bold">&lt;</span> copied) {
</span></span><span style="display:flex;"><span>		msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_flags <span style="color:#ff7b72;font-weight:bold">|=</span> MSG_TRUNC;
</span></span><span style="display:flex;"><span>		copied <span style="color:#ff7b72;font-weight:bold">=</span> len;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">skb_reset_transport_header</span>(data_skb);
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 将数据复制到用户侧 */</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">skb_copy_datagram_iovec</span>(data_skb, <span style="color:#a5d6ff">0</span>, msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_iov, copied);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_name) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">struct</span> sockaddr_nl <span style="color:#ff7b72;font-weight:bold">*</span>addr <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">struct</span> sockaddr_nl <span style="color:#ff7b72;font-weight:bold">*</span>)msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_name;
</span></span><span style="display:flex;"><span>		addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_family <span style="color:#ff7b72;font-weight:bold">=</span> AF_NETINK;
</span></span><span style="display:flex;"><span>		addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_pad    <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;L
</span></span><span style="display:flex;"><span>		addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_pid	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">NETLINK_CB</span>(skb).pid;
</span></span><span style="display:flex;"><span>		addr<span style="color:#ff7b72;font-weight:bold">-&gt;</span>nl_groups	<span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">netlink_group_mask</span>(<span style="color:#d2a8ff;font-weight:bold">NETLINK_CB</span>(skb).dst_group);
</span></span><span style="display:flex;"><span>		msg<span style="color:#ff7b72;font-weight:bold">-&gt;</span>msg_namelen <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">sizeof</span>(<span style="color:#ff7b72;font-weight:bold">*</span>addr);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="c10k问题">C10K问题</h1>
<h2 id="select">select</h2>
<p>在处理网络编程时，我们经常使用 <strong>set 集</strong>合来存储需要监听的 socket。这个集合有一个限制，最多只能容纳 <strong>1024</strong> 个 socket。当监听事件发生时，我们会更新这个集合，为了确保最新的事件能够被捕捉到，每次调用 select 函数都需要<strong>重新为 set 赋值</strong>。在底层内核中，会通过<strong>遍历集合</strong>的方式，逐个调用 socket 文件的 poll_wait 函数来检测是否有读写事件到来。
参考<a href="http://gityuan.com/2019/01/05/linux-poll-select/">sellect内核源码机制解读</a></p>
<h2 id="epoll">epoll</h2>
<p>epoll 的工作原理基于三个主要的系统调用：<strong>epoll_create</strong>、<strong>epoll_ctl</strong> 和 <strong>epoll_wait</strong>。</p>
<p>首先，我们使用 epoll_create 创建一个 epoll 实例，返回一个文件描述符，用于标识这个 epoll 实例。文件描述符的私有变量指向了一个红黑树结构，用于存放需要监听的文件描述符。<strong>避免了重复复制</strong></p>
<p>使用 epoll_ctl 来管理需要监听的文件描述符。我们可以将文件描述符添加到 文件描述符指向的红黑树中，也可以修改或删除已添加的文件描述符。这样，epoll 就会监视这些文件描述符上发生的事件。并且理论上允许添加的<strong>监控socket没有上限</strong>，只要你的内存足够</p>
<p>我们可以使用 epoll_wait 进行等待。epoll_wait 会阻塞程序运行，直到任一文件描述符上发生了感兴趣的事件。</p>
<p>与 select 不同，epoll 并<strong>不需要遍历所有的文件描述符</strong>来检查是否有事件发生。相反，它通过内核维护的事件表格（event table）来跟踪每个文件描述符的状态，并且只返回发生事件的文件描述符。这种方式避免了无谓的遍历，提高了效率。</p>
<p>另一个 epoll 的优点是支持两种模式：水平触发（Level Triggered）和边缘触发（Edge Triggered）。在水平触发模式下，只要文件描述符上还有待处理的数据，epoll_wait 就会一直返回该文件描述符。而在边缘触发模式下，epoll_wait 只在文件描述符上发生新的事件时才返回。边缘触发模式能够更精确地追踪事件的发生，减少了事件被忽略的可能性。</p>
<h1 id="vlan">vlan</h1>
<p>参考<a href="https://www.cnblogs.com/zmkeil/archive/2013/04/18/3029339.html">vlan实现</a></p>
<h2 id="作用-1">作用</h2>
<p>在Linux系统中，Virtual LAN（VLAN）是一种用于在网络中创建虚拟局域网的技术。VLAN允许将网络设备（如交换机、网卡等）划分为多个逻辑上隔离的网络片段，即虚拟局域网。每个VLAN中的设备可以相互通信，而不受其他VLAN中设备的影响。</p>
<h2 id="初始化-2">初始化</h2>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-70-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-70-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-70-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-70-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>vlan_proto_init   //net/8021.q/vlan.c文件模块初始化
</span></span><span style="display:flex;"><span>vlan_ioctl_set(vlan_ioctl_handler)  //注册vlan的处理函数到socket中，便于socket通过ioctl走到vlan
</span></span><span style="display:flex;"><span>vlan_ioctl_handler  //解析ioctl出入的参数并执行创建、删除一个vlan设备new_dev
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="发送">发送</h2>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-71-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-71-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-71-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-71-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-71-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-71-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>在IP层通过路由的方式寻找vlan设备，并被打一个vlan的标记
</span></span><span style="display:flex;"><span>dev_hard_start_xmit中判断标记并在协议层设置valn_tag与802.1q标志
</span></span><span style="display:flex;"><span>在新建vlan_dev设备时也初始化了dev-&gt;netdev_ops		= &amp;vlan_netdev_ops，所以在dev_hard_start_xmit函数最后调用ops.ndo_start_xmit对应虚拟设备走vlan_dev_hard_start_xmit
</span></span><span style="display:flex;"><span>vlan_dev_hard_start_xmit函数主要将发送设备切换到真正的物理设备，并对vlan设备的发包信息统计计数
</span></span><span style="display:flex;"><span>最后又回到dev_queue_xmit中继续走物理设备发送数据包，这里涉及堆栈重复入栈问题
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="接收">接收</h2>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-72-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-72-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-72-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>__netif_receive_skb中判断数据包有vlan_tag标记
</span></span><span style="display:flex;"><span>存在则调用vlan_hwaccel_do_receive进入vlan模块中，根据vlan_id找到vlan设备，重新切换数据报的接收设备并统计接收信息。回到__netif_receive_skb中回调__netif_receive_skb重新执行。
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="bridge">bridge</h1>
<p>参考<a href="https://www.cnblogs.com/zmkeil/archive/2013/04/21/3034733.html">bridge实现</a></p>
<h2 id="作用-2">作用</h2>
<h2 id="初始化-3">初始化</h2>
<h2 id="发送-1">发送</h2>
<h2 id="接收-1">接收</h2>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">dgwu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2022-07-09
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>



    
    


    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://Breeze-Wu.github.io/tags/linux/">linux</a>
            <a href="https://Breeze-Wu.github.io/tags/tcp/ip/">TCP/IP</a>
            
        </div>


      
      <nav class="post-nav">
        
          <a class="prev" href="/post/linux%E7%B3%BB%E7%BB%9F%E4%BF%A1%E5%8F%B7%E5%AE%9E%E7%8E%B0/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">linux系统信号实现</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/openwrt%E7%B3%BB%E7%BB%9F%E7%9A%84web%E7%AE%A1%E7%90%86%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/">
            <span class="next-text nav-default">openwrt系统的web管理流程梳理</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  


  
  

  

  
  

  
  

  

  

    

  

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:your@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="twitch"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 36 36" version="1.1" width="36" height="36" id="svg8">
  <path
      style=""
      d="M 10,32.5 C 10,30.309524 9.5666667,30 6.5,30 H 3 V 18.196167 6.3923336 L 6.2976072,3.1961668 9.5952145,0 H 21.297607 33 v 9.2813035 9.2813035 l -5.778997,5.718696 C 23.230948,28.229724 20.653654,30 18.895317,30 17.471816,30 15.312792,31.102597 14,32.5 12.708255,33.875 11.279813,35 10.825686,35 10.371559,35 10,33.875 10,32.5 Z M 23.12736,22 c 1.432033,0 3.645397,-1.197147 5.185549,-2.804719 C 30.682196,16.722278 31,15.598708 31,9.6952811 V 3 H 20.5 10 v 9.5 9.5 h 3 c 2.413503,0 3,0.425076 3,2.174314 v 2.174314 l 2.314451,-2.174314 C 19.587399,22.978441 21.753208,22 23.12736,22 Z M 17.666667,14.333333 C 17.3,13.966667 17,12.166667 17,10.333333 17,8.037037 17.466667,7 18.5,7 c 1.083333,0 1.5,1.1111111 1.5,4 0,3.753437 -0.7878,4.878866 -2.333333,3.333333 z m 6.722867,-0.760607 C 23.554137,11.395717 24.34722,7.7069709 25.75,7.2449946 26.613128,6.9607414 27,8.097114 27,10.916667 c 0,3.979702 -1.51214,5.518252 -2.610466,2.656059 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://Breeze-Wu.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2023
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        dgwu
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.fe83e11b4fbc9193d67e2c9db78bad21f8dc59fca0cacd8c1c3bb071bb16a852.js" integrity="sha256-/oPhG0&#43;8kZPWfiydt4utIfjcWfygys2MHDuwcbsWqFI=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  

















</body>
</html>
