<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>linux系统init启动梳理 - dgwu - A super concise theme for Hugo</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="dgwu" />
  <meta name="description" content="摘要 本文旨在梳理总结linux系统是如何加载第一个进程、init进程的实现以及如何制作根文件系统。文章从linux内核源码入手，逐步梳理从设" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.109.0" />


<link rel="canonical" href="https://Breeze-Wu.github.io/post/linux_init/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.de22abc00de44766eebd1054fd9e0b254b071f89d5019044f893c484a9249a8d.css" integrity="sha256-3iKrwA3kR2buvRBU/Z4LJUsHH4nVAZBE&#43;JPEhKkkmo0=" media="screen" crossorigin="anonymous">







<meta property="og:title" content="linux系统init启动梳理" />
<meta property="og:description" content="摘要 本文旨在梳理总结linux系统是如何加载第一个进程、init进程的实现以及如何制作根文件系统。文章从linux内核源码入手，逐步梳理从设" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Breeze-Wu.github.io/post/linux_init/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-01-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-01-13T00:00:00+00:00" />
<meta itemprop="name" content="linux系统init启动梳理">
<meta itemprop="description" content="摘要 本文旨在梳理总结linux系统是如何加载第一个进程、init进程的实现以及如何制作根文件系统。文章从linux内核源码入手，逐步梳理从设"><meta itemprop="datePublished" content="2023-01-13T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-01-13T00:00:00+00:00" />
<meta itemprop="wordCount" content="6767">
<meta itemprop="keywords" content="linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="linux系统init启动梳理"/>
<meta name="twitter:description" content="摘要 本文旨在梳理总结linux系统是如何加载第一个进程、init进程的实现以及如何制作根文件系统。文章从linux内核源码入手，逐步梳理从设"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">dgwu</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      dgwu
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">linux系统init启动梳理</h1>
      

      <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          dgwu
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2023-01-13">
      2023-01-13
    </time>
  </div>

  


  <div class="post-meta__right">
    

    


    
    


    
    
  </div>
</div>

    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#11-initrd">1.1 initrd</a></li>
    <li><a href="#12-initramfs">1.2 initramfs</a></li>
    <li><a href="#13-rootfs制作">1.3 rootfs制作</a></li>
  </ul>

  <ul>
    <li><a href="#21-start_kernel">2.1 start_kernel</a></li>
    <li><a href="#22-rest_init">2.2 rest_init</a></li>
    <li><a href="#23-kernel_init">2.3 kernel_init</a>
      <ul>
        <li><a href="#231-do_basic_setup">2.3.1 do_basic_setup</a></li>
        <li><a href="#232-prepare_namespace">2.3.2 prepare_namespace</a></li>
        <li><a href="#233-init_post">2.3.3 init_post</a></li>
        <li><a href="#234-init">2.3.4 init</a></li>
      </ul>
    </li>
    <li><a href="#24--rtl_sdk的rcs文件">2.4  RTL_SDK的rcS文件</a></li>
  </ul>
</nav>
  </div>
</div>


    
    <div class="post-content">
      <h1 id="摘要">摘要</h1>
<p>本文旨在梳理总结linux系统是如何加载第一个进程、init进程的实现以及如何制作根文件系统。文章从linux内核源码入手，逐步梳理从设备开机到1号进程执行的全过程，其中源码涉及linux-2.6.39、busybox-1.28.3。文中错误处欢迎指正交流。</p>
<h1 id="1-根文件系统">1 根文件系统</h1>
<p>根文件系统首先是一种文件系统，该文件系统不仅具有普通文件系统的存储数据文件的功能，但相对于普通的文件系统，它是内核启动时挂载（mount）的第一个文件系统，内核代码的映像文件保存在根文件系统中，内核程序会在根文件系统挂载之后从中把一些初始化脚本（如rcS,inittab）和服务加载到内存中运行。</p>
<p>linux可以支持多种形式的根文件系统，如<strong>initrd</strong>、<strong>initramfs</strong>等。站在启动镜像的角度看其实它们都是制作好的<strong>文件系统镜像</strong>，内核可以从特定的位置获取并挂载它们。</p>
<h2 id="11-initrd">1.1 initrd</h2>
<ul>
<li>
<p>介绍：initrd模拟一个磁盘，里面可以存放busybox生成的sh/init/inittab等文件，在prepare_namespace中被内核加载。initrd要求内核镜像包含该“磁盘”的文件系统驱动程序，如ext2、ext3</p>
</li>
<li>
<p>分类：CPIO-initrd、image-initrd</p>
</li>
<li>
<p>制作initrd文件：</p>
</li>
</ul>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-3">3</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>//CPIO-initrd格式镜像
</span></span><span style="display:flex;"><span>bash# find . | cpio -c -o &gt; ../initrd.img
</span></span><span style="display:flex;"><span>bash# gzip ../initrd.img
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-6">6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-7">7</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>//image-initrd格式镜像
</span></span><span style="display:flex;"><span>bash# dd <span style="color:#ff7b72">if</span><span style="color:#ff7b72;font-weight:bold">=</span>/dev/zero <span style="color:#79c0ff">of</span><span style="color:#ff7b72;font-weight:bold">=</span>../initrd.img <span style="color:#79c0ff">bs</span><span style="color:#ff7b72;font-weight:bold">=</span>512k <span style="color:#79c0ff">count</span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">5</span>
</span></span><span style="display:flex;"><span>bash# mkfs.ext2 -F -m0 ../initrd.img
</span></span><span style="display:flex;"><span>bash# mount -t ext2 -o loop ../initrd.img /mnt
</span></span><span style="display:flex;"><span>bash# cp -r rootfs /mnt
</span></span><span style="display:flex;"><span>bash# umount /mnt
</span></span><span style="display:flex;"><span>bash# gzip -9 ../initrd.img
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-initramfs">1.2 initramfs</h2>
<ul>
<li>介绍：initramfs是一个将rootfs打包成cpio的压缩包，通过initrd=命令行参数传递给内核。也可以通过CONFIG_INITRAMFS_SOURCE选项直接编译进内核</li>
</ul>
<p>通常根文件系统需要有init程序，在内核启动时被加载，作为系统的第一个进程。在嵌入式领域，通常使用busybox制作根文件系统</p>
<h2 id="13-rootfs制作">1.3 rootfs制作</h2>
<ul>
<li>
<p><strong>下载busybox</strong>
<a href="https://busybox.net/downloads/">download</a>  下载最新的busybox。</p>
</li>
<li>
<p><strong>解压busybox</strong></p>
</li>
</ul>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1">1</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># tar -xvf busybox-1.31.1.tar.bz2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>配置并编译busybox</strong></li>
</ul>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-4">4</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># make menuconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- CONFIG_PREFIX=/.../rootfs/ install</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>添加glibc库</strong></li>
</ul>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-2">2</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mkdir rootfs/lib</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># cp /usr/arm-linux-gnueabi/lib/* rootfs/lib/ -rfp</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>静态创建设备文件</strong></li>
</ul>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-6">6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-7">7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-8">8</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mkdir rootfs/dev</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># cd rootfs/dev</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mknod -m 666 tty1 c 4 1</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mknod -m 666 tty2 c 4 2</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mknod -m 666 tty3 c 4 3</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mknod -m 666 tty4 c 4 4</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mknod -m 666 console c 5 1</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mknod -m 666 null c 1 3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>制作SD卡文件系统镜像</strong></li>
</ul>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-5">5</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># dd if=/dev/zero of=rootfs.ext3 bs=1M count=32</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># mkfs.ext3 rootfs.ext3</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># sudo mount -t ext3 rootfs.ext3 /mnt -o loop</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># sudo cp -rf rootfs/* /mnt/</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"># sudo umount /mnt</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="2-linux内核启动">2 linux内核启动</h1>
<p>linux内核启动大致会经历uboot加载flash到内存、设置分段与分页、跳转到init/main.c执行start_kernel，初始化(内存、中断、块设备、时间、调度、缓存)等，最后调用rest_init拉起根文件系统的init程序，大致流程如下：
<img src="/image/linux_init/d3af90fcc1035f0f9e3aac36af0ee880.png" alt="d3af90fcc1035f0f9e3aac36af0ee880.png"></p>
<h2 id="21-start_kernel">2.1 start_kernel</h2>
<p>系统跳转到main.c文件后，首先进入start_kernel中完成系统初始化，来看看该函数中的源码实现。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-37">37</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifdef __cplusplus
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define CPP_ASMLINKAGE extern &#34;C&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define CPP_ASMLINKAGE
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define asmlinkage CPP_ASMLINKAGE
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define __init		__section(.init.text) __cold notrace
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/init/main.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>asmlinkage <span style="color:#ff7b72">void</span> __init <span style="color:#d2a8ff;font-weight:bold">start_kernel</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">trap_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 内存初始化 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">mm_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 中断初始化 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">init_IRQ</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 时钟初始化 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">init_timers</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">fork_init</span>(totalram_pages);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">proc_caches_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">buffer_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">key_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">security_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">dbg_late_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">vfs_caches_init</span>(totalram_pages);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">signals_init</span>();
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">ftrace_init</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* Do the rest non-__init&#39;ed, we&#39;re now alive */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rest_init</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们看到，strat_kernel与我们常见的函数定义有所不同，但是既然源码中这样用，肯定是没问题的。那这个asmlinkage与__init分别表示什么意思呢？</p>
<p>从asmlinkage的宏定义可以发现，常量最终被定义为“ extern &ldquo;C&rdquo; ”，表示以C语言的方式编译函数，该用法通常用在支持多语种的项目中，比如linux内核中，支持c、c++等语言，在c++的源码中调用c实现的函数就需要使用“ extern &ldquo;C&rdquo; ”字段</p>
<p>__init也是一个常量宏，与函数一起使用，表示指定该函数位于init段。在外设驱动编程中，__init被大量用于模块初始化。init段中的函数在init程序拉起过程中被do_initcalls函数调用。</p>
<p>除了init段，系统有那些段呢？在arm架构中，我们看到mm初始化时，打印了系统内存的分段情况。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-20">20</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/init.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>	<span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_NOTICE <span style="color:#a5d6ff">&#34;Virtual kernel memory layout:</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a5d6ff">&#34;    vector  : 0x%08lx - 0x%08lx   (%4ld kB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifdef CONFIG_HAVE_TCM
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#a5d6ff">&#34;    DTCM    : 0x%08lx - 0x%08lx   (%4ld kB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a5d6ff">&#34;    ITCM    : 0x%08lx - 0x%08lx   (%4ld kB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#a5d6ff">&#34;    fixmap  : 0x%08lx - 0x%08lx   (%4ld kB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifdef CONFIG_MMU
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#a5d6ff">&#34;    DMA     : 0x%08lx - 0x%08lx   (%4ld MB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#a5d6ff">&#34;    vmalloc : 0x%08lx - 0x%08lx   (%4ld MB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a5d6ff">&#34;    lowmem  : 0x%08lx - 0x%08lx   (%4ld MB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifdef CONFIG_HIGHMEM
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#a5d6ff">&#34;    pkmap   : 0x%08lx - 0x%08lx   (%4ld MB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#a5d6ff">&#34;    modules : 0x%08lx - 0x%08lx   (%4ld MB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a5d6ff">&#34;      .init : 0x%p&#34;</span> <span style="color:#a5d6ff">&#34; - 0x%p&#34;</span> <span style="color:#a5d6ff">&#34;   (%4d kB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a5d6ff">&#34;      .text : 0x%p&#34;</span> <span style="color:#a5d6ff">&#34; - 0x%p&#34;</span> <span style="color:#a5d6ff">&#34;   (%4d kB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a5d6ff">&#34;      .data : 0x%p&#34;</span> <span style="color:#a5d6ff">&#34; - 0x%p&#34;</span> <span style="color:#a5d6ff">&#34;   (%4d kB)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从函数命名我们不难发现，start_kernel函数调用了众多_init函数，以达到初始化操作系统的作用。今天我们先来分析init进程运行部分的内容，剩余知识部分待后续完善。</p>
<h2 id="22-rest_init">2.2 rest_init</h2>
<p>start_kernel函数在初始化系统后，调用rest_init函数创建1号进程。rest_init源码如下：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> noinline <span style="color:#ff7b72">void</span> __init_refok <span style="color:#d2a8ff;font-weight:bold">rest_init</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">int</span> pid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始化rcu同步机制 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_scheduler_starting</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 创建init与add线程，等待add线程起来后才允许运行init线程*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">kernel_thread</span>(kernel_init, NULL, CLONE_FS <span style="color:#ff7b72;font-weight:bold">|</span> CLONE_SIGHAND);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">numa_default_policy</span>();
</span></span><span style="display:flex;"><span>	pid <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">kernel_thread</span>(kthreadd, NULL, CLONE_FS <span style="color:#ff7b72;font-weight:bold">|</span> CLONE_FILES);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_read_lock</span>();
</span></span><span style="display:flex;"><span>	kthreadd_task <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">find_task_by_pid_ns</span>(pid, <span style="color:#ff7b72;font-weight:bold">&amp;</span>init_pid_ns);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">rcu_read_unlock</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">complete</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>kthreadd_done);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>rest_init函数主要干了两件事，创建kernel_init与kthreadd，也就是我们的1号进程与2号进程，在系统中查看所有进程可以验证。如下图所以：
<img src="/image/linux_init/492bd12265a42fad40ca9db77a02a12d.png" alt="492bd12265a42fad40ca9db77a02a12d.png"></p>
<p>rest_init函数通过调用kernel_thread函数创建进程，让我们来看看kernel_thread的实现</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-17">17</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/kernel/process.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">pid_t</span> <span style="color:#d2a8ff;font-weight:bold">kernel_thread</span>(<span style="color:#ff7b72">int</span> (<span style="color:#ff7b72;font-weight:bold">*</span>fn)(<span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span>), <span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span>arg, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> pt_regs regs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">memset</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>regs, <span style="color:#a5d6ff">0</span>, <span style="color:#ff7b72">sizeof</span>(regs));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	regs.ARM_r4 <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span>)arg;
</span></span><span style="display:flex;"><span>	regs.ARM_r5 <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span>)fn;
</span></span><span style="display:flex;"><span>	regs.ARM_r6 <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span>)kernel_thread_exit;
</span></span><span style="display:flex;"><span>	regs.ARM_r7 <span style="color:#ff7b72;font-weight:bold">=</span> SVC_MODE <span style="color:#ff7b72;font-weight:bold">|</span> PSR_ENDSTATE <span style="color:#ff7b72;font-weight:bold">|</span> PSR_ISETSTATE;
</span></span><span style="display:flex;"><span>	regs.ARM_pc <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span>)kernel_thread_helper;
</span></span><span style="display:flex;"><span>	regs.ARM_cpsr <span style="color:#ff7b72;font-weight:bold">=</span> regs.ARM_r7 <span style="color:#ff7b72;font-weight:bold">|</span> PSR_I_BIT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">do_fork</span>(flags<span style="color:#ff7b72;font-weight:bold">|</span>CLONE_VM<span style="color:#ff7b72;font-weight:bold">|</span>CLONE_UNTRACED, <span style="color:#a5d6ff">0</span>, <span style="color:#ff7b72;font-weight:bold">&amp;</span>regs, <span style="color:#a5d6ff">0</span>, NULL, NULL);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">EXPORT_SYMBOL</span>(kernel_thread);
</span></span></code></pre></td></tr></table>
</div>
</div><p>在arm架构中，kernel_thread函数与用户侧的fork函数类似，最终都是调用do_fork创建一个进程，do_fork相关原理请参考进程管理篇章</p>
<h2 id="23-kernel_init">2.3 kernel_init</h2>
<p>先来看看kernel_init函数的内部实现，源码如下：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-30">30</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/init/main.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> __init <span style="color:#d2a8ff;font-weight:bold">kernel_init</span>(<span style="color:#ff7b72">void</span> <span style="color:#ff7b72;font-weight:bold">*</span> unused)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 等待threadadd线程执行结束才运行init线程 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">wait_for_completion</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>kthreadd_done);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 完成编译进内核的驱动程序初始化、init区域所有函数执行*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">do_basic_setup</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">sys_open</span>((<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>) <span style="color:#a5d6ff">&#34;/dev/console&#34;</span>, O_RDWR, <span style="color:#a5d6ff">0</span>) <span style="color:#ff7b72;font-weight:bold">&lt;</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_WARNING <span style="color:#a5d6ff">&#34;Warning: unable to open an initial console.</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 复制上面打开的文件 分别作为标准输出、错误*/</span>
</span></span><span style="display:flex;"><span>	(<span style="color:#ff7b72">void</span>) <span style="color:#d2a8ff;font-weight:bold">sys_dup</span>(<span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>	(<span style="color:#ff7b72">void</span>) <span style="color:#d2a8ff;font-weight:bold">sys_dup</span>(<span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>ramdisk_execute_command)
</span></span><span style="display:flex;"><span>		ramdisk_execute_command <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;/init&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 通过判断rootfs是否存在init程序 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">sys_access</span>((<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>) ramdisk_execute_command, <span style="color:#a5d6ff">0</span>) <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>		ramdisk_execute_command <span style="color:#ff7b72;font-weight:bold">=</span> NULL;
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 加载根文件 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">prepare_namespace</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 运行根文件中的init程序 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">init_post</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>源码已经注释处理每个函数的调用说明，就不逐一解读。kernel_init在wait_for_completion阻塞等待kthreadd进程创建成功后才继续执行。kthread函数实现等会儿在看。</p>
<p>在sys_open处系统只打开了/dev/console文件，作为0号文件，通过复制0号文件创建了1、2号文件。/dev/console就是我们的终端，0、1、2三个文件分别称为标准输入（stdin）、标准输出（stdout）、标准错误（stderr)，所谓标准输入就是在程序中使用scanf()、fscanf（stdin，&hellip;），从哪个文件（设备）读取文件；标准输出、标准错误都是输出设备，前者对应printf()、fprintf(stdout,&hellip;)，后者对应fprintf(stderr,&hellip;)。</p>
<h3 id="231-do_basic_setup">2.3.1 do_basic_setup</h3>
<p>接着来看看do_basic_setup函数实现，源码如下：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-14">14</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> __init <span style="color:#d2a8ff;font-weight:bold">do_basic_setup</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">cpuset_init_smp</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">usermodehelper_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">init_tmpfs</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 初始化驱动模型中的各子系统，可见的现象是在/sys中出现的目录和文件 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">driver_init</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 在proc文件系统中创建irq目录，并在其中初始化系统中所有中断对应的目录 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">init_irq_proc</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 调用所有.ctors段内的函数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">do_ctors</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#8b949e;font-style:italic">/* 调用所有.init段内的函数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">do_initcalls</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>看着非常干净清爽，没有任何分支判断。在start_kernel中，内核完成了内存、定时器、中断等CPU上的硬件初始工作，在do_basic_setup中，内核完成了外设模块初始化并在虚拟根文件系统挂载了sys、proc等文件系统。最后调用do_initcalls函数循环编译外设模块存放在init段中的函数，完成外设模块device与driver匹配。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-57">57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-58">58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-59">59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-60">60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-61">61</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-62">62</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-63">63</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-64">64</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-65">65</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-66">66</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-67">67</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-68">68</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-69">69</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-70">70</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-71">71</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-72">72</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-73">73</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-74">74</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-75">75</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-76">76</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-77">77</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-78">78</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-79">79</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-80">80</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-81">81</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-82">82</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-83">83</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-84">84</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-85">85</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-86">86</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-87">87</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/include/asm-generic/vmlinux.lds.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define INITCALLS                                                 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcallearly.init)                                     
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">VMLINUX_SYMBOL</span>(__early_initcall_end) <span style="color:#ff7b72;font-weight:bold">=</span> .;                     
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall0.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall0s.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall1.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall1s.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall2.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall2s.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall3.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall3s.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall4.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall4s.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall5.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall5s.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcallrootfs.init)                                     
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall6.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall6s.init)                                       
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall7.init)                                      
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>(.initcall7s.init)
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define INIT_CALLS                                               
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>			<span style="color:#d2a8ff;font-weight:bold">VMLINUX_SYMBOL</span>(__initcall_start) <span style="color:#ff7b72;font-weight:bold">=</span> .;                   
</span></span><span style="display:flex;"><span>			INITCALLS                                     
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">VMLINUX_SYMBOL</span>(__initcall_end) <span style="color:#ff7b72;font-weight:bold">=</span> .;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> __init <span style="color:#d2a8ff;font-weight:bold">do_initcalls</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">initcall_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>fn;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">for</span> (fn <span style="color:#ff7b72;font-weight:bold">=</span> __early_initcall_end; fn <span style="color:#ff7b72;font-weight:bold">&lt;</span> __initcall_end; fn<span style="color:#ff7b72;font-weight:bold">++</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">do_one_initcall</span>(<span style="color:#ff7b72;font-weight:bold">*</span>fn);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/include/linux/init.h
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define __define_initcall(level,fn,id) \
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">	static initcall_t __initcall_##fn##id __used \
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">	__attribute__((__section__(&#34;.initcall&#34; level &#34;.init&#34;))) = fn
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define early_initcall(fn)		__define_initcall(&#34;early&#34;,fn,early)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define pure_initcall(fn)		__define_initcall(&#34;0&#34;,fn,0)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define rootfs_initcall(fn)		__define_initcall(&#34;rootfs&#34;,fn,rootfs)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define device_initcall(fn)		__define_initcall(&#34;6&#34;,fn,6)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define device_initcall_sync(fn)	__define_initcall(&#34;6s&#34;,fn,6s)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#define __initcall(fn) device_initcall(fn)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> __init <span style="color:#d2a8ff;font-weight:bold">populate_rootfs</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 先加载initramfs类型根文件 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">unpack_to_rootfs</span>(__initramfs_start, __initramfs_size);
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (err)
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">panic</span>(err);	<span style="color:#8b949e;font-style:italic">/* Failed to decompress INTERNAL initramfs */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (initrd_start) {
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifdef CONFIG_BLK_DEV_RAM
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>		<span style="color:#ff7b72">int</span> fd;
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 加载GPIO类型根文件 */</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">unpack_to_rootfs</span>((<span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>)initrd_start,
</span></span><span style="display:flex;"><span>			initrd_end <span style="color:#ff7b72;font-weight:bold">-</span> initrd_start);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>err) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">free_initrd</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>		} <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">clean_rootfs</span>();
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">unpack_to_rootfs</span>(__initramfs_start, __initramfs_size);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 加载image类型根文件 */</span>
</span></span><span style="display:flex;"><span>		fd <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">sys_open</span>((<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> __user __force <span style="color:#ff7b72;font-weight:bold">*</span>) <span style="color:#a5d6ff">&#34;/initrd.image&#34;</span>,
</span></span><span style="display:flex;"><span>			      O_WRONLY<span style="color:#ff7b72;font-weight:bold">|</span>O_CREAT, <span style="color:#a5d6ff">0700</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (fd <span style="color:#ff7b72;font-weight:bold">&gt;=</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">sys_write</span>(fd, (<span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>)initrd_start,
</span></span><span style="display:flex;"><span>					initrd_end <span style="color:#ff7b72;font-weight:bold">-</span> initrd_start);
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">sys_close</span>(fd);
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">free_initrd</span>();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>		<span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_INFO <span style="color:#a5d6ff">&#34;Unpacking initramfs...</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>);
</span></span><span style="display:flex;"><span>		err <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">unpack_to_rootfs</span>((<span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>)initrd_start,
</span></span><span style="display:flex;"><span>			initrd_end <span style="color:#ff7b72;font-weight:bold">-</span> initrd_start);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (err)
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_EMERG <span style="color:#a5d6ff">&#34;Initramfs unpacking failed: %s</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>, err);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">free_initrd</span>();
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">rootfs_initcall</span>(populate_rootfs);
</span></span></code></pre></td></tr></table>
</div>
</div><p>在do_initcalls函数中，调用了所有early等级之后的init函数。__early_initcall_end、__initcall_end在vmlinux.lds.h中被定义。在init.h文件中，还定义了一些宏控，负责把func函数放到init的不同级别中。由于在do_initcalls中，init级别从__early_initcall_end开始，依次向后遍历运行。所以在模块驱动开发中需要注意不同模块的优先级问题。</p>
<p>由于rootfs_initcall等级大于device_initcall，populate_rootfs函数加载根文件系统先被调用，用于加载系统根文件。函数分别尝试加载initramfs与initrd，当根文件为image-initrd类型镜像包时，内核在虚拟根目录创建一个initrd.image文件来保存image-initrd镜像内容，待后续在prepare_namespace函数中处理。</p>
<h3 id="232-prepare_namespace">2.3.2 prepare_namespace</h3>
<p>kernel_init执行完do_basic_setup调用后，若根目录下不存在init程序，会进到prepare_namespace函数中解析image-initrd镜像并挂载真正的根目录。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-14-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-14-27">27</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">void</span> __init <span style="color:#d2a8ff;font-weight:bold">prepare_namespace</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* saved_root_name在uboot阶段被赋值 root=/dev/rootfs */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (saved_root_name[<span style="color:#a5d6ff">0</span>]) {
</span></span><span style="display:flex;"><span>		root_device_name <span style="color:#ff7b72;font-weight:bold">=</span> saved_root_name;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">strncmp</span>(root_device_name, <span style="color:#a5d6ff">&#34;mtd&#34;</span>, <span style="color:#a5d6ff">3</span>) <span style="color:#ff7b72;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">strncmp</span>(root_device_name, <span style="color:#a5d6ff">&#34;ubi&#34;</span>, <span style="color:#a5d6ff">3</span>)) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">mount_block_root</span>(root_device_name, root_mountflags);
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		ROOT_DEV <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72">name_to_dev_t</span>(root_device_name);
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">strncmp</span>(root_device_name, <span style="color:#a5d6ff">&#34;/dev/&#34;</span>, <span style="color:#a5d6ff">5</span>) <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span>)
</span></span><span style="display:flex;"><span>			root_device_name <span style="color:#ff7b72;font-weight:bold">+=</span> <span style="color:#a5d6ff">5</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 挂载image-initrd的镜像并获取rootfs */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">initrd_load</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">goto</span> out;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 挂载根文件系统 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">mount_root</span>();
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">devtmpfs_mount</span>(<span style="color:#a5d6ff">&#34;dev&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sys_mount</span>(<span style="color:#a5d6ff">&#34;.&#34;</span>, <span style="color:#a5d6ff">&#34;/&#34;</span>, NULL, MS_MOVE, NULL);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">sys_chroot</span>((<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> __user __force <span style="color:#ff7b72;font-weight:bold">*</span>)<span style="color:#a5d6ff">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>根文件挂载相关源码解读<a href="https://zhuanlan.zhihu.com/p/489819324">参考</a></p>
<h3 id="233-init_post">2.3.3 init_post</h3>
<p>加载完根文件后，kernel_init进到init_post函数，尝试执行根文件中的init函数</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-56">56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-57">57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-58">58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-59">59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-60">60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-15-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-15-61">61</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> noinline <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">init_post</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 下面函数都是执行init函数 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (ramdisk_execute_command) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">run_init_process</span>(ramdisk_execute_command);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_WARNING <span style="color:#a5d6ff">&#34;Failed to execute %s</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span>				ramdisk_execute_command);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> (execute_command) {
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">run_init_process</span>(execute_command);
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_WARNING <span style="color:#a5d6ff">&#34;Failed to execute %s.  Attempting &#34;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#a5d6ff">&#34;defaults...</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>, execute_command);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">run_init_process</span>(<span style="color:#a5d6ff">&#34;/sbin/init&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">run_init_process</span>(<span style="color:#a5d6ff">&#34;/etc/init&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">run_init_process</span>(<span style="color:#a5d6ff">&#34;/bin/init&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">run_init_process</span>(<span style="color:#a5d6ff">&#34;/bin/sh&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">panic</span>(<span style="color:#a5d6ff">&#34;No init found.  Try passing init= option to kernel. &#34;</span>
</span></span><span style="display:flex;"><span>	      <span style="color:#a5d6ff">&#34;See Linux Documentation/init.txt for guidance.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">run_init_process</span>(<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>init_filename)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	argv_init[<span style="color:#a5d6ff">0</span>] <span style="color:#ff7b72;font-weight:bold">=</span> init_filename;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">kernel_execve</span>(init_filename, argv_init, envp_init);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/rch/arm/kernel/sys_arm.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">kernel_execve</span>(<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>filename,
</span></span><span style="display:flex;"><span>		  <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#ff7b72">const</span> argv[],
</span></span><span style="display:flex;"><span>		  <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#ff7b72">const</span> envp[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> pt_regs regs;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 执行init程序 */</span>
</span></span><span style="display:flex;"><span>	ret <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">do_execve</span>(filename,
</span></span><span style="display:flex;"><span>			(<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> __user <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#ff7b72">const</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>)argv,
</span></span><span style="display:flex;"><span>			(<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> __user <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#ff7b72">const</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>)envp, <span style="color:#ff7b72;font-weight:bold">&amp;</span>regs);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 返回用户态，而不是函数调用方 */</span>
</span></span><span style="display:flex;"><span>	regs.ARM_r0 <span style="color:#ff7b72;font-weight:bold">=</span> ret;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">asm</span>(	<span style="color:#a5d6ff">&#34;add	r0, %0, %1</span><span style="color:#79c0ff">\n\t</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a5d6ff">&#34;mov	r1, %2</span><span style="color:#79c0ff">\n\t</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a5d6ff">&#34;mov	r2, %3</span><span style="color:#79c0ff">\n\t</span><span style="color:#a5d6ff">&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a5d6ff">&#34;bl	memmove</span><span style="color:#79c0ff">\n\t</span><span style="color:#a5d6ff">&#34;</span>	<span style="color:#8b949e;font-style:italic">/* copy regs to top of stack */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a5d6ff">&#34;mov	r8, #0</span><span style="color:#79c0ff">\n\t</span><span style="color:#a5d6ff">&#34;</span>	<span style="color:#8b949e;font-style:italic">/* not a syscall */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a5d6ff">&#34;mov	r9, %0</span><span style="color:#79c0ff">\n\t</span><span style="color:#a5d6ff">&#34;</span>	<span style="color:#8b949e;font-style:italic">/* thread structure */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a5d6ff">&#34;mov	sp, r0</span><span style="color:#79c0ff">\n\t</span><span style="color:#a5d6ff">&#34;</span>	<span style="color:#8b949e;font-style:italic">/* reposition stack pointer */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a5d6ff">&#34;b	ret_to_user&#34;</span>  <span style="color:#8b949e;font-style:italic">/* 切换到用户态 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;r&#34;</span> (<span style="color:#d2a8ff;font-weight:bold">current_thread_info</span>()),
</span></span><span style="display:flex;"><span>		  <span style="color:#a5d6ff">&#34;Ir&#34;</span> (THREAD_START_SP <span style="color:#ff7b72;font-weight:bold">-</span> <span style="color:#ff7b72">sizeof</span>(regs)),
</span></span><span style="display:flex;"><span>		  <span style="color:#a5d6ff">&#34;r&#34;</span> (<span style="color:#ff7b72;font-weight:bold">&amp;</span>regs),
</span></span><span style="display:flex;"><span>		  <span style="color:#a5d6ff">&#34;Ir&#34;</span> (<span style="color:#ff7b72">sizeof</span>(regs))
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72;font-weight:bold">:</span> <span style="color:#a5d6ff">&#34;r0&#34;</span>, <span style="color:#a5d6ff">&#34;r1&#34;</span>, <span style="color:#a5d6ff">&#34;r2&#34;</span>, <span style="color:#a5d6ff">&#34;r3&#34;</span>, <span style="color:#a5d6ff">&#34;ip&#34;</span>, <span style="color:#a5d6ff">&#34;lr&#34;</span>, <span style="color:#a5d6ff">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中do_execve是用户侧execve函数的系统调用。虽然kernel_execve与execve都实现了在进程中调用其他二进制程序的功能，两者的差异为kernel_execve是从内核态到用户态，execve是从用户态到内核态</p>
<p>ARM 处理器一般共有 37 个寄存器，包括31 个通用寄存器与6 个状态寄存器
<strong>R0-R3:</strong> 用作传入函数参数，传出函数返回值
<strong>R4-R11:</strong> 用来存放函数的局部变量
<strong>R12:</strong> 内部调用暂时寄存器 ip
<strong>R13:</strong> 栈指针 sp
<strong>R14:</strong> 链接寄存器 lr
<strong>R15:</strong> 程序计数器 PC
<strong>CPSR(Current Program Status Register):</strong> 程序状态寄存器，其低5位控制当前程序的处理器模式，如下所示</p>
<table>
<thead>
<tr>
<th>value</th>
<th style="text-align:center">mode</th>
</tr>
</thead>
<tbody>
<tr>
<td>0b10000</td>
<td style="text-align:center">用户模式</td>
</tr>
<tr>
<td>0b10001</td>
<td style="text-align:center">FIQ模式</td>
</tr>
<tr>
<td>0b10010</td>
<td style="text-align:center">IRQ模式</td>
</tr>
<tr>
<td>0b10011</td>
<td style="text-align:center">管理模式</td>
</tr>
<tr>
<td>0b10111</td>
<td style="text-align:center">中止模式</td>
</tr>
<tr>
<td>0b11011</td>
<td style="text-align:center">未定义模式</td>
</tr>
<tr>
<td>0b11111</td>
<td style="text-align:center">系统模式</td>
</tr>
</tbody>
</table>
<h3 id="234-init">2.3.4 init</h3>
<p>在嵌入式领域，我们通常使用busybox来制作根文件系统，busybox是一套开源的将许多具有共性的小版本的UNIX工具结合到一个单一的可执行文件，比如我们常用的shell命令、根文件init程序等。在busybox源码目录下，可以找到init程序的源码实现：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-16-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-16-20">20</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// busybox/init/init.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">init_main</span>(<span style="color:#ff7b72">int</span> argc UNUSED_PARAM, <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>				<span style="color:#8b949e;font-style:italic">/* 加载inittab文件的 */</span>
</span></span><span style="display:flex;"><span>		   <span style="color:#d2a8ff;font-weight:bold">parse_inittab</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#8b949e;font-style:italic">/* 运行指定action相关的脚本文件 */</span>
</span></span><span style="display:flex;"><span>		   <span style="color:#d2a8ff;font-weight:bold">run_actions</span>(SYSINIT);
</span></span><span style="display:flex;"><span>		   <span style="color:#d2a8ff;font-weight:bold">run_actions</span>(WAIT);
</span></span><span style="display:flex;"><span>		   <span style="color:#d2a8ff;font-weight:bold">run_actions</span>(ONCE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		   <span style="color:#ff7b72">while</span> (<span style="color:#a5d6ff">1</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">run_actions</span>(RESPAWN);
</span></span><span style="display:flex;"><span>			<span style="color:#d2a8ff;font-weight:bold">run_actions</span>(ASKFIRST);
</span></span><span style="display:flex;"><span>			wpid <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">wait</span>(NULL);    
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">while</span> (wpid <span style="color:#ff7b72;font-weight:bold">&gt;</span> <span style="color:#a5d6ff">0</span>) {
</span></span><span style="display:flex;"><span>				a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pid <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;  
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上是init_main中核心部分，最后我们看到init_main进入了死循环，通过wait函数等待回收用户侧创建的进程资源。这符合孤儿进程被init进程回收的逻辑。继续看init_main函数的核心函数parse_inittab</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-17-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-17-51">51</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">parse_inittab</span>(<span style="color:#ff7b72">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>token[<span style="color:#a5d6ff">4</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 打开inittab文件 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">parser_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>parser <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">config_open2</span>(<span style="color:#a5d6ff">&#34;/etc/inittab&#34;</span>, fopen_for_read);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#if ENABLE_FEATURE_USE_INITTAB
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>	<span style="color:#8b949e;font-style:italic">/* 逐行读取inittab内容并将4个字段解析到token指针数组中 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">while</span> (<span style="color:#d2a8ff;font-weight:bold">config_read</span>(parser, token, <span style="color:#a5d6ff">4</span>, <span style="color:#a5d6ff">0</span>, <span style="color:#a5d6ff">&#34;#:&#34;</span>,PARSE_NORMAL <span style="color:#ff7b72;font-weight:bold">&amp;</span> <span style="color:#ff7b72;font-weight:bold">~</span>(PARSE_TRIM <span style="color:#ff7b72;font-weight:bold">|</span>PARSE_COLLAPSE))) 
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">static</span> <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> actions[] ALIGN1 <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#34;sysinit</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;&#34;wait</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;&#34;once</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;&#34;respawn</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;&#34;askfirst</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;</span> <span style="color:#a5d6ff">&#34;ctrlaltdel</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;&#34;shutdown</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;&#34;restart</span><span style="color:#79c0ff">\0</span><span style="color:#a5d6ff">&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">int</span> action;
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>tty <span style="color:#ff7b72;font-weight:bold">=</span> token[<span style="color:#a5d6ff">0</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		action <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">index_in_strings</span>(actions, token[<span style="color:#a5d6ff">2</span>]);
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 将解析后的内容放置到一个全局变量中 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d2a8ff;font-weight:bold">new_init_action</span>(<span style="color:#a5d6ff">1</span> <span style="color:#ff7b72;font-weight:bold">&lt;&lt;</span> action, token[<span style="color:#a5d6ff">3</span>], tty);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 关闭inittab文件 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">config_close</span>(parser);
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// busybox/example/inittab
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic"># /etc/inittab init(8) configuration for BusyBox
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># Format for each entry: &lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># &lt;id&gt;: The id field is used by BusyBox init to specify the controlling tty for
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#	the specified process to run on. There is no need for this field to 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#	be unique, although if it isn&#39;t you may have strange results.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># &lt;runlevels&gt;: The runlevels field is completely ignored.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># &lt;action&gt;: Valid actions include: sysinit, respawn, askfirst, wait, once,
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#                                  restart, ctrlaltdel, and shutdown.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># &lt;process&gt;: Specifies the process to be executed and it&#39;s command line.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">::</span><span style="color:#79c0ff;font-weight:bold">sysinit</span>:<span style="color:#ff7b72;font-weight:bold">/</span>etc<span style="color:#ff7b72;font-weight:bold">/</span>init.d<span style="color:#ff7b72;font-weight:bold">/</span>rcS
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">::</span><span style="color:#79c0ff;font-weight:bold">shutdown</span>:<span style="color:#ff7b72;font-weight:bold">/</span>etc<span style="color:#ff7b72;font-weight:bold">/</span>init.d<span style="color:#ff7b72;font-weight:bold">/</span>shutdown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># Stuff to do when restarting the init proces
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span><span style="color:#ff7b72;font-weight:bold">::</span><span style="color:#79c0ff;font-weight:bold">restart</span>:<span style="color:#ff7b72;font-weight:bold">/</span>sbin<span style="color:#ff7b72;font-weight:bold">/</span>init
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># Below here we append init action by each process Makefile
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"># 
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>ttyS0<span style="color:#ff7b72;font-weight:bold">::</span><span style="color:#79c0ff;font-weight:bold">respawn</span>:<span style="color:#ff7b72;font-weight:bold">/</span>bin<span style="color:#ff7b72;font-weight:bold">/</span>login <span style="color:#ff7b72;font-weight:bold">-</span>p
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">ttyS0</span>:<span style="color:#79c0ff;font-weight:bold">linux</span>:<span style="color:#ff7b72;font-weight:bold">/</span>bin<span style="color:#ff7b72;font-weight:bold">/</span>sh
</span></span><span style="display:flex;"><span><span style="color:#ff7b72;font-weight:bold">::</span><span style="color:#79c0ff;font-weight:bold">respawn</span>:<span style="color:#ff7b72;font-weight:bold">/</span>bin<span style="color:#ff7b72;font-weight:bold">/</span>inetd
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现parse_inittab主要作用是解析/etc/inittab文件，打开这个文件开发里面的内容。这是一个init的配置文件，通过四个参数定义了配置文件的格式，<strong>id</strong>表示终端，标准输入输出和错误、<strong>runlevels</strong>可以忽略、<strong>action</strong>是程序执行的时机，有8组值、<strong>process</strong>表示将要执行的应用程序或脚本</p>
<p>打开与读取/etc/inittab文件信息后，继续看new_init_action函数</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-18-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-18-42">42</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">struct</span> init_action {
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> init_action <span style="color:#ff7b72;font-weight:bold">*</span>next;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">pid_t</span> pid;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">uint8_t</span> action_type;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">char</span> terminal[CONSOLE_NAME_SIZE];
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">char</span> command[<span style="color:#a5d6ff">1</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">struct</span> init_action <span style="color:#ff7b72;font-weight:bold">*</span>init_action_list <span style="color:#ff7b72;font-weight:bold">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">new_init_action</span>(<span style="color:#ff7b72">uint8_t</span> action_type, <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>command, <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>cons)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">struct</span> init_action <span style="color:#ff7b72;font-weight:bold">*</span>a, <span style="color:#ff7b72;font-weight:bold">**</span>nextp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	nextp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>init_action_list;
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">while</span> ((a <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">*</span>nextp) <span style="color:#ff7b72;font-weight:bold">!=</span> NULL) {
</span></span><span style="display:flex;"><span>		<span style="color:#8b949e;font-style:italic">/* 循环遍历init_action_list 找到相同的立刻退出循环 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">strcmp</span>(a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>command, command) <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span> <span style="color:#d2a8ff;font-weight:bold">strcmp</span>(a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>terminal, cons) <span style="color:#ff7b72;font-weight:bold">==</span> <span style="color:#a5d6ff">0</span>
</span></span><span style="display:flex;"><span>		) {
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* Remove from list */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72;font-weight:bold">*</span>nextp <span style="color:#ff7b72;font-weight:bold">=</span> a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next;
</span></span><span style="display:flex;"><span>			<span style="color:#8b949e;font-style:italic">/* Find the end of the list */</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">while</span> (<span style="color:#ff7b72;font-weight:bold">*</span>nextp <span style="color:#ff7b72;font-weight:bold">!=</span> NULL)
</span></span><span style="display:flex;"><span>				nextp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>(<span style="color:#ff7b72;font-weight:bold">*</span>nextp)<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next;
</span></span><span style="display:flex;"><span>			a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next <span style="color:#ff7b72;font-weight:bold">=</span> NULL;
</span></span><span style="display:flex;"><span>			<span style="color:#ff7b72">goto</span> append;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		nextp <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>next;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8b949e;font-style:italic">/* 发现是全新的cmd将其加入到list链表中 */</span>
</span></span><span style="display:flex;"><span>	a <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">xzalloc</span>(<span style="color:#ff7b72">sizeof</span>(<span style="color:#ff7b72;font-weight:bold">*</span>a) <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#d2a8ff;font-weight:bold">strlen</span>(command));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#79c0ff;font-weight:bold">append</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72;font-weight:bold">*</span>nextp <span style="color:#ff7b72;font-weight:bold">=</span> a;
</span></span><span style="display:flex;"><span>	a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>action_type <span style="color:#ff7b72;font-weight:bold">=</span> action_type;
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">strcpy</span>(a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>command, command);
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">safe_strncpy</span>(a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>terminal, cons, <span style="color:#ff7b72">sizeof</span>(a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>terminal));
</span></span><span style="display:flex;"><span>	<span style="color:#d2a8ff;font-weight:bold">dbg_message</span>(L_LOG <span style="color:#ff7b72;font-weight:bold">|</span> L_CONSOLE, <span style="color:#a5d6ff">&#34;command=&#39;%s&#39; action=%x tty=&#39;%s&#39;</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span>		a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>command, a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>action_type, a<span style="color:#ff7b72;font-weight:bold">-&gt;</span>terminal);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>new_init_action函数负责将inittab文件解析出来的action与process加入到init_action_list全局变量中，所有的init_action_list变量组成了一个链表结构。</p>
<p>parse_inittab函数完成后，init_main依次调用SYSINIT、WAIT、ONCE、RESPAWN、ASKFIRST运行时对应的process</p>
<h2 id="24--rtl_sdk的rcs文件">2.4  RTL_SDK的rcS文件</h2>
<p>接下来我们来主要看看/etc/inittab文件中SYSINIT等级的运行时对应的process。rcS文件是一个shell脚本文件，在RTL_SDK_v2.2.0.10中，rcS实现如下：</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-19-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-19-26">26</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// RTL_SDK_v2.2.0.10/sdk/romfs_nostrip/etc/init.d/rcS
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#8b949e;font-weight:bold;font-style:italic">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">## invoid to do rcS twice when system already up ##
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>startRunFile<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">&#34;/var/run/.start_up_run_file&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">/* 如果文件已经存在，立刻退出脚本，保证脚本程序只运行一次 */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">if</span> [ <span style="color:#ff7b72;font-weight:bold">-</span>f <span style="color:#f85149">$</span>startRunFile ]; then
</span></span><span style="display:flex;"><span>	echo <span style="color:#a5d6ff">&#34;*********** SYSTEM ALREADY UP *************&#34;</span>
</span></span><span style="display:flex;"><span>	exit <span style="color:#a5d6ff">1</span>
</span></span><span style="display:flex;"><span>fi 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#ff7b72;font-weight:bold">===</span> Start to run rc0 <span style="color:#ff7b72;font-weight:bold">~</span> rc63 <span style="color:#ff7b72;font-weight:bold">===</span>
</span></span><span style="display:flex;"><span>i<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#a5d6ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">/* 依次运行rc0、rc1...rc64脚本文件 */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">while</span> [ <span style="color:#a5d6ff">&#34;$i&#34;</span> <span style="color:#ff7b72;font-weight:bold">!=</span> <span style="color:#a5d6ff">&#34;64&#34;</span> ]
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">do</span>
</span></span><span style="display:flex;"><span>	rc_file<span style="color:#ff7b72;font-weight:bold">=/</span>etc<span style="color:#ff7b72;font-weight:bold">/</span>init.d<span style="color:#ff7b72;font-weight:bold">/</span>rc<span style="color:#f85149">$</span>i
</span></span><span style="display:flex;"><span>	<span style="color:#ff7b72">if</span> [ <span style="color:#ff7b72;font-weight:bold">-</span>f <span style="color:#a5d6ff">&#34;$rc_file&#34;</span> ]; then 
</span></span><span style="display:flex;"><span>		echo <span style="color:#a5d6ff">&#34;----- do_rc [$rc_file] -----&#34;</span>	
</span></span><span style="display:flex;"><span>		sh <span style="color:#f85149">$</span>rc_file
</span></span><span style="display:flex;"><span>	fi	
</span></span><span style="display:flex;"><span>	i<span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149">$</span>((<span style="color:#f85149">$</span>i<span style="color:#ff7b72;font-weight:bold">+</span><span style="color:#a5d6ff">1</span>))
</span></span><span style="display:flex;"><span>done
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">/* 创建&#34;/var/run/.start_up_run_file&#34;文件 表明系统已经运行*/</span>
</span></span><span style="display:flex;"><span>touch <span style="color:#f85149">$</span>startRunFile
</span></span></code></pre></td></tr></table>
</div>
</div><p>在RTL_SDK_v2.2.0.10/sdk/romfs_nostrip/etc/init.d/rcS中，rc0~rc64脚本文件的主要实现包括：</p>
<p><strong>rc3</strong></p>
<p>/etc/scripts/check_province.sh   //检测区域码，导入etc\province下不同配置。</p>
<p>configd -D        //configd是配置mib相关的进程,其它进程通过msg到configd来操作mib</p>
<p>/etc/scripts/rtkbosa.sh //加载板载bosa驱动</p>
<p>/etc/insdrv.sh    //加载pon驱动</p>
<p>/etc/runsdk.sh   // 通过pon类型，运行epon/gpon相关程序</p>
<p><strong>rc18</strong></p>
<p>/bin/systemd&amp;   //wan口状态，OAM/OMCI状态，PPPoE/DHCP状态</p>
<p><strong>rc32</strong></p>
<p>startup -d &amp;    //开机配置进程，例如会配置wan连接，启动web服务器，tr069，dbus等</p>
<p><strong>rc34</strong></p>
<p>/etc/scripts/rcm_voip&amp; //启动VOIP</p>
<p><strong>参考资料</strong></p>
<p><a href="https://www.cnblogs.com/CrazyCatJack/p/6184564.html">Linux根文件系统分析之init和busybox</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/489819324">Linux内核中根文件系统挂载流程</a></p>
<p><a href="https://blog.csdn.net/yangguoyu8023/article/details/121246788?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167324452416782427466011%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=167324452416782427466011&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-121246788-null-null.blog_rank_default&amp;utm_term=%E5%86%85%E6%A0%B8%E5%90%AF%E5%8A%A8&amp;spm=1018.2226.3001.4450">ARM64的内核启动过程</a></p>
<p><a href="https://elixir.bootlin.com/linux/latest/source">在线Linux源码</a></p>
<p><!-- raw HTML omitted -->dgwu | 文 【原创】</p>
<p>如果本篇博客有任何错误，请批评指教，不胜感激 ！<!-- raw HTML omitted --></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">dgwu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2023-01-13
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>



    
    


    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://Breeze-Wu.github.io/tags/linux/">linux</a>
            
        </div>


      
      <nav class="post-nav">
        
          <a class="prev" href="/post/openwrt%E4%B8%8A%E4%BB%A3%E7%A0%81debug/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">openwrt上debug方法总结</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
      </nav>
    </footer>
  </article>

  
  


  
  

  

  
  

  
  

  

  

    

  

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:your@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="twitch"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 36 36" version="1.1" width="36" height="36" id="svg8">
  <path
      style=""
      d="M 10,32.5 C 10,30.309524 9.5666667,30 6.5,30 H 3 V 18.196167 6.3923336 L 6.2976072,3.1961668 9.5952145,0 H 21.297607 33 v 9.2813035 9.2813035 l -5.778997,5.718696 C 23.230948,28.229724 20.653654,30 18.895317,30 17.471816,30 15.312792,31.102597 14,32.5 12.708255,33.875 11.279813,35 10.825686,35 10.371559,35 10,33.875 10,32.5 Z M 23.12736,22 c 1.432033,0 3.645397,-1.197147 5.185549,-2.804719 C 30.682196,16.722278 31,15.598708 31,9.6952811 V 3 H 20.5 10 v 9.5 9.5 h 3 c 2.413503,0 3,0.425076 3,2.174314 v 2.174314 l 2.314451,-2.174314 C 19.587399,22.978441 21.753208,22 23.12736,22 Z M 17.666667,14.333333 C 17.3,13.966667 17,12.166667 17,10.333333 17,8.037037 17.466667,7 18.5,7 c 1.083333,0 1.5,1.1111111 1.5,4 0,3.753437 -0.7878,4.878866 -2.333333,3.333333 z m 6.722867,-0.760607 C 23.554137,11.395717 24.34722,7.7069709 25.75,7.2449946 26.613128,6.9607414 27,8.097114 27,10.916667 c 0,3.979702 -1.51214,5.518252 -2.610466,2.656059 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://Breeze-Wu.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2023
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        dgwu
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.fe83e11b4fbc9193d67e2c9db78bad21f8dc59fca0cacd8c1c3bb071bb16a852.js" integrity="sha256-/oPhG0&#43;8kZPWfiydt4utIfjcWfygys2MHDuwcbsWqFI=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  

















</body>
</html>
