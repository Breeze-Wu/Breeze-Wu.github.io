<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>linux系统信号实现 - dgwu - A super concise theme for Hugo</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="dgwu" />
  <meta name="description" content="摘要 上一篇我们讨论了系统调试三种应对不同阶段的方法，最后以一个断错误的例子，带领读者动手使用三种工具，这编文章我们聊断错误的原理是什么，li" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.109.0" />


<link rel="canonical" href="https://Breeze-Wu.github.io/post/linux%E7%B3%BB%E7%BB%9F%E4%BF%A1%E5%8F%B7%E5%AE%9E%E7%8E%B0/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.de22abc00de44766eebd1054fd9e0b254b071f89d5019044f893c484a9249a8d.css" integrity="sha256-3iKrwA3kR2buvRBU/Z4LJUsHH4nVAZBE&#43;JPEhKkkmo0=" media="screen" crossorigin="anonymous">







<meta property="og:title" content="linux系统信号实现" />
<meta property="og:description" content="摘要 上一篇我们讨论了系统调试三种应对不同阶段的方法，最后以一个断错误的例子，带领读者动手使用三种工具，这编文章我们聊断错误的原理是什么，li" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Breeze-Wu.github.io/post/linux%E7%B3%BB%E7%BB%9F%E4%BF%A1%E5%8F%B7%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-10-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-10-02T00:00:00+00:00" />
<meta itemprop="name" content="linux系统信号实现">
<meta itemprop="description" content="摘要 上一篇我们讨论了系统调试三种应对不同阶段的方法，最后以一个断错误的例子，带领读者动手使用三种工具，这编文章我们聊断错误的原理是什么，li"><meta itemprop="datePublished" content="2022-10-02T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-10-02T00:00:00+00:00" />
<meta itemprop="wordCount" content="5521">
<meta itemprop="keywords" content="linux," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="linux系统信号实现"/>
<meta name="twitter:description" content="摘要 上一篇我们讨论了系统调试三种应对不同阶段的方法，最后以一个断错误的例子，带领读者动手使用三种工具，这编文章我们聊断错误的原理是什么，li"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">dgwu</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      dgwu
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">linux系统信号实现</h1>
      

      <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          dgwu
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2022-10-02">
      2022-10-02
    </time>
  </div>

  


  <div class="post-meta__right">
    

    


    
    


    
    
  </div>
</div>

    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#11-用户模式">1.1 用户模式：</a></li>
    <li><a href="#12-内核模式">1.2 内核模式：</a></li>
  </ul>

  <ul>
    <li><a href="#21-信号数据结构">2.1 信号数据结构</a></li>
    <li><a href="#22-信号发送">2.2 信号发送</a></li>
    <li><a href="#23-信号执行">2.3 信号执行</a></li>
  </ul>
</nav>
  </div>
</div>


    
    <div class="post-content">
      <h1 id="摘要">摘要</h1>
<p>上一篇我们讨论了系统调试三种应对不同阶段的方法，最后以一个断错误的例子，带领读者动手使用三种工具，这编文章我们聊断错误的原理是什么，linux内核在其中充当了什么角色？带着上述问题，让我们一起一探究竟吧。</p>
<h1 id="1触发sigsegv信号">1、触发SIGSEGV信号</h1>
<p>让我们一起来回顾下段错误的那段demo，在使用gdb调试core文件时，gbd输出了段错误的源码位置和应用程序终止的原因。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-11">11</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>neo<span style="color:#f85149">@</span><span style="color:#79c0ff;font-weight:bold">neo</span>:<span style="color:#ff7b72;font-weight:bold">~/</span>work<span style="color:#ff7b72;font-weight:bold">/</span>c_program<span style="color:#f85149">$</span> gdb .<span style="color:#ff7b72;font-weight:bold">/</span>demo core
</span></span><span style="display:flex;"><span>GNU <span style="color:#d2a8ff;font-weight:bold">gdb</span> (Ubuntu <span style="color:#a5d6ff">7.7.1</span><span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#a5d6ff">0u</span>buntu5<span style="color:#ff7b72;font-weight:bold">~</span><span style="color:#a5d6ff">14.04.3</span>) <span style="color:#a5d6ff">7.7.1</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Core was generated by <span style="color:#f85149">`</span>.<span style="color:#ff7b72;font-weight:bold">/</span>demo<span style="color:#f85149">&#39;</span>.
</span></span><span style="display:flex;"><span>Program terminated with signal SIGSEGV, Segmentation fault.
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#0  0x0000000000400578 in test_three () at segmfaultTest.c:21
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span><span style="color:#a5d6ff">21</span>          pt[<span style="color:#a5d6ff">0</span>] <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">&#39;T&#39;</span>;
</span></span><span style="display:flex;"><span>(gdb) bt
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#0  0x0000000000400578 in test_three () at segmfaultTest.c:21
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#1  0x000000000040059f in main () at segmfaultTest.c:28
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>(gdb) 
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码第5行说明应用程序接收了一个SIGSEGV的信号，使程序终止。
引用百度百科介绍，SIGSEGV是当一个进程执行了一个无效的内存引用，或发生段错误时操作系统发送给进程的信号。</p>
<p>在linux-2.6.39的源码中查找SIGSEGV，可以得到如下信息</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-16">16</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">struct</span> fsr_info {
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">int</span>     (<span style="color:#ff7b72;font-weight:bold">*</span>fn)(<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> fsr, <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs);
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">int</span>     sig;
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">int</span>     code;
</span></span><span style="display:flex;"><span>        <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>name;
</span></span><span style="display:flex;"><span>} fsr_info[] <span style="color:#ff7b72;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        { do_translation_fault, SIGSEGV, SEGV_MAPERR,   <span style="color:#a5d6ff">&#34;section translation fault&#34;</span>        },
</span></span><span style="display:flex;"><span>        { do_bad,               SIGBUS,  <span style="color:#a5d6ff">0</span>,             <span style="color:#a5d6ff">&#34;external abort on linefetch&#34;</span>      },
</span></span><span style="display:flex;"><span>        { do_page_fault,        SIGSEGV, SEGV_MAPERR,   <span style="color:#a5d6ff">&#34;page translation fault&#34;</span>           },
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>        { do_sect_fault,        SIGSEGV, SEGV_ACCERR,   <span style="color:#a5d6ff">&#34;section permission fault&#34;</span>         },
</span></span><span style="display:flex;"><span>        { do_bad,               SIGBUS,  <span style="color:#a5d6ff">0</span>,             <span style="color:#a5d6ff">&#34;external abort on translation&#34;</span>    },
</span></span><span style="display:flex;"><span>        { do_page_fault,        SIGSEGV, SEGV_ACCERR,   <span style="color:#a5d6ff">&#34;page permission fault&#34;</span>            },
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></td></tr></table>
</div>
</div><p>可见SIGSEGV信号在fsr_info结构中定义，共有四种类型系统错误会触发段错误。</p>
<ul>
<li><strong>do_bad：不做处理，直接返回1</strong></li>
<li><strong>do_translation_fault：找不到页表错误</strong></li>
<li><strong>do_page_fault：线性地址无效，没有对应的物理地址或者页权限错误</strong></li>
<li><strong>do_sect_fault：错误地址域</strong>
do_page_fault完成进程物理地址重新分配功能，与此次信号处理关联不大，待后续介绍内存管理篇章在行解读。</li>
</ul>
<p>do_translation_fault</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-2-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-2-51">51</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> __kprobes
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">do_translation_fault</span>(<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> fsr,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> index;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">pgd_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>pgd, <span style="color:#ff7b72;font-weight:bold">*</span>pgd_k;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">pud_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>pud, <span style="color:#ff7b72;font-weight:bold">*</span>pud_k;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">pmd_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>pmd, <span style="color:#ff7b72;font-weight:bold">*</span>pmd_k;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* addr地址在用户空间 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (addr <span style="color:#ff7b72;font-weight:bold">&lt;</span> TASK_SIZE)
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">return</span> <span style="color:#d2a8ff;font-weight:bold">do_page_fault</span>(addr, fsr, regs);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#8b949e;font-style:italic">/* 现在代码在内核中，如果regs是用户态与当前内核位置冲突
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         调用bad_area*/</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">user_mode</span>(regs))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">goto</span> bad_area;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> index <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">pgd_index</span>(addr);
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* 一级页表 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> pgd <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">cpu_get_pgd</span>() <span style="color:#ff7b72;font-weight:bold">+</span> index;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> pgd_k <span style="color:#ff7b72;font-weight:bold">=</span> init_mm.pgd <span style="color:#ff7b72;font-weight:bold">+</span> index;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">pgd_none</span>(<span style="color:#ff7b72;font-weight:bold">*</span>pgd_k))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">goto</span> bad_area;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">pgd_present</span>(<span style="color:#ff7b72;font-weight:bold">*</span>pgd))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">set_pgd</span>(pgd, <span style="color:#ff7b72;font-weight:bold">*</span>pgd_k);
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* 二级页表 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> pud <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">pud_offset</span>(pgd, addr);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> pud_k <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">pud_offset</span>(pgd_k, addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">pud_none</span>(<span style="color:#ff7b72;font-weight:bold">*</span>pud_k))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">goto</span> bad_area;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">pud_present</span>(<span style="color:#ff7b72;font-weight:bold">*</span>pud))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">set_pud</span>(pud, <span style="color:#ff7b72;font-weight:bold">*</span>pud_k);
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* 三级页表 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> pmd <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">pmd_offset</span>(pud, addr);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> pmd_k <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">pmd_offset</span>(pud_k, addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> index <span style="color:#ff7b72;font-weight:bold">=</span> (addr <span style="color:#ff7b72;font-weight:bold">&gt;&gt;</span> SECTION_SHIFT) <span style="color:#ff7b72;font-weight:bold">&amp;</span> <span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">pmd_none</span>(pmd_k[index]))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">goto</span> bad_area;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">copy_pmd</span>(pmd, pmd_k);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">bad_area</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">do_bad_area</span>(addr, fsr, regs);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>do_sect_fault</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-1">1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-2">2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-3">3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-4">4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-5">5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-3-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-3-6">6</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">do_sect_fault</span>(<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> fsr, <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">do_bad_area</span>(addr, fsr, regs);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">return</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}<span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149">  </span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>do_translation_fault与do_sect_fault最终会调到do_bad_area</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-4-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-4-15">15</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">do_bad_area</span>(<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> fsr, <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> task_struct <span style="color:#ff7b72;font-weight:bold">*</span>tsk <span style="color:#ff7b72;font-weight:bold">=</span> current;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> mm_struct <span style="color:#ff7b72;font-weight:bold">*</span>mm <span style="color:#ff7b72;font-weight:bold">=</span> tsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>active_mm;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#8b949e;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         * If we are in kernel mode at this point, we
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         * have no context to handle this fault with.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">user_mode</span>(regs))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">__do_user_fault</span>(tsk, addr, fsr, SIGSEGV, SEGV_MAPERR, regs);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">__do_kernel_fault</span>(mm, addr, fsr, regs);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里分别对用户模式与内核模式做了不同处理</p>
<h2 id="11-用户模式">1.1 用户模式：</h2>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-5-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-5-26">26</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">__do_user_fault</span>(<span style="color:#ff7b72">struct</span> task_struct <span style="color:#ff7b72;font-weight:bold">*</span>tsk, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> fsr, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> sig, <span style="color:#ff7b72">int</span> code,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> siginfo si;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifdef CONFIG_DEBUG_USER
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (user_debug <span style="color:#ff7b72;font-weight:bold">&amp;</span> UDBG_SEGV) {
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_DEBUG <span style="color:#a5d6ff">&#34;%s: unhandled page fault (%d) at 0x%08lx, code 0x%03x</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span>tsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>comm, sig, addr, fsr);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">show_pte</span>(tsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>mm, addr);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">show_regs</span>(regs);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> }
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> tsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#ff7b72">thread</span>.address <span style="color:#ff7b72;font-weight:bold">=</span> addr;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> tsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#ff7b72">thread</span>.error_code <span style="color:#ff7b72;font-weight:bold">=</span> fsr;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> tsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#ff7b72">thread</span>.trap_no <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">14</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> si.si_signo <span style="color:#ff7b72;font-weight:bold">=</span> sig;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> si.si_errno <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> si.si_code <span style="color:#ff7b72;font-weight:bold">=</span> code;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> si.si_addr <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">void</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>)addr;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">force_sig_info</span>(sig, <span style="color:#ff7b72;font-weight:bold">&amp;</span>si, tsk);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>__do_user_fault中若开启CONFIG_DEBUG_USER宏且user_debug 的UDBG_SEGV标志置位，才打印调试信息，接着在当前进程的task_struct 结构中记录错误信息并调用force_sig_info函数发送无阻塞SIGSEGV信号到进程信号队列中</p>
<h2 id="12-内核模式">1.2 内核模式：</h2>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-6-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-6-18">18</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">void</span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">__do_kernel_fault</span>(<span style="color:#ff7b72">struct</span> mm_struct <span style="color:#ff7b72;font-weight:bold">*</span>mm, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> fsr,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">bust_spinlocks</span>(<span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_ALERT
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#a5d6ff">&#34;Unable to handle kernel %s at virtual address %08lx</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> (addr <span style="color:#ff7b72;font-weight:bold">&lt;</span> PAGE_SIZE) <span style="color:#ff7b72;font-weight:bold">?</span> <span style="color:#a5d6ff">&#34;NULL pointer dereference&#34;</span> <span style="color:#ff7b72;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#a5d6ff">&#34;paging request&#34;</span>, addr);
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* 打印在mm中页表与地址的关系 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">show_pte</span>(mm, addr);
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* 打印Oops信息 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">die</span>(<span style="color:#a5d6ff">&#34;Oops&#34;</span>, regs, fsr);   
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">bust_spinlocks</span>(<span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">do_exit</span>(SIGKILL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数分别调用show_pte、die打印页表、oops信息，最后调用do_exit释放进程空间并调度其他进程。下面试函数的具体功能，作者省略了部分错误分支判断语句。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-7-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-7-41">41</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">show_pte</span>(<span style="color:#ff7b72">struct</span> mm_struct <span style="color:#ff7b72;font-weight:bold">*</span>mm, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">pgd_t</span> <span style="color:#ff7b72;font-weight:bold">*</span>pgd;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>mm)
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> mm <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#ff7b72;font-weight:bold">&amp;</span>init_mm;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_ALERT <span style="color:#a5d6ff">&#34;pgd = %p</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>, mm<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pgd);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> pgd <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">pgd_offset</span>(mm, addr);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_ALERT <span style="color:#a5d6ff">&#34;[%08lx] *pgd=%08llx&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> addr, (<span style="color:#ff7b72">long</span> <span style="color:#ff7b72">long</span>)<span style="color:#d2a8ff;font-weight:bold">pgd_val</span>(<span style="color:#ff7b72;font-weight:bold">*</span>pgd));
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/kernel/traps.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">die</span>(<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>str, <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs, <span style="color:#ff7b72">int</span> err)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> thread_info <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#ff7b72">thread</span> <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">current_thread_info</span>();
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">int</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">oops_enter</span>();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> ret <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#d2a8ff;font-weight:bold">__die</span>(str, err, <span style="color:#ff7b72">thread</span>, regs);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">oops_exit</span>();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span> <span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">__die</span>(<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>str, <span style="color:#ff7b72">int</span> err, <span style="color:#ff7b72">struct</span> thread_info <span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#ff7b72">thread</span>, <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_EMERG <span style="color:#a5d6ff">&#34;Internal error: %s: %x [#%d]&#34;</span> S_PREEMPT S_SMP <span style="color:#a5d6ff">&#34;</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span>str, err, <span style="color:#ff7b72;font-weight:bold">++</span>die_counter);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">sysfs_printk_last_file</span>();
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">print_modules</span>();
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">__show_regs</span>(regs);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_EMERG <span style="color:#a5d6ff">&#34;Process %.*s (pid: %d, stack limit = 0x%p)</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> TASK_COMM_LEN, tsk<span style="color:#ff7b72;font-weight:bold">-&gt;</span>comm, <span style="color:#d2a8ff;font-weight:bold">task_pid_nr</span>(tsk), <span style="color:#ff7b72">thread</span> <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#a5d6ff">1</span>);
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>进一步查找fsr_info结构变量的使用，do_DataAbort函数调用SIGSEGV触发函数</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-8-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-8-35">35</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span>asmlinkage <span style="color:#ff7b72">void</span> __exception
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">do_DataAbort</span>(<span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> addr, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">int</span> fsr, <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">const</span> <span style="color:#ff7b72">struct</span> fsr_info <span style="color:#ff7b72;font-weight:bold">*</span>inf <span style="color:#ff7b72;font-weight:bold">=</span> fsr_info <span style="color:#ff7b72;font-weight:bold">+</span> <span style="color:#d2a8ff;font-weight:bold">fsr_fs</span>(fsr);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> siginfo info;
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* 调用SIGSEGV的触发函数 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#ff7b72;font-weight:bold">!</span>inf<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#d2a8ff;font-weight:bold">fn</span>(addr, fsr <span style="color:#ff7b72;font-weight:bold">&amp;</span> <span style="color:#ff7b72;font-weight:bold">~</span>FSR_LNX_PF, regs))
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">printk</span>(KERN_ALERT <span style="color:#a5d6ff">&#34;Unhandled fault: %s (0x%03x) at 0x%08lx</span><span style="color:#79c0ff">\n</span><span style="color:#a5d6ff">&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> inf<span style="color:#ff7b72;font-weight:bold">-&gt;</span>name, fsr, addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> info.si_signo <span style="color:#ff7b72;font-weight:bold">=</span> inf<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sig;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> info.si_errno <span style="color:#ff7b72;font-weight:bold">=</span> <span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> info.si_code<span style="color:#f85149"> </span> <span style="color:#ff7b72;font-weight:bold">=</span> inf<span style="color:#ff7b72;font-weight:bold">-&gt;</span>code;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> info.si_addr<span style="color:#f85149"> </span> <span style="color:#ff7b72;font-weight:bold">=</span> (<span style="color:#ff7b72">void</span> __user <span style="color:#ff7b72;font-weight:bold">*</span>)addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">arm_notify_die</span>(<span style="color:#a5d6ff">&#34;&#34;</span>, regs, <span style="color:#ff7b72;font-weight:bold">&amp;</span>info, fsr, <span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39/arch/arm/kernel/traps.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">void</span> <span style="color:#d2a8ff;font-weight:bold">arm_notify_die</span>(<span style="color:#ff7b72">const</span> <span style="color:#ff7b72">char</span> <span style="color:#ff7b72;font-weight:bold">*</span>str, <span style="color:#ff7b72">struct</span> pt_regs <span style="color:#ff7b72;font-weight:bold">*</span>regs,
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">struct</span> siginfo <span style="color:#ff7b72;font-weight:bold">*</span>info, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> err, <span style="color:#ff7b72">unsigned</span> <span style="color:#ff7b72">long</span> trap)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#8b949e;font-style:italic">/* 用户模式发送信号到进程中 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#ff7b72">if</span> (<span style="color:#d2a8ff;font-weight:bold">user_mode</span>(regs)) {
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> current<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#ff7b72">thread</span>.error_code <span style="color:#ff7b72;font-weight:bold">=</span> err;
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> current<span style="color:#ff7b72;font-weight:bold">-&gt;</span><span style="color:#ff7b72">thread</span>.trap_no <span style="color:#ff7b72;font-weight:bold">=</span> trap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">force_sig_info</span>(info<span style="color:#ff7b72;font-weight:bold">-&gt;</span>si_signo, info, current);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> } <span style="color:#ff7b72">else</span> {
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#d2a8ff;font-weight:bold">die</span>(str, regs, err);
</span></span><span style="display:flex;"><span><span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> <span style="color:#f85149"> </span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>linux的arm体系架构中，针对page fault的异常处理，系统kernel检测到异常将进入到异常向量表中调用__dabt_svc或__dabt_usr，接着接入do_DataAbort，触发SIGSEGV发送函数，通过user_mode(regs)判断异常地址处于用户态还是内核态，位于内核态则打印oops信息并退出进程，处于用户态则往进程信号队列中新增SIGSEGV信号，函数调用关系如下所示：
<img src="/image/linux_single/func_relate.jpg" alt="func_relate"></p>
<h1 id="2arm架构信号处理">2、ARM架构信号处理</h1>
<h2 id="21-信号数据结构">2.1 信号数据结构</h2>
<p>我们知道，信号通常时被发送给指定的进程或进程组，而每一个进程在内核中有一个唯一的数据结构存储进程相关的参数信息。linux系统使用task_struct结构抽象一个进程或线程，结构包含了许多信息，我们先只关注信号相关的结构信息</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-9-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-9-10">10</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>signal_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>signal;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>sighand_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>sighand;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">sigset_t</span><span style="color:#f85149"> </span>blocked,<span style="color:#f85149"> </span>real_blocked;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">sigset_t</span><span style="color:#f85149"> </span>saved_sigmask;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>sigpending<span style="color:#f85149"> </span>pending;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中<strong>signal_struct</strong>表示进程的信号描述符，同一进程下的线程共享该结构，并用count表示共享该结构的进程个数。<strong>sighand_struct</strong>结构表示信号的处理程序描述符，也是多线程共享该结构，<strong>blocked</strong>字段存放进程当前所屏蔽的信号，<strong>pending</strong>字段记录当前进程私有的接收信号。信号重要的数据结构如下图所示：
<img src="/image/linux_single/single_struct.jpg" alt="single_struct"></p>
<h2 id="22-信号发送">2.2 信号发送</h2>
<p>在我们前面了解SIGSEGV的触发流程，在用户模式时，最后调用force_sig_info函数来发送SIGSEGV信号。在我们学习linux命令时，使用 kill -9 pid 关闭一个进程，其实也是向进程发送了一个SIGKILL信号，在linux系统下，可以通过kill -l查看系统支持的所有信号，如下是在ubuntu中查询的结果：
<img src="/image/linux_single/single_type.jpg" alt="single_type"></p>
<p>接下来我们来看看SIGSEGV信号是如何发送给进程的</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-1">  1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-2">  2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-3">  3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-4">  4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-5">  5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-6">  6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-7">  7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-8">  8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-9">  9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-10"> 10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-11"> 11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-12"> 12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-13"> 13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-14"> 14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-15"> 15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-16"> 16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-17"> 17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-18"> 18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-19"> 19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-20"> 20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-21"> 21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-22"> 22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-23"> 23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-24"> 24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-25"> 25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-26"> 26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-27"> 27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-28"> 28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-29"> 29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-30"> 30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-31"> 31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-32"> 32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-33"> 33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-34"> 34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-35"> 35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-36"> 36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-37"> 37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-38"> 38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-39"> 39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-40"> 40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-41"> 41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-42"> 42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-43"> 43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-44"> 44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-45"> 45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-46"> 46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-47"> 47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-48"> 48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-49"> 49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-50"> 50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-51"> 51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-52"> 52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-53"> 53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-54"> 54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-55"> 55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-56"> 56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-57"> 57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-58"> 58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-59"> 59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-60"> 60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-61"> 61</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-62"> 62</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-63"> 63</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-64"> 64</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-65"> 65</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-66"> 66</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-67"> 67</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-68"> 68</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-69"> 69</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-70"> 70</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-71"> 71</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-72"> 72</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-73"> 73</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-74"> 74</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-75"> 75</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-76"> 76</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-77"> 77</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-78"> 78</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-79"> 79</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-80"> 80</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-81"> 81</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-82"> 82</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-83"> 83</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-84"> 84</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-85"> 85</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-86"> 86</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-87"> 87</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-88"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-88"> 88</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-89"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-89"> 89</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-90"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-90"> 90</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-91"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-91"> 91</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-92"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-92"> 92</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-93"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-93"> 93</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-94"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-94"> 94</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-95"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-95"> 95</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-96"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-96"> 96</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-97"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-97"> 97</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-98"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-98"> 98</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-99"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-99"> 99</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-100"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-100">100</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-101"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-101">101</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-102"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-102">102</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-103"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-103">103</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-104"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-104">104</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-105"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-105">105</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-106"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-106">106</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-107"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-107">107</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-108"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-108">108</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-10-109"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-10-109">109</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">force_sig_info</span>(<span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>sig,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>siginfo<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>info,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>t)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>ret<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">specific_send_sig_info</span>(sig,<span style="color:#f85149"> </span>info,<span style="color:#f85149"> </span>t);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span><span style="color:#f85149"> </span><span style="color:#ff7b72">int</span>
</span></span><span style="display:flex;"><span><span style="color:#d2a8ff;font-weight:bold">specific_send_sig_info</span>(<span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>sig,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>siginfo<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>info,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>t)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">send_signal</span>(sig,<span style="color:#f85149"> </span>info,<span style="color:#f85149"> </span>t,<span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span><span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">send_signal</span>(<span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>sig,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>siginfo<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>info,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>t,
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>group)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>from_ancestor_ns<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#ifdef CONFIG_PID_NS
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span><span style="color:#f85149">    </span>from_ancestor_ns<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">si_fromuser</span>(info)<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">               </span><span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">task_pid_nr_ns</span>(current,<span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">task_active_pid_ns</span>(t));
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">__send_signal</span>(sig,<span style="color:#f85149"> </span>info,<span style="color:#f85149"> </span>t,<span style="color:#f85149"> </span>group,<span style="color:#f85149"> </span>from_ancestor_ns);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span><span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">__send_signal</span>(<span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>sig,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>siginfo<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>info,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>t,
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>group,<span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>from_ancestor_ns)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (1)判断是否可以忽略信号 函数返回0 条件满足直接返回0退出*/</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">prepare_signal</span>(sig,<span style="color:#f85149"> </span>t,<span style="color:#f85149"> </span>from_ancestor_ns))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* 选择信号pending队列 shared_pending:线程组共享信号 or pending:进程私有信号 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>pending<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>group<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">?</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>t<span style="color:#ff7b72;font-weight:bold">-&gt;</span>signal<span style="color:#ff7b72;font-weight:bold">-&gt;</span>shared_pending<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">:</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>t<span style="color:#ff7b72;font-weight:bold">-&gt;</span>pending;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (2)判断信号是否小于32且是否信号已经在队列中 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">legacy_queue</span>(pending,<span style="color:#f85149"> </span>sig))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">     * (3)info.si_signo == SEND_SIG_FORCED(2) 内核内置的信号如SIGSTOP,SIGKILL
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">     * 不用加入队列，快速处理
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(info<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#f85149"> </span>SEND_SIG_FORCED)
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">goto</span><span style="color:#f85149"> </span>out_set;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (4)符合条件的特殊信号可以突破siganl pending队列的大小限制(rlimit)
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">     *否则在队列满的情况下，丢弃信号
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">     *signal pending队列大小rlimit的值可以通过命令&#34;ulimit -i&#34;查看
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(sig<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&lt;</span><span style="color:#f85149"> </span>SIGRTMIN)
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>override_rlimit<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">is_si_special</span>(info)<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#f85149"> </span>info<span style="color:#ff7b72;font-weight:bold">-&gt;</span>si_code<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&gt;=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>override_rlimit<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (5)为新信号申请sigqueue结构 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>q<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">__sigqueue_alloc</span>(sig,<span style="color:#f85149"> </span>t,<span style="color:#f85149"> </span>GFP_ATOMIC<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">|</span><span style="color:#f85149"> </span>__GFP_NOTRACK_FALSE_POSITIVE,
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>override_rlimit);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(q)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* (6)新申请的结构加入task结构的挂起队列中 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#d2a8ff;font-weight:bold">list_add_tail</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>list,<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>pending<span style="color:#ff7b72;font-weight:bold">-&gt;</span>list);
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">switch</span><span style="color:#f85149"> </span>((<span style="color:#ff7b72">unsigned</span><span style="color:#f85149"> </span><span style="color:#ff7b72">long</span>)<span style="color:#f85149"> </span>info)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">case</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72">unsigned</span><span style="color:#f85149"> </span><span style="color:#ff7b72">long</span>)<span style="color:#f85149"> </span><span style="color:#79c0ff;font-weight:bold">SEND_SIG_NOINFO</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_signo<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>sig;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_errno<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_code<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>SI_USER;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_pid<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">task_tgid_nr_ns</span>(current,
</span></span><span style="display:flex;"><span><span style="color:#f85149">                            </span><span style="color:#d2a8ff;font-weight:bold">task_active_pid_ns</span>(t));
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_uid<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">current_uid</span>();
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">case</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72">unsigned</span><span style="color:#f85149"> </span><span style="color:#ff7b72">long</span>)<span style="color:#f85149"> </span><span style="color:#79c0ff;font-weight:bold">SEND_SIG_PRIV</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_signo<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>sig;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_errno<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_code<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>SI_KERNEL;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_pid<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_uid<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">default</span><span style="color:#ff7b72;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#d2a8ff;font-weight:bold">copy_siginfo</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info,<span style="color:#f85149"> </span>info);
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(from_ancestor_ns)
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span>q<span style="color:#ff7b72;font-weight:bold">-&gt;</span>info.si_pid<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>}<span style="color:#f85149"> </span><span style="color:#ff7b72">else</span><span style="color:#f85149"> </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">is_si_special</span>(info))<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(sig<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&gt;=</span><span style="color:#f85149"> </span>SIGRTMIN<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;&amp;</span><span style="color:#f85149"> </span>info<span style="color:#ff7b72;font-weight:bold">-&gt;</span>si_code<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#f85149"> </span>SI_USER)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#8b949e;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">             * Queue overflow, abort.  We may abort if the
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">             * signal was rt and sent by user using something
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">             * other than kill().
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">             */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#d2a8ff;font-weight:bold">trace_signal_overflow_fail</span>(sig,<span style="color:#f85149"> </span>group,<span style="color:#f85149"> </span>info);
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">-</span>EAGAIN;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}<span style="color:#f85149"> </span><span style="color:#ff7b72">else</span><span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#8b949e;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">             * This is a silent loss of information.  We still
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">             * send the signal, but the *info bits are lost.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">             */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#d2a8ff;font-weight:bold">trace_signal_lose_info</span>(sig,<span style="color:#f85149"> </span>group,<span style="color:#f85149"> </span>info);
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#79c0ff;font-weight:bold">out_set</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (7)通知信号的epoll */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#d2a8ff;font-weight:bold">signalfd_notify</span>(t,<span style="color:#f85149"> </span>sig);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (8)更新pending-&gt;signal信号集合中对应的bit */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#d2a8ff;font-weight:bold">sigaddset</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>pending<span style="color:#ff7b72;font-weight:bold">-&gt;</span>signal,<span style="color:#f85149"> </span>sig);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (9)选择合适的进程来响应信号，如果需要并唤醒对应的进程*/</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#d2a8ff;font-weight:bold">complete_signal</span>(sig,<span style="color:#f85149"> </span>t,<span style="color:#f85149"> </span>group);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>函数最终调到__send_signal接口中，在__send_signal接口中主要是判断信号是否可以忽略，然后加入到进程的pengding链表中，最后唤醒信号的响应进程。
__send_signal中调用complete_signal接口唤醒信号响应进程，具体实现如下</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-29">29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-30">30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-31">31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-32">32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-33">33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-34">34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-35">35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-36">36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-37">37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-38">38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-39">39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-40">40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-41">41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-42">42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-43">43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-44">44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-45">45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-46">46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-47">47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-48">48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-49">49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-50">50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-51">51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-52">52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-53">53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-54">54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-55">55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-11-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-11-56">56</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#ff7b72">static</span><span style="color:#f85149"> </span><span style="color:#ff7b72">void</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">complete_signal</span>(<span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>sig,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>p,<span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>group)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>signal_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>signal<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>p<span style="color:#ff7b72;font-weight:bold">-&gt;</span>signal;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (9.1)判断是否本进程可执行信号，可能是线程处理信号 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">wants_signal</span>(sig,<span style="color:#f85149"> </span>p))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>t<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>p;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (9.2)单线程直接退出 不用唤醒 下次运行时自动调用 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">else</span><span style="color:#f85149"> </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span>group<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">thread_group_empty</span>(p))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         * There is just one thread and it does not need to be woken.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         * It will dequeue unblocked signals before it runs again.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">else</span><span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* (9.3)线程执行信号，找出CPU运行的线程 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>t<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>signal<span style="color:#ff7b72;font-weight:bold">-&gt;</span>curr_target;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">while</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">wants_signal</span>(sig,<span style="color:#f85149"> </span>t))<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>t<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">next_thread</span>(t);
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(t<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#f85149"> </span>signal<span style="color:#ff7b72;font-weight:bold">-&gt;</span>curr_target)
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>signal<span style="color:#ff7b72;font-weight:bold">-&gt;</span>curr_target<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>t;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/*（9.5）唤醒找出的线程 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#d2a8ff;font-weight:bold">signal_wake_up</span>(t,<span style="color:#f85149"> </span>sig<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#f85149"> </span>SIGKILL);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span><span style="color:#f85149"> </span><span style="color:#ff7b72">inline</span><span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">wants_signal</span>(<span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>sig,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">sigismember</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>p<span style="color:#ff7b72;font-weight:bold">-&gt;</span>blocked,<span style="color:#f85149"> </span>sig))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(p<span style="color:#ff7b72;font-weight:bold">-&gt;</span>flags<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#f85149"> </span>PF_EXITING)
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(sig<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#f85149"> </span>SIGKILL)
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">task_is_stopped_or_traced</span>(p))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (9.1.1)判断p是否是当前CPU运行的线程 or p.stack.flag是否设置TIF_SIGPENDING  */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">return</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">task_curr</span>(p)<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">||</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">signal_pending</span>(p);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">void</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">signal_wake_up</span>(<span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>task_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>t,<span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>resume)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (9.5.1)t.stack.flag设置TIF_SIGPENDING标志 在ret_to_use节点判断并处理信号*/</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#d2a8ff;font-weight:bold">set_tsk_thread_flag</span>(t,<span style="color:#f85149"> </span>TIF_SIGPENDING);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (9.5.2)调用try_to_wake_up尝试唤醒进程 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">wake_up_state</span>(t,<span style="color:#f85149"> </span>mask))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#d2a8ff;font-weight:bold">kick_process</span>(t);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>信号产生可分为用户主动触发，系统异常触发两类，它们最终都需要调到__send_signal中，判断比较信号是否可以被忽略不处理，不能则将信号挂载到进程的pending链表上，最后通过try_to_wake_up唤醒信号的响应进程，执行信号处理函数。相关接口调用如下所示：</p>
<p><img src="/image/linux_single/single_send_call.jpg" alt="single_send_call"></p>
<h2 id="23-信号执行">2.3 信号执行</h2>
<p>信号被放到进程的pending链表后，立刻调用try_to_wake_up唤醒信号的响应进程，进程从内核态返回用户态时，需要检查<strong>TIF_SIGPENDING</strong>标志是否被置位，如果是,需要处理pending中挂起的信号。下面看看源码实现</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-1">  1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-2">  2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-3">  3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-4">  4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-5">  5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-6">  6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-7">  7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-8">  8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-9">  9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-10"> 10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-11"> 11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-12"> 12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-13"> 13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-14"> 14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-15"> 15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-16"> 16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-17"> 17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-18"> 18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-19"> 19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-20"> 20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-21"> 21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-22"> 22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-23"> 23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-24"> 24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-25"> 25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-26"> 26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-27"> 27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-28"> 28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-29"> 29</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-30"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-30"> 30</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-31"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-31"> 31</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-32"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-32"> 32</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-33"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-33"> 33</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-34"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-34"> 34</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-35"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-35"> 35</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-36"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-36"> 36</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-37"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-37"> 37</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-38"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-38"> 38</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-39"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-39"> 39</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-40"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-40"> 40</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-41"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-41"> 41</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-42"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-42"> 42</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-43"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-43"> 43</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-44"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-44"> 44</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-45"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-45"> 45</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-46"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-46"> 46</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-47"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-47"> 47</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-48"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-48"> 48</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-49"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-49"> 49</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-50"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-50"> 50</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-51"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-51"> 51</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-52"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-52"> 52</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-53"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-53"> 53</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-54"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-54"> 54</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-55"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-55"> 55</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-56"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-56"> 56</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-57"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-57"> 57</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-58"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-58"> 58</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-59"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-59"> 59</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-60"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-60"> 60</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-61"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-61"> 61</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-62"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-62"> 62</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-63"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-63"> 63</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-64"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-64"> 64</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-65"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-65"> 65</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-66"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-66"> 66</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-67"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-67"> 67</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-68"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-68"> 68</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-69"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-69"> 69</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-70"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-70"> 70</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-71"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-71"> 71</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-72"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-72"> 72</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-73"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-73"> 73</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-74"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-74"> 74</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-75"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-75"> 75</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-76"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-76"> 76</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-77"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-77"> 77</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-78"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-78"> 78</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-79"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-79"> 79</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-80"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-80"> 80</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-81"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-81"> 81</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-82"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-82"> 82</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-83"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-83"> 83</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-84"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-84"> 84</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-85"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-85"> 85</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-86"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-86"> 86</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-87"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-87"> 87</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-88"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-88"> 88</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-89"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-89"> 89</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-90"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-90"> 90</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-91"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-91"> 91</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-92"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-92"> 92</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-93"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-93"> 93</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-94"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-94"> 94</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-95"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-95"> 95</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-96"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-96"> 96</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-97"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-97"> 97</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-98"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-98"> 98</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-99"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-99"> 99</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-100"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-100">100</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-101"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-101">101</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-102"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-102">102</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-103"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-103">103</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-104"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-104">104</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-105"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-105">105</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-106"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-106">106</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-107"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-107">107</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-108"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-108">108</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-109"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-109">109</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-110"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-110">110</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-111"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-111">111</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-112"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-112">112</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-113"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-113">113</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-114"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-114">114</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-115"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-115">115</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-116"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-116">116</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-117"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-117">117</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-118"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-118">118</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-119"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-119">119</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-120"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-120">120</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-121"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-121">121</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-122"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-122">122</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-123"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-123">123</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-124"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-124">124</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-125"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-125">125</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-126"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-126">126</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-127"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-127">127</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-128"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-128">128</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-129"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-129">129</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-130"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-130">130</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-131"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-131">131</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-132"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-132">132</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-133"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-133">133</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-134"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-134">134</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-135"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-135">135</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-136"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-136">136</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-137"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-137">137</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-138"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-138">138</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-139"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-139">139</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-12-140"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-12-140">140</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// ./linux-2.6.39/arch/arm/kernel/signal.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#d2a8ff;font-weight:bold">do_notify_resume</span>(<span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>pt_regs<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>regs,<span style="color:#f85149"> </span><span style="color:#ff7b72">unsigned</span><span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>thread_flags,<span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>syscall)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(thread_flags<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#f85149"> </span>_TIF_SIGPENDING)
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#d2a8ff;font-weight:bold">do_signal</span>(regs,<span style="color:#f85149"> </span>syscall);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff7b72">static</span><span style="color:#f85149"> </span><span style="color:#ff7b72">void</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">do_signal</span>(<span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>pt_regs<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>regs,<span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>syscall)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">unsigned</span><span style="color:#f85149"> </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>retval<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>,<span style="color:#f85149"> </span>continue_addr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>,<span style="color:#f85149"> </span>restart_addr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>k_sigaction<span style="color:#f85149"> </span>ka;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">siginfo_t</span><span style="color:#f85149"> </span>info;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>signr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* 不在用户模式直接退出 表明内核态的线程不能处理信号 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span><span style="color:#d2a8ff;font-weight:bold">user_mode</span>(regs))
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (2)如果是 system call 被信号中断，判断是否需要重启 system call */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(syscall)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>continue_addr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>regs<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ARM_pc;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>restart_addr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>continue_addr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">thumb_mode</span>(regs)<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">?</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">2</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">:</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">4</span>);
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>retval<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>regs<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ARM_r0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">switch</span><span style="color:#f85149"> </span>(retval)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">case</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#79c0ff;font-weight:bold">ERESTARTNOHAND</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">case</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#79c0ff;font-weight:bold">ERESTARTSYS</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">case</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#79c0ff;font-weight:bold">ERESTARTNOINTR</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>regs<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ARM_r0<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>regs<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ARM_ORIG_r0;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>regs<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ARM_pc<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>restart_addr;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">case</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#79c0ff;font-weight:bold">ERESTART_RESTARTBLOCK</span>:
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>regs<span style="color:#ff7b72;font-weight:bold">-&gt;</span>ARM_r0<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">-</span>EINTR;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (3)从线程的信号 pending 队列中取出信号 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>signr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">get_signal_to_deliver</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>info,<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>ka,<span style="color:#f85149"> </span>regs,<span style="color:#f85149"> </span>NULL);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(signr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&gt;</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#8b949e;font-style:italic">/* (4)如果有对应的用户自定义处理函数，则执行用户态处理函数 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">handle_signal</span>(signr,<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>ka,<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>info,<span style="color:#f85149"> </span>oldset,<span style="color:#f85149"> </span>regs)<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#f85149"> </span><span style="color:#a5d6ff">0</span>)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">test_thread_flag</span>(TIF_RESTORE_SIGMASK))
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#d2a8ff;font-weight:bold">clear_thread_flag</span>(TIF_RESTORE_SIGMASK);
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">return</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39\kernel\signal.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">get_signal_to_deliver</span>(<span style="color:#ff7b72">siginfo_t</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>info,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>k_sigaction<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>return_ka,
</span></span><span style="display:flex;"><span><span style="color:#f85149">              </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>pt_regs<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>regs,<span style="color:#f85149"> </span><span style="color:#ff7b72">void</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>cookie)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>sighand_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>sighand<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>current<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sighand;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>signal_struct<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>signal<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>current<span style="color:#ff7b72;font-weight:bold">-&gt;</span>signal;
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">int</span><span style="color:#f85149"> </span>signr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">for</span><span style="color:#f85149"> </span>(;;)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>k_sigaction<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>ka;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#8b949e;font-style:italic">/* (3.1)从pending中取链表中的队列 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>signr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">dequeue_signal</span>(current,<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>current<span style="color:#ff7b72;font-weight:bold">-&gt;</span>blocked,
</span></span><span style="display:flex;"><span><span style="color:#f85149">                           </span>info);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span>signr)
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#ff7b72">break</span>;<span style="color:#f85149"> </span><span style="color:#8b949e;font-style:italic">/* will return 0 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(signr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#f85149"> </span>SIGKILL)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span>signr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">ptrace_signal</span>(signr,<span style="color:#f85149"> </span>info,
</span></span><span style="display:flex;"><span><span style="color:#f85149">                              </span>regs,<span style="color:#f85149"> </span>cookie);
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#ff7b72;font-weight:bold">!</span>signr)
</span></span><span style="display:flex;"><span><span style="color:#f85149">                    </span><span style="color:#ff7b72">continue</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#8b949e;font-style:italic">/* (3.2)获取信号处理函数 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>ka<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span>sighand<span style="color:#ff7b72;font-weight:bold">-&gt;</span>action[signr<span style="color:#ff7b72;font-weight:bold">-</span><span style="color:#a5d6ff">1</span>];
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* Trace actually delivered signals. */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#d2a8ff;font-weight:bold">trace_signal_deliver</span>(signr,<span style="color:#f85149"> </span>info,<span style="color:#f85149"> </span>ka);
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* (3.3)信号处理的第1种方法：忽略 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(ka<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sa.sa_handler<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">==</span><span style="color:#f85149"> </span>SIG_IGN)<span style="color:#f85149"> </span><span style="color:#8b949e;font-style:italic">/* Do nothing.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">continue</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* (3.4)信号处理的第2种方法：调用用户注册的函数 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(ka<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sa.sa_handler<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#f85149"> </span>SIG_DFL)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#8b949e;font-style:italic">/* Run the handler.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72;font-weight:bold">*</span>return_ka<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>ka;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(ka<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sa.sa_flags<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#f85149"> </span>SA_ONESHOT)
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span>ka<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sa.sa_handler<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span>SIG_DFL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">break</span>;<span style="color:#f85149"> </span><span style="color:#8b949e;font-style:italic">/* will return non-zero &#34;signr&#34; value */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/*(3.5)信号处理的第3种方法：调用默认处理方法
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         * Now we are doing the default action for this signal.
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">         */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* (3.5.1)忽略处理 */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">sig_kernel_ignore</span>(signr))<span style="color:#f85149"> </span><span style="color:#8b949e;font-style:italic">/* Default is nothing. */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">continue</span>;
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* (3.5.2)暂停处理 do_signal_stop */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">sig_kernel_stop</span>(signr))<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(signr<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">!=</span><span style="color:#f85149"> </span>SIGSTOP)<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#d2a8ff;font-weight:bold">spin_unlock_irq</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>sighand<span style="color:#ff7b72;font-weight:bold">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">is_current_pgrp_orphaned</span>())
</span></span><span style="display:flex;"><span><span style="color:#f85149">                    </span><span style="color:#ff7b72">goto</span><span style="color:#f85149"> </span>relock;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#d2a8ff;font-weight:bold">spin_lock_irq</span>(<span style="color:#ff7b72;font-weight:bold">&amp;</span>sighand<span style="color:#ff7b72;font-weight:bold">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">likely</span>(<span style="color:#d2a8ff;font-weight:bold">do_signal_stop</span>(info<span style="color:#ff7b72;font-weight:bold">-&gt;</span>si_signo)))<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#8b949e;font-style:italic">/* It released the siglock.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#ff7b72">goto</span><span style="color:#f85149"> </span>relock;
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">continue</span>;
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#8b949e;font-style:italic">/* (3.5.2)dump处理 do_coredump */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(<span style="color:#d2a8ff;font-weight:bold">sig_kernel_coredump</span>(signr))<span style="color:#f85149"> </span>{
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(print_fatal_signals)
</span></span><span style="display:flex;"><span><span style="color:#f85149">                </span><span style="color:#d2a8ff;font-weight:bold">print_fatal_signal</span>(regs,<span style="color:#f85149"> </span>info<span style="color:#ff7b72;font-weight:bold">-&gt;</span>si_signo);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">            </span><span style="color:#d2a8ff;font-weight:bold">do_coredump</span>(info<span style="color:#ff7b72;font-weight:bold">-&gt;</span>si_signo,<span style="color:#f85149"> </span>info<span style="color:#ff7b72;font-weight:bold">-&gt;</span>si_signo,<span style="color:#f85149"> </span>regs);
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span>}
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>信号处理主要在do_signal中完成，对信号有三种处理方法忽略、调用用户注册的处理函数、使用系统默认的处理函数。上面已经注释了默认处理的场景，我们再来看看调用用户注册函数的处理场景。</p>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-13-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-13-13">13</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic">// linux-2.6.39\arch\arm\kernel\signal.c
</span></span></span><span style="display:flex;"><span><span style="color:#8b949e;font-style:italic"></span><span style="color:#ff7b72">static</span><span style="color:#f85149"> </span><span style="color:#ff7b72">int</span> <span style="color:#d2a8ff;font-weight:bold">handle_signal</span>(<span style="color:#ff7b72">unsigned</span><span style="color:#f85149"> </span><span style="color:#ff7b72">long</span><span style="color:#f85149"> </span>sig,<span style="color:#f85149"> </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>k_sigaction<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>ka,
</span></span><span style="display:flex;"><span><span style="color:#f85149">          </span><span style="color:#ff7b72">siginfo_t</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>info,<span style="color:#f85149"> </span><span style="color:#ff7b72">sigset_t</span><span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span>oldset,
</span></span><span style="display:flex;"><span><span style="color:#f85149">          </span><span style="color:#ff7b72">struct</span><span style="color:#f85149"> </span>pt_regs<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">*</span><span style="color:#f85149"> </span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#8b949e;font-style:italic">/* (4.1)构造用户堆栈，将用户态返回地址替换成用户注册的信号处理函数&amp;ksig-&gt;ka */</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">if</span><span style="color:#f85149"> </span>(ka<span style="color:#ff7b72;font-weight:bold">-&gt;</span>sa.sa_flags<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">&amp;</span><span style="color:#f85149"> </span>SA_SIGINFO)
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>ret<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">setup_rt_frame</span>(usig,<span style="color:#f85149"> </span>ka,<span style="color:#f85149"> </span>info,<span style="color:#f85149"> </span>oldset,<span style="color:#f85149"> </span>regs);
</span></span><span style="display:flex;"><span><span style="color:#f85149">    </span><span style="color:#ff7b72">else</span>
</span></span><span style="display:flex;"><span><span style="color:#f85149">        </span>ret<span style="color:#f85149"> </span><span style="color:#ff7b72;font-weight:bold">=</span><span style="color:#f85149"> </span><span style="color:#d2a8ff;font-weight:bold">setup_frame</span>(usig,<span style="color:#f85149"> </span>ka,<span style="color:#f85149"> </span>oldset,<span style="color:#f85149"> </span>regs);
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们知道handle_signal函数在内核侧，而信号处理函数在用户侧，不能直接调用。该怎么办呢？Linux所采用的解决办法是把保存在内核态堆栈中的硬件上下文拷贝当前进程的用户态堆栈中，当信号处理程序终止后，自动调用sigreturn系统调用把这个硬件上下文拷贝回到内核态堆栈中，并恢复用户态堆栈中原来内容。如下图所示
<img src="/image/linux_single/stack_recover.jpg" alt="stack_recover"></p>
<p>总结下信号执行过程，信号发送阶段最后调用接口唤醒进程，在进程从内核态切换回用户态时，进入到ret_to_user中，调用do_notify_resume检查到flag被置位为<strong>TIF_SIGPENDING</strong>。调用do_signal处理pengding中挂起的信号，分别可通过忽略、调用用户注册的处理函数、执行系统默认函数这几种方法处理信号。又由于内核侧不能直接调用用户注册的处理函数，故通过setup_frame接口创建一个frame，指向信号处理函数，并将frame替换为用户侧硬件上下文，执行完处理函数后，返回内核态，执行restore_sigcontext恢复以前的用户态硬件上下文信息。如下系统调用流程图
<img src="/image/linux_single/stack_recover_func.jpg" alt="stack_recover_func"></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">dgwu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2022-10-02
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>



    
    


    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://Breeze-Wu.github.io/tags/linux/">linux</a>
            
        </div>


      
      <nav class="post-nav">
        
          <a class="prev" href="/post/linux_init/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">linux系统init启动梳理</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/%E5%88%9D%E6%8E%A2linux%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E6%A0%88/">
            <span class="next-text nav-default">初探linux网络协议栈</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  


  
  

  

  
  

  
  

  

  

    

  

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:your@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="twitch"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 36 36" version="1.1" width="36" height="36" id="svg8">
  <path
      style=""
      d="M 10,32.5 C 10,30.309524 9.5666667,30 6.5,30 H 3 V 18.196167 6.3923336 L 6.2976072,3.1961668 9.5952145,0 H 21.297607 33 v 9.2813035 9.2813035 l -5.778997,5.718696 C 23.230948,28.229724 20.653654,30 18.895317,30 17.471816,30 15.312792,31.102597 14,32.5 12.708255,33.875 11.279813,35 10.825686,35 10.371559,35 10,33.875 10,32.5 Z M 23.12736,22 c 1.432033,0 3.645397,-1.197147 5.185549,-2.804719 C 30.682196,16.722278 31,15.598708 31,9.6952811 V 3 H 20.5 10 v 9.5 9.5 h 3 c 2.413503,0 3,0.425076 3,2.174314 v 2.174314 l 2.314451,-2.174314 C 19.587399,22.978441 21.753208,22 23.12736,22 Z M 17.666667,14.333333 C 17.3,13.966667 17,12.166667 17,10.333333 17,8.037037 17.466667,7 18.5,7 c 1.083333,0 1.5,1.1111111 1.5,4 0,3.753437 -0.7878,4.878866 -2.333333,3.333333 z m 6.722867,-0.760607 C 23.554137,11.395717 24.34722,7.7069709 25.75,7.2449946 26.613128,6.9607414 27,8.097114 27,10.916667 c 0,3.979702 -1.51214,5.518252 -2.610466,2.656059 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://Breeze-Wu.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2023
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        dgwu
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.fe83e11b4fbc9193d67e2c9db78bad21f8dc59fca0cacd8c1c3bb071bb16a852.js" integrity="sha256-/oPhG0&#43;8kZPWfiydt4utIfjcWfygys2MHDuwcbsWqFI=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  

















</body>
</html>
