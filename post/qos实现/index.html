<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>qos实现 - dgwu - A super concise theme for Hugo</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="dgwu" />
  <meta name="description" content="摘要 本文旨在梳理总结ZTE网关Qos流控实现的原理，解析大致的函数栈调用路线，参考源码CTCC_ZXIC_202107。文中错误处欢迎指正交" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.109.0" />


<link rel="canonical" href="https://Breeze-Wu.github.io/post/qos%E5%AE%9E%E7%8E%B0/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.de22abc00de44766eebd1054fd9e0b254b071f89d5019044f893c484a9249a8d.css" integrity="sha256-3iKrwA3kR2buvRBU/Z4LJUsHH4nVAZBE&#43;JPEhKkkmo0=" media="screen" crossorigin="anonymous">







<meta property="og:title" content="qos实现" />
<meta property="og:description" content="摘要 本文旨在梳理总结ZTE网关Qos流控实现的原理，解析大致的函数栈调用路线，参考源码CTCC_ZXIC_202107。文中错误处欢迎指正交" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Breeze-Wu.github.io/post/qos%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-06-12T00:00:00+00:00" />
<meta itemprop="name" content="qos实现">
<meta itemprop="description" content="摘要 本文旨在梳理总结ZTE网关Qos流控实现的原理，解析大致的函数栈调用路线，参考源码CTCC_ZXIC_202107。文中错误处欢迎指正交"><meta itemprop="datePublished" content="2021-06-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-06-12T00:00:00+00:00" />
<meta itemprop="wordCount" content="2748">
<meta itemprop="keywords" content="zte,linux,qos," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="qos实现"/>
<meta name="twitter:description" content="摘要 本文旨在梳理总结ZTE网关Qos流控实现的原理，解析大致的函数栈调用路线，参考源码CTCC_ZXIC_202107。文中错误处欢迎指正交"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">dgwu</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      dgwu
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Breeze-Wu.github.io/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">qos实现</h1>
      

      <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          dgwu
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2021-06-12">
      2021-06-12
    </time>
  </div>

  


  <div class="post-meta__right">
    

    


    
    


    
    
  </div>
</div>

    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#21linux网络协议栈数据发送概述">2.1、linux网络协议栈数据发送概述</a></li>
    <li><a href="#22qos功能实现">2.2、Qos功能实现</a></li>
  </ul>

  <ul>
    <li><a href="#31代码框架">3.1、代码框架</a></li>
    <li><a href="#32数据包分类与标记">3.2、数据包分类与标记</a>
      <ul>
        <li><a href="#321-相关数据结构">3.2.1 相关数据结构</a></li>
        <li><a href="#322-函数调用路线">3.2.2 函数调用路线</a></li>
      </ul>
    </li>
    <li><a href="#33限流策略">3.3、限流策略</a>
      <ul>
        <li><a href="#331-相关数据结构">3.3.1 相关数据结构</a></li>
        <li><a href="#332-函数调用路线">3.3.2 函数调用路线</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>


    
    <div class="post-content">
      <h1 id="摘要">摘要</h1>
<p>本文旨在梳理总结ZTE网关Qos流控实现的原理，解析大致的函数栈调用路线，参考源码CTCC_ZXIC_202107。文中错误处欢迎指正交流。</p>
<h1 id="1qos是什么">1、Qos是什么？</h1>
<p>QOS是Quality of Service的缩写，意为服务质量。在计算机网络中，QoS是一种控制机制，它提供了针对不同用户或者不同数据流采用相应不同的优先级，或者是根据应用程序的要求，保证数据流的性能达到一定的水准。QoS的保证对于容量有限的网络来说是十分重要的，特别是对于流多媒体应用，例如VoIP和IPTV等，因为这些应用常常需要固定的传输率，对延迟也比较敏感。以上是维基百科对Qos的定义。</p>
<p>来看看这个场景，用户A家的网络出入口是一台光猫设备，光猫下面接了一台正在运行的网络电视机、一部在打视频通话的手机，还有一台在运行大型游戏的主机。现在大家都感觉网络非常卡。要解决以上问题，我们可以关闭一些暂时不紧急的设备，比如游戏、电视，全力保障手机通话的质量，但是这种解决方案有很大局限，如果有其他人也连到了光猫(偷wiif)，我们就无法关闭这台设备。Qos是一种用户可控的流量管理的机制，可以给光猫设备配置一条命令，通过限制其他下挂设备的流量来保证通向通话中的手机的数据流量达到一定速率。</p>
<h1 id="2qos与linux网络协议栈是什么关系">2、Qos与linux网络协议栈是什么关系？</h1>
<h2 id="21linux网络协议栈数据发送概述">2.1、linux网络协议栈数据发送概述</h2>
<p>在介绍Qos实现前，我们先来了解一个数据包从用户层到linux网络协议栈，再到物理网卡的经过。
<img src="/image/qos/pTtQ0EbglFZ6Y8xV.png" alt="输入图片说明"></p>
<p>如上图，数据包从用户侧到物理网卡中，在linux系统中大致可分为5部分，首先是用户层产生数据、接着调用send等系统调用接口，将数据传递到内核中。</p>
<p>内核接收数据并动态创建一个skb_buff的数据结构，skb_buff就是我们对一个数据报文的抽象。接着在结构中填充TCP头相关的信息(端口号、seq序号、ack、窗口大小等)。最后放到一个write缓冲队列上。</p>
<p>传输层处理完毕后，会进到网络层(IP层)，这个阶段负责填充skb_buff结构中的IP头信息，查找目标IP的路由。如果没有路由，表示找不到通向目标IP的路径，系统返回错误信息并丢弃数据包(释放skb_buff内存)。</p>
<p>找到路由后继续发送到链路层，链路层需要填充skb_buff的链路头信息，包含收发设备的mac等信息。系统会先查找缓存中是否存在目标IP的mac信息，如果没有，需要使用ARP(邻居发现)，在局域网上广播查询。如果找不到，默认网关设备会向内核发送ICMP响应，告诉内核目标主机不可达。</p>
<p>最后数据报文来到了物理层，这里数据报文被加入到了设备发送队列txq中。使用软中断去获取txq数据并加入发送网络驱动层。这里会用qdisc结构管理txq队列中数据包的发送规则，我们可以通过<strong>ip addr</strong>命令查看网络设备的排队规则
<img src="/image/qos/WlnYdnoxx6n4NKKt.png" alt="输入图片说明"></p>
<p>在centos系统中网络设备使用了noqueue与pfifo_fast两种发送规则，pfifo_fast将队列分成三个波段（band）。在每个波段里面，使用先进先出规则。三个波段的优先级也不相同。band 0 的优先级最高，band 2 的最低。如果 band 0 里面有数据包，系统就不会处理 band 1 里面的数据包，band 1 和 band 2 之间也是一样。</p>
<p>数据包是按照服务类型（Type of Service，TOS）被分配到三个波段里面的。TOS 是 IP 头里面的一个字段，代表了当前的包是高优先级的，还是低优先级的。
<img src="/image/qos/PLFmSYQ40NDkwStO.png" alt="输入图片说明"></p>
<p>可以通过<strong>tc qdisc</strong>查看网络接口的priomap。
<img src="/image/qos/wRUjOnchl7UwRWi3.png" alt="输入图片说明"></p>
<h2 id="22qos功能实现">2.2、Qos功能实现</h2>
<p>QoS模块就建立在Linux协议栈的TC模块基础上：通过对协议栈中的数据包进行解析分类，完成对数据包的重标记，限速以及拥塞管理功能，有策略的实现对数据包的QoS处理。这里TC模块位于数据发送的第五层。</p>
<h1 id="3zte网关qos实现">3、ZTE网关Qos实现</h1>
<h2 id="31代码框架">3.1、代码框架</h2>
<p>参考《qos培训》，SDK中qos功能的代码框架如下图所示：
<img src="/image/qos/NELNJL2Zp4cqpHkR.png" alt="输入图片说明"></p>
<p>系统支持从web与tr069进程中配置qos信息，在PMAPI中间层发送消息给cspd进程，cspd中根据不同的消息id，调用相关服务函数。qos模块服务函数包括qos总控开关、数据包分类与标记、限流策略、拥塞管理。</p>
<h2 id="32数据包分类与标记">3.2、数据包分类与标记</h2>
<h3 id="321-相关数据结构">3.2.1 相关数据结构</h3>
<p>在SDK中使用 <strong>xx_qc</strong>定义该功能相关的数据结构与函数名，使用<strong>PM_OBJ_QOS_QC</strong>作为消息ID，使用<strong>DBVIEW_QOS_CLASSIFICATION</strong>作为数据库ID。在DB数据库中存放了匹配数据包的MAC、IP、端口等信息，以及为数据报文设置的标记值。
<img src="/image/qos/PpU7Bu8zgPj5uVq6.png" alt="输入图片说明"></p>
<h3 id="322-函数调用路线">3.2.2 函数调用路线</h3>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-21">21</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-22"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-22">22</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-23"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-23">23</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-24"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-24">24</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-25"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-25">25</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-26"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-26">26</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-27"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-27">27</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-28"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-28">28</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-0-29"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-0-29">29</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//配置分类规则
</span></span><span style="display:flex;"><span>web界面										//web界面配置分类规则
</span></span><span style="display:flex;"><span>  pm_qos_qc_set_config			//pmapi层解析web传过来的数据、发送消息到cspd进程
</span></span><span style="display:flex;"><span>	  pm_send_msg_2mm
</span></span><span style="display:flex;"><span>	    si_qc_set						//cspd中获取消息并找到消息id对应的处理函数
</span></span><span style="display:flex;"><span>		  si_qc_config					//配置分类规则到内核中
</span></span><span style="display:flex;"><span>		    si_qc_rule_set_conf
</span></span><span style="display:flex;"><span>			  ioctl								//走到sock文件的ioctl操作函数上 在什么位置建了socket？
</span></span><span style="display:flex;"><span>			    _ZXICKernel_QC_ioctl  //调度到qos模块注册的函数中 函数在qos.c中被注册
</span></span><span style="display:flex;"><span>			      ZXICKernel_QC_Add		//将调度规则存到g_QCList
</span></span><span style="display:flex;"><span>			        ZXICKernel_QC_AddByPrio
</span></span><span style="display:flex;"><span>			          g_QCList
</span></span><span style="display:flex;"><span>					  
</span></span><span style="display:flex;"><span>//匹配分类规则
</span></span><span style="display:flex;"><span>__dev_queue_xmit
</span></span><span style="display:flex;"><span>  call_pkt_out_notifier				//linux网络协议栈的第五层新增skb处理，以事件通知的方式
</span></span><span style="display:flex;"><span>    ZXICKernel_Skb_Classify		//回调qos模块注册的分类函数
</span></span><span style="display:flex;"><span>      ZXICKernel_QC_Cmp_Outdev		//循环匹配g_QCList中的规则
</span></span><span style="display:flex;"><span>        ZXICKernel_QC_MatchOutDWLink
</span></span><span style="display:flex;"><span>          skb-&gt;qos_priority = ptQC-&gt;ptQCForm-&gt;dwResult //配置成功，将规则的操作复制给qos_priority
</span></span><span style="display:flex;"><span>		  
</span></span><span style="display:flex;"><span>//添加skb结构的标记信息
</span></span><span style="display:flex;"><span>dev_hard_start_xmit
</span></span><span style="display:flex;"><span>  dev-&gt;netdev_ops-&gt;ndo_start_xmit		//驱动层注册的发送函数
</span></span><span style="display:flex;"><span>    wb_xmit
</span></span><span style="display:flex;"><span>      wb_xmit_frame
</span></span><span style="display:flex;"><span>        wb_multiwcd_tx
</span></span><span style="display:flex;"><span>        wb_default_tx
</span></span><span style="display:flex;"><span>          ZXICKernel_skb_DSCPRemark	  //解析skb并修改tos或者其他标记值
</span></span></code></pre></td></tr></table>
</div>
</div><p>qos_priority是中兴微在skb_buff结构上新增的一个字段，该结构用4字节来记录分类结构，分别包括：DSCP重标记，802.1P重标记，限速处理规则实例号，拥塞管理处理实例号。每个字段的含义如下所示：
<img src="/image/qos/pNUgLZZT9PA3tRmH.png" alt="输入图片说明"></p>
<h2 id="33限流策略">3.3、限流策略</h2>
<h3 id="331-相关数据结构">3.3.1 相关数据结构</h3>
<p>在SDK中使用 <strong>xx_qp</strong>定义该功能相关的数据结构与函数名，使用<strong>PM_OBJ_QOS_QP</strong>作为消息ID，使用<strong>DBVIEW_QOS_POLICER</strong>作为数据库ID。在DB数据库中存放了限速的速率信息，以及为数据报文设置的标记值。
<img src="/image/qos/cWLV8iaUeUXPpP4b.png" alt="输入图片说明"></p>
<h3 id="332-函数调用路线">3.3.2 函数调用路线</h3>
<div class="highlight"><div style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-1"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-1"> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-2"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-2"> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-3"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-3"> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-4"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-4"> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-5"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-5"> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-6"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-6"> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-7"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-7"> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-8"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-8"> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-9"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-9"> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-10"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-10">10</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-11"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-11">11</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-12"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-12">12</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-13"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-13">13</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-14"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-14">14</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-15"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-15">15</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-16"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-16">16</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-17"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-17">17</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-18"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-18">18</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-19"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-19">19</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-20"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-20">20</a>
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#64686c" id="hl-1-21"><a style="outline:none;text-decoration:none;color:inherit" href="#hl-1-21">21</a>
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>//配置限流规则
</span></span><span style="display:flex;"><span>web界面
</span></span><span style="display:flex;"><span>  pm_qos_qq_set_config
</span></span><span style="display:flex;"><span>    pm_send_msg_2mm
</span></span><span style="display:flex;"><span>      si_qp_set
</span></span><span style="display:flex;"><span>        si_qp_config
</span></span><span style="display:flex;"><span>          si_qp_rule_set_conf
</span></span><span style="display:flex;"><span>            ioctl			//从用户传递数据到内核中
</span></span><span style="display:flex;"><span>              _ZXICKernel_QC_ioctl
</span></span><span style="display:flex;"><span>                ZXICKernelQoSPolicerIoctl
</span></span><span style="display:flex;"><span>                  QoSPolicerAdd				//注册tMeter.pOps与tAction[i].pOps将限流规则存到g_ptPolicerList链表中
</span></span><span style="display:flex;"><span>                    g_ptPolicerList
</span></span><span style="display:flex;"><span>			
</span></span><span style="display:flex;"><span>//匹配限流规则
</span></span><span style="display:flex;"><span>__netif_receive_skb_core		//在第五层接收到数据包后触发事件通知
</span></span><span style="display:flex;"><span>  call_pkt_in_notifier
</span></span><span style="display:flex;"><span>    zxic_dev_bandwidth_event			//事件执行函数
</span></span><span style="display:flex;"><span>      ZXICKernel_Dev_Bandwidth		//调用qos模块注册的限流规则处理函数
</span></span><span style="display:flex;"><span>      ZXICKernel_Wan_Bandwidth
</span></span><span style="display:flex;"><span>        ZXICKernelQoSSkbPolice		//匹配限流规则，并调用处理动作(是否DROP)
</span></span><span style="display:flex;"><span>          QoSPolicerMeterSTBGrade
</span></span></code></pre></td></tr></table>
</div>
</div><p>QoSPolicerMeterSTBGrade函数使用令牌桶的思想限流。令牌桶最大的toke为用户限制的字节大小，通过统计每秒发送的数据量，将超出token部分的数据包丢弃，以此达到限流的目的。</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">dgwu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2021-06-12
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>



    
    


    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://Breeze-Wu.github.io/tags/zte/">zte</a>
            <a href="https://Breeze-Wu.github.io/tags/linux/">linux</a>
            <a href="https://Breeze-Wu.github.io/tags/qos/">qos</a>
            
        </div>


      
      <nav class="post-nav">
        
          <a class="prev" href="/post/807x%E4%B8%8A%E6%A8%A1%E7%BB%84%E9%80%82%E9%85%8D%E6%A2%B3%E7%90%86/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">807x上模组适配梳理</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
      </nav>
    </footer>
  </article>

  
  


  
  

  

  
  

  
  

  

  

    

  

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:your@email.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://localhost:1317" rel="me noopener" class="iconfont"
      title="twitch"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 36 36" version="1.1" width="36" height="36" id="svg8">
  <path
      style=""
      d="M 10,32.5 C 10,30.309524 9.5666667,30 6.5,30 H 3 V 18.196167 6.3923336 L 6.2976072,3.1961668 9.5952145,0 H 21.297607 33 v 9.2813035 9.2813035 l -5.778997,5.718696 C 23.230948,28.229724 20.653654,30 18.895317,30 17.471816,30 15.312792,31.102597 14,32.5 12.708255,33.875 11.279813,35 10.825686,35 10.371559,35 10,33.875 10,32.5 Z M 23.12736,22 c 1.432033,0 3.645397,-1.197147 5.185549,-2.804719 C 30.682196,16.722278 31,15.598708 31,9.6952811 V 3 H 20.5 10 v 9.5 9.5 h 3 c 2.413503,0 3,0.425076 3,2.174314 v 2.174314 l 2.314451,-2.174314 C 19.587399,22.978441 21.753208,22 23.12736,22 Z M 17.666667,14.333333 C 17.3,13.966667 17,12.166667 17,10.333333 17,8.037037 17.466667,7 18.5,7 c 1.083333,0 1.5,1.1111111 1.5,4 0,3.753437 -0.7878,4.878866 -2.333333,3.333333 z m 6.722867,-0.760607 C 23.554137,11.395717 24.34722,7.7069709 25.75,7.2449946 26.613128,6.9607414 27,8.097114 27,10.916667 c 0,3.979702 -1.51214,5.518252 -2.610466,2.656059 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://Breeze-Wu.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2023
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        dgwu
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.fe83e11b4fbc9193d67e2c9db78bad21f8dc59fca0cacd8c1c3bb071bb16a852.js" integrity="sha256-/oPhG0&#43;8kZPWfiydt4utIfjcWfygys2MHDuwcbsWqFI=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  

















</body>
</html>
